# Taskfile.yml

version: "3"

dotenv: [ "env/local.env" ]

tasks:
  ## Develop ---------------------------------------------------
  dev-init:
    desc: Init development environment
    cmds:
      - task: redis-start
        
  redis-start:
    desc: start redis 5.X version
    cmds:
      - docker-compose up -d redis

  redis-admin-start:
    desc: admin ui to manage redis
    cmds:
      - docker-compose up -d redis-admin
  
  ef-codegen:
    desc: Init development environment
    cmds:
      - task: ef-codegen-member
        
  ef-codegen-member:
    desc: EF Core 反向工程產生 MemberDbContext EF Entities
    dir: "src/be/Lab.Sharding.DB"
    cmds:
      - dotnet ef dbcontext scaffold "$SYS_DATABASE_CONNECTION_STRING" Microsoft.EntityFrameworkCore.SqlServer -o AutoGenerated/Entities -c MemberDbContext --context-dir AutoGenerated/ -n Lab.Sharding.DB -t Member --force --no-onconfiguring --use-database-names
      - dotnet ef dbcontext scaffold "$SYS_DATABASE_CONNECTION_STRING" Microsoft.EntityFrameworkCore.SqlServer -o AutoGenerated/Entities -c Member1DbContext --context-dir AutoGenerated/ -n Lab.Sharding.DB -t Member --force --no-onconfiguring --use-database-names
 
  codegen-api:
    desc: codegen client and server
    cmds:
      - task: codegen-api-client
      - task: codegen-api-server
  codegen-api-client:
    desc: codegen client
    cmds:
        - refitter ./doc/openapi.yml --namespace "Lab.Sharding.Contract" --output ./src/be/Lab.Sharding.Contract/AutoGenerated/JobClient.cs --use-api-response --no-operation-headers --no-auto-generated-header
  codegen-api-server:
    desc: codegen server
    cmds:
      - nswag openapi2cscontroller /input:./doc/openapi.yml /classname:{controller} /namespace:Lab.Sharding.WebAPI.Contract /output:./src/be/Lab.Sharding.WebAPI/Contract/AutoGenerated/ContractControllers.cs /jsonLibrary:SystemTextJson /useCancellationToken:true /useActionResultType:true /operationGenerationMode:MultipleClientsFromFirstTagAndOperationId /controllerBaseClass:Microsoft.AspNetCore.Mvc.ControllerBase /excludedParameterNames:x-idempotency-key,x-api-key
        
  codegen-api-doc:
    desc: codegen api doc
      安裝 Redocly CLI
      npm install -g @redocly/openapi-cli
    dir: "./doc"
    cmds:
      - redocly build-docs ./openapi.yml --output ./openapi.html
#      - redocly build-docs ./doc/openapi.yml --output ./doc/openapi.html
#      - redocly preview-docs ./doc/openapi.yml
      #- redocly bundle ./doc/openapi.yml --output ./doc/openapi-bundled.yml
      #- redocly preview-docs ./doc/openapi-bundled.yml
  codegen-api-preview:
    desc: codegen api doc
    dir: "./doc"
    cmds:
      - redocly preview-docs ./openapi.yml
