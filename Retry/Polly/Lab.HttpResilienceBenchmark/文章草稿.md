# ç”¨ Microsoft.Extensions.Http.Resilience å¯¦ä½œ Retryï¼šæ•ˆèƒ½èˆ‡ Polly çš„æ¯”è¼ƒ

ç¥•è¨£ç„¡å®ƒï¼Œå”¯å‹¤è€Œå·²ï¼›å”¯æœ‰ä¸æ–·å­¸ç¿’ï¼Œæ‰èƒ½æˆé•·ã€‚  
é€™ç¯‡æ–‡ç« è¦åˆ†äº«æˆ‘æœ€è¿‘åœ¨ç ”ç©¶ **Microsoft.Extensions.Http.Resilience** èˆ‡ **Microsoft.Extensions.Http.Polly** çš„å¿ƒå¾—ï¼Œç‰¹åˆ¥æ˜¯ **Retry ç­–ç•¥** çš„ä½¿ç”¨æ–¹å¼èˆ‡æ•ˆèƒ½æ¯”è¼ƒã€‚

åœ¨ .NET 9 ä¹‹å¾Œï¼Œå¾®è»Ÿå®˜æ–¹æ¨å‡ºäº†æ–°çš„ **Resilience Handler**ï¼Œå®ƒå…§å»ºåœ¨ `Microsoft.Extensions.Http.Resilience` å¥—ä»¶ä¸­ï¼Œä¸å†éœ€è¦é¡å¤–å®‰è£ Polly å¥—ä»¶å°±èƒ½ä½¿ç”¨ Retryã€Circuit Breakerã€Timeout ç­‰å½ˆæ€§ç­–ç•¥ã€‚é€™å°é–‹ç™¼è€…ä¾†èªªæ˜¯ä¸€å€‹é‡è¦çš„è½‰æŠ˜é»ã€‚

---

## é–‹ç™¼ç’°å¢ƒ
- Windows 11 Pro / Ubuntu 24.04 (WSL2)
- .NET 9.0.4
- BenchmarkDotNet v0.15.4
- æ¸¬è©¦ API: `http://localhost:5068/api/members`

---

## Microsoft.Extensions.Http.Resilience ä½¿ç”¨æ–¹å¼

Resilience å¥—ä»¶æä¾›äº† **æ¨™æº–åŒ–çš„å½ˆæ€§è™•ç†å™¨**ï¼Œåªè¦ä¸€è¡Œ `.AddStandardResilienceHandler()` å°±èƒ½å¥—ç”¨å®˜æ–¹å»ºè­°çš„ Retryã€Timeoutã€Circuit Breaker ç­–ç•¥ã€‚

```csharp
services.AddHttpClient("resilience", client =>
{
    client.BaseAddress = new Uri("http://localhost:5068");
})
.AddStandardResilienceHandler();
```

å¦‚æœè¦è‡ªè¨‚ Retry ç­–ç•¥ï¼Œå¯ä»¥ç”¨ `AddResilienceHandler`ï¼š

```csharp
services.AddHttpClient("resilience-retry", client =>
{
    client.BaseAddress = new Uri("http://localhost:5068");
})
.AddResilienceHandler("retry", builder =>
{
    builder.AddRetry(new RetryStrategyOptions<HttpResponseMessage>
    {
        MaxRetryAttempts = 3,
        BackoffType = DelayBackoffType.Exponential,
        Delay = TimeSpan.FromSeconds(1),
        ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
            .HandleResult(r => !r.IsSuccessStatusCode)
            .Handle<HttpRequestException>()
    });
});
```

é€™è£¡çš„ API è¨­è¨ˆå’Œ **Polly V8** å¹¾ä¹ä¸€æ¨£ï¼Œå› ç‚º Resilience Handler æœ¬èº«å°±æ˜¯åŸºæ–¼ Polly V8 çš„ Resilience Pipelineã€‚

---

## Microsoft.Extensions.Http.Polly ä½¿ç”¨æ–¹å¼

åœ¨ Resilience Handler å‡ºç¾ä¹‹å‰ï¼Œæˆ‘å€‘éƒ½æ˜¯é€é **Microsoft.Extensions.Http.Polly** ä¾†æ•´åˆ Polly ç­–ç•¥ã€‚  
ä»¥ä¸‹æ˜¯æœ€å¸¸è¦‹çš„ Retry å¯«æ³•ï¼š

```csharp
services.AddHttpClient("polly", client =>
{
    client.BaseAddress = new Uri("http://localhost:5068");
})
.AddPolicyHandler(HttpPolicyExtensions
    .HandleTransientHttpError()
    .WaitAndRetryAsync(
        retryCount: 3,
        sleepDurationProvider: retryAttempt =>
            TimeSpan.FromSeconds(Math.Pow(2, retryAttempt))));
```

é€™ç¨®å¯«æ³•ä¾è³´ **Polly V7** çš„ APIï¼Œå±¬æ–¼èˆŠå¼çš„ Policy Chainã€‚  
å¦‚æœå‡ç´šåˆ° **Polly V8**ï¼Œå‰‡å¯ä»¥æ”¹ç”¨ Resilience Pipeline çš„æ–¹å¼ï¼Œèªæ³•å°±æœƒå’Œ `Microsoft.Extensions.Http.Resilience` å¹¾ä¹ä¸€è‡´ã€‚

---

## æ•ˆèƒ½æ¯”è¼ƒï¼šPolly vs Resilience

æˆ‘ç”¨ BenchmarkDotNet åšäº†å£“æ¸¬ï¼Œçµæœå¦‚ä¸‹ï¼ˆè©³ç´°æ•¸æ“šä¾†è‡ª [FIXED_BENCHMARK_RESULTS.md] èˆ‡ [POLLY_V8_ä»‹ç´¹.md]ï¼‰ï¼š

| æ–¹æ³• | å¹³å‡æ™‚é–“ | æ¨™æº–å·® | è¨˜æ†¶é«”åˆ†é… |
|------|---------|--------|-----------|
| **StandardHttpClient** | 158.0 Î¼s | 6.68 Î¼s | 3.31 KB |
| **Polly V8** | 171.9 Î¼s | 8.32 Î¼s | 4.95 KB |
| **Resilience** | 174.7 Î¼s | 8.46 Î¼s | 6.48 KB |
| **Polly V7** | 204.3 Î¼s | 33.64 Î¼s | 4.46 KB |

### é—œéµè§€å¯Ÿ
1. **Polly V8** æ¯” **Polly V7** å¿«äº† **15.9%**ï¼Œè€Œä¸”ç©©å®šæ€§å¤§å¹…æå‡ï¼ˆæ¨™æº–å·®é™ä½ 75%ï¼‰ã€‚
2. **Resilience Handler** çš„æ•ˆèƒ½å’Œ Polly V8 å¹¾ä¹ä¸€æ¨£ï¼Œå·®ç•°åƒ… **2.8%**ï¼Œä½†è¨˜æ†¶é«”ä½¿ç”¨ç¨é«˜ã€‚
3. **Polly V7** ä¸åƒ…æ…¢ï¼Œè®Šç•°æ€§ä¹Ÿå¤§ï¼Œå·²ç¶“ä¸å»ºè­°ä½¿ç”¨ã€‚

---

## æ¶æ§‹å·®ç•°

### Polly V7
```csharp
var retryPolicy = Policy
    .HandleResult<HttpResponseMessage>(r => !r.IsSuccessStatusCode)
    .WaitAndRetryAsync(3, retryAttempt =>
        TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)));

var circuitBreakerPolicy = Policy
    .HandleResult<HttpResponseMessage>(r => !r.IsSuccessStatusCode)
    .CircuitBreakerAsync(3, TimeSpan.FromSeconds(30));

var policyWrap = Policy.WrapAsync(retryPolicy, circuitBreakerPolicy);
```

### Polly V8 / Resilience
```csharp
services.AddHttpClient("api")
.AddResilienceHandler("standard", builder =>
{
    builder
        .AddRetry(new RetryStrategyOptions<HttpResponseMessage>())
        .AddCircuitBreaker(new CircuitBreakerStrategyOptions<HttpResponseMessage>())
        .AddTimeout(TimeSpan.FromSeconds(10));
});
```

å¯ä»¥çœ‹åˆ°ï¼Œ**Resilience Handler** å’Œ **Polly V8** å¹¾ä¹æ˜¯åŒä¸€å¥— APIï¼Œå·®åˆ¥åªåœ¨æ–¼å¥—ä»¶ä¾†æºã€‚

---

## å¿ƒå¾—

- å¦‚æœä½ æ˜¯ **æ–°å°ˆæ¡ˆ**ï¼Œå»ºè­°ç›´æ¥ç”¨ **Microsoft.Extensions.Http.Resilience**ï¼Œå› ç‚ºå®ƒæ˜¯å®˜æ–¹æ¨è–¦ã€é•·æœŸç¶­è­·çš„æ–¹æ¡ˆã€‚
- å¦‚æœä½ å·²ç¶“åœ¨ç”¨ **Polly V8**ï¼Œå…¶å¯¦å’Œ Resilience å¹¾ä¹ä¸€æ¨£ï¼Œå·®åˆ¥åªåœ¨æ–¼æ•´åˆåº¦ã€‚
- å¦‚æœé‚„åœ¨ç”¨ **Polly V7**ï¼Œå¼·çƒˆå»ºè­°è¦åŠƒé·ç§»ï¼Œå› ç‚ºæ•ˆèƒ½èˆ‡ç©©å®šæ€§éƒ½è½å¾Œå¤ªå¤šã€‚

---

## ç¯„ä¾‹ç¨‹å¼ç¢¼ä½ç½®
- [Polly V8 ç¯„ä¾‹](https://github.com/App-vNext/Polly)
- [Resilience å®˜æ–¹æ–‡ä»¶](https://learn.microsoft.com/zh-tw/dotnet/core/resilience/http-resilience?tabs=dotnet-cli)

---

## çµè«–

- **Polly V8**ï¼šæ•ˆèƒ½æœ€ä½³ï¼ŒAPI ç¾ä»£åŒ–ã€‚
- **Resilience Handler**ï¼šæ•ˆèƒ½æ¥è¿‘ Polly V8ï¼Œæ•´åˆåº¦æ›´é«˜ï¼Œå®˜æ–¹æ¨è–¦ã€‚
- **Polly V7**ï¼šæ•ˆèƒ½å·®ã€è®Šç•°æ€§å¤§ï¼Œæ‡‰è©²æ·˜æ±°ã€‚

ğŸ‘‰ æˆ‘çš„å»ºè­°ï¼š**æ–°å°ˆæ¡ˆç›´æ¥ç”¨ Resilience Handlerï¼ŒèˆŠå°ˆæ¡ˆç›¡å¿«å‡ç´šåˆ° Polly V8 æˆ– Resilienceã€‚**

---

è¦ä¸è¦æˆ‘å¹«ä½ ç•«ä¸€å¼µ **Retry ç­–ç•¥çš„ç‹€æ…‹åœ–**ï¼Œåƒä½™å°ç« æ–‡ç« è£¡å¸¸ç”¨çš„é‚£ç¨®æµç¨‹åœ–ï¼Œè®“æ•´å€‹ Retry è¡Œç‚ºæ›´ç›´è§€ï¼Ÿ