<!DOCTYPE html>
<html lang='zh-TW'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>已標記略過檔案報表</title>
    <style>
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
        .summary { background-color: #e8f5e9; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .summary-item { display: inline-block; margin-right: 30px; font-weight: bold; }
        .group { border: 1px solid #ddd; margin-bottom: 20px; border-radius: 5px; overflow: hidden; }
        .group-header { background-color: #2196F3; color: white; padding: 10px 15px; cursor: pointer; }
        .group-header:hover { background-color: #1976D2; }
        .group-content { padding: 15px; display: none; }
        .group-content.active { display: block; }
        .file-item { background-color: #f9f9f9; padding: 10px; margin-bottom: 10px; border-left: 4px solid #4CAF50; }
        .file-item.missing { border-left-color: #f44336; background-color: #ffebee; }
        .file-path { font-family: 'Consolas', monospace; color: #333; word-break: break-all; }
        .file-info { color: #666; font-size: 0.9em; margin-top: 5px; }
        .hash { font-family: 'Consolas', monospace; color: #666; font-size: 0.9em; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; margin-left: 10px; }
        .badge-exists { background-color: #4CAF50; color: white; }
        .badge-missing { background-color: #f44336; color: white; }
        .toggle-all { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 15px; }
        .toggle-all:hover { background-color: #45a049; }
    </style>
    <script>
        var reportData = {{REPORT_DATA}};

        function formatFileSize(bytes) {
            var sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 B';
            var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function renderReport() {
            // 渲染摘要
            var totalFiles = reportData.Groups.reduce(function(sum, g) { return sum + g.FileCount; }, 0);
            var totalExisting = reportData.Groups.reduce(function(sum, g) {
                return sum + g.Files.filter(function(f) { return f.Exists; }).length;
            }, 0);
            var totalMissing = totalFiles - totalExisting;

            var summaryHtml = '<div class="summary-item">產生時間：' + escapeHtml(reportData.GeneratedAt) + '</div>' +
                '<div class="summary-item">總群組數：' + reportData.TotalGroups + '</div>' +
                '<div class="summary-item">總檔案數：' + totalFiles + '</div>' +
                '<div class="summary-item">存在：' + totalExisting + '</div>' +
                '<div class="summary-item">遺失：' + totalMissing + '</div>';

            document.getElementById('summary').innerHTML = summaryHtml;

            // 渲染群組
            var groupsHtml = '';
            reportData.Groups.forEach(function(group, index) {
                var groupId = index + 1;
                var existingCount = group.Files.filter(function(f) { return f.Exists; }).length;
                var missingCount = group.FileCount - existingCount;

                groupsHtml += '<div class="group">';
                groupsHtml += '  <div class="group-header" onclick="toggleGroup(' + groupId + ')">';
                groupsHtml += '    <strong>群組 ' + groupId + '</strong>';
                groupsHtml += '    <span class="badge badge-exists">存在：' + existingCount + '</span>';
                if (missingCount > 0) {
                    groupsHtml += '    <span class="badge badge-missing">遺失：' + missingCount + '</span>';
                }
                groupsHtml += '    <div class="hash">Hash: ' + escapeHtml(group.Hash) + '</div>';
                groupsHtml += '    <div style="font-size: 0.9em; margin-top: 5px;">略過時間：' + escapeHtml(group.SkippedAt) + '</div>';
                groupsHtml += '  </div>';
                groupsHtml += '  <div id="content-' + groupId + '" class="group-content">';

                group.Files.forEach(function(file) {
                    var cssClass = file.Exists ? 'file-item' : 'file-item missing';
                    var statusBadge = file.Exists ? '<span class="badge badge-exists">存在</span>' : '<span class="badge badge-missing">遺失</span>';

                    groupsHtml += '    <div class="' + cssClass + '">';
                    groupsHtml += '      ' + statusBadge;
                    groupsHtml += '      <div class="file-path">' + escapeHtml(file.Path) + '</div>';

                    if (file.Exists) {
                        groupsHtml += '      <div class="file-info">';
                        groupsHtml += '        大小：' + formatFileSize(file.Size) + ' | ';
                        groupsHtml += '        建立：' + escapeHtml(file.CreatedTime) + ' | ';
                        groupsHtml += '        修改：' + escapeHtml(file.ModifiedTime);
                        groupsHtml += '      </div>';
                    }

                    groupsHtml += '    </div>';
                });

                groupsHtml += '  </div>';
                groupsHtml += '</div>';
            });

            document.getElementById('groups').innerHTML = groupsHtml;
        }

        function toggleGroup(id) {
            var content = document.getElementById('content-' + id);
            content.classList.toggle('active');
        }

        function toggleAll() {
            var contents = document.querySelectorAll('.group-content');
            var anyHidden = Array.from(contents).some(function(c) { return !c.classList.contains('active'); });
            contents.forEach(function(content) {
                if (anyHidden) { content.classList.add('active'); }
                else { content.classList.remove('active'); }
            });
        }

        window.addEventListener('DOMContentLoaded', renderReport);
    </script>
</head>
<body>
    <div class='container'>
        <h1>已標記略過檔案報表</h1>
        <div id='summary' class='summary'></div>
        <button class='toggle-all' onclick='toggleAll()'>展開/收合全部</button>
        <div id='groups'></div>
    </div>
</body>
</html>
