<!DOCTYPE html>
<html lang='zh-TW'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>已標記略過檔案報表</title>
    <style>
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
        .summary { background-color: #e8f5e9; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .summary-item { display: inline-block; margin-right: 30px; font-weight: bold; }
        .group { border: 1px solid #ddd; margin-bottom: 20px; border-radius: 5px; overflow: hidden; }
        .group-header { background-color: #2196F3; color: white; padding: 10px 15px; cursor: pointer; }
        .group-header:hover { background-color: #1976D2; }
        .group-content { padding: 15px; display: none; }
        .group-content.active { display: block; }
        .file-item { background-color: #f9f9f9; padding: 10px; margin-bottom: 10px; border-left: 4px solid #4CAF50; }
        .file-item.missing { border-left-color: #f44336; background-color: #ffebee; }
        .file-path { font-family: 'Consolas', monospace; color: #333; word-break: break-all; }
        .file-info { color: #666; font-size: 0.9em; margin-top: 5px; }
        .hash { font-family: 'Consolas', monospace; color: #666; font-size: 0.9em; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; margin-left: 10px; }
        .badge-exists { background-color: #4CAF50; color: white; }
        .badge-missing { background-color: #f44336; color: white; }
        .toggle-all { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 15px; }
        .toggle-all:hover { background-color: #45a049; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- 資料 JSON -->
    <script type="application/json" id="reportData">{{REPORT_DATA}}</script>

    <!-- 群組模板 -->
    <template id="group-template">
        <div class="group">
            <div class="group-header">
                <strong class="group-title"></strong>
                <span class="badge badge-exists exists-badge"></span>
                <span class="badge badge-missing missing-badge hidden"></span>
                <div class="hash"></div>
                <div class="skipped-time" style="font-size: 0.9em; margin-top: 5px;"></div>
            </div>
            <div class="group-content"></div>
        </div>
    </template>

    <!-- 檔案模板 -->
    <template id="file-template">
        <div class="file-item">
            <span class="badge file-status-badge"></span>
            <div class="file-path"></div>
            <div class="file-info"></div>
        </div>
    </template>

    <div class='container'>
        <h1>已標記略過檔案報表</h1>

        <div class='summary'>
            <div class="summary-item">產生時間：<span id="generated-time"></span></div>
            <div class="summary-item">總群組數：<span id="total-groups"></span></div>
            <div class="summary-item">總檔案數：<span id="total-files"></span></div>
            <div class="summary-item">存在：<span id="existing-files"></span></div>
            <div class="summary-item">遺失：<span id="missing-files"></span></div>
        </div>

        <button class='toggle-all' onclick='toggleAll()'>展開/收合全部</button>
        <div id='groups'></div>
    </div>

    <script>
        function formatFileSize(bytes) {
            var sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 B';
            var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
        }

        function toggleGroup(id) {
            var content = document.getElementById('content-' + id);
            content.classList.toggle('active');
        }

        function toggleAll() {
            var contents = document.querySelectorAll('.group-content');
            var anyHidden = Array.from(contents).some(function(c) { return !c.classList.contains('active'); });
            contents.forEach(function(content) {
                if (anyHidden) { content.classList.add('active'); }
                else { content.classList.remove('active'); }
            });
        }

        function renderReport(reportData) {
            // 渲染摘要
            var totalFiles = reportData.Groups.reduce(function(sum, g) { return sum + g.FileCount; }, 0);
            var totalExisting = reportData.Groups.reduce(function(sum, g) {
                return sum + g.Files.filter(function(f) { return f.Exists; }).length;
            }, 0);
            var totalMissing = totalFiles - totalExisting;

            document.getElementById('generated-time').textContent = reportData.GeneratedAt;
            document.getElementById('total-groups').textContent = reportData.TotalGroups;
            document.getElementById('total-files').textContent = totalFiles;
            document.getElementById('existing-files').textContent = totalExisting;
            document.getElementById('missing-files').textContent = totalMissing;

            // 取得模板
            var groupTemplate = document.getElementById('group-template');
            var fileTemplate = document.getElementById('file-template');
            var groupsContainer = document.getElementById('groups');

            // 渲染群組
            reportData.Groups.forEach(function(group, index) {
                var groupId = index + 1;
                var existingCount = group.Files.filter(function(f) { return f.Exists; }).length;
                var missingCount = group.FileCount - existingCount;

                // 複製群組模板
                var groupElement = groupTemplate.content.cloneNode(true);
                var groupDiv = groupElement.querySelector('.group');
                var groupHeader = groupElement.querySelector('.group-header');
                var groupContent = groupElement.querySelector('.group-content');

                // 設定群組 ID 和點擊事件
                groupContent.id = 'content-' + groupId;
                groupHeader.onclick = function() { toggleGroup(groupId); };

                // 填入群組資料
                groupElement.querySelector('.group-title').textContent = '群組 ' + groupId;
                groupElement.querySelector('.exists-badge').textContent = '存在：' + existingCount;

                var missingBadge = groupElement.querySelector('.missing-badge');
                if (missingCount > 0) {
                    missingBadge.textContent = '遺失：' + missingCount;
                    missingBadge.classList.remove('hidden');
                }

                groupElement.querySelector('.hash').textContent = 'Hash: ' + group.Hash;
                groupElement.querySelector('.skipped-time').textContent = '略過時間：' + group.SkippedAt;

                // 渲染檔案
                group.Files.forEach(function(file) {
                    var fileElement = fileTemplate.content.cloneNode(true);
                    var fileItem = fileElement.querySelector('.file-item');

                    // 設定檔案樣式
                    if (!file.Exists) {
                        fileItem.classList.add('missing');
                    }

                    // 設定狀態徽章
                    var statusBadge = fileElement.querySelector('.file-status-badge');
                    if (file.Exists) {
                        statusBadge.className = 'badge badge-exists';
                        statusBadge.textContent = '存在';
                    } else {
                        statusBadge.className = 'badge badge-missing';
                        statusBadge.textContent = '遺失';
                    }

                    // 設定檔案路徑
                    fileElement.querySelector('.file-path').textContent = file.Path;

                    // 設定檔案資訊
                    var fileInfo = fileElement.querySelector('.file-info');
                    if (file.Exists) {
                        fileInfo.textContent = '大小：' + formatFileSize(file.Size) +
                            ' | 建立：' + file.CreatedTime +
                            ' | 修改：' + file.ModifiedTime;
                    } else {
                        fileInfo.textContent = '';
                    }

                    groupContent.appendChild(fileElement);
                });

                groupsContainer.appendChild(groupElement);
            });
        }

        window.addEventListener('DOMContentLoaded', function() {
            var reportData = JSON.parse(document.getElementById('reportData').textContent);
            renderReport(reportData);
        });
    </script>
</body>
</html>
