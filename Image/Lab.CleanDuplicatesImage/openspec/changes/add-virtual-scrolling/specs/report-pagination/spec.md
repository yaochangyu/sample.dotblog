# Spec: 報表虛擬滾動功能

## ADDED Requirements

### Requirement: 實作虛擬滾動引擎類別

系統 MUST 提供一個 `VirtualScroller` JavaScript 類別，用於管理虛擬滾動的核心邏輯。

#### Scenario: 初始化虛擬滾動器

**Given** 使用者開啟 HTML 報表
**And** 報表包含重複檔案群組資料（例如 1,000 個群組）
**When** 頁面載入完成
**Then** 虛擬滾動器應初始化並僅渲染前 20 筆資料
**And** 佔位元素應正確設定高度，維持滾動條總高度
**And** 頁面應在 1 秒內完成載入

#### Scenario: 滾動時動態更新可見項目

**Given** 虛擬滾動器已初始化並顯示第 1-20 筆資料
**When** 使用者向下滾動至第 50 筆資料的位置
**Then** 系統應計算新的可見範圍（第 45-70 筆，包含緩衝區）
**And** 清空原有的 DOM 元素
**And** 渲染新的可見範圍資料
**And** 更新上方佔位元素高度為 `45 * 120px = 5400px`
**And** 更新下方佔位元素高度為 `(總數 - 70) * 120px`

#### Scenario: 快速滾動時使用緩衝區防止空白

**Given** 使用者快速向下滾動
**When** 滾動速度超過 100ms 內移動 5 個項目
**Then** 系統應渲染當前可見範圍 + 上下各 5 筆緩衝區
**And** 緩衝區項目應在滾動進入可見範圍前已渲染完成
**And** 使用者應不會看到空白區域

#### Scenario: 節流處理滾動事件

**Given** 使用者持續滾動頁面
**When** 滾動事件在 100ms 內觸發多次
**Then** 系統應僅在第一次觸發時執行更新邏輯
**And** 後續觸發應被忽略，直到 100ms 計時器結束
**And** 避免過度頻繁的 DOM 更新

---

### Requirement: 整合虛擬滾動到所有標籤頁

系統 MUST 將虛擬滾動功能應用到所有 6 個報表標籤頁。

#### Scenario: 重複檔案群組總覽（按大小排序）使用虛擬滾動

**Given** 報表包含 2,000 個重複檔案群組
**When** 使用者切換到「重複檔案群組總覽（按大小排序）」標籤頁
**Then** 系統應使用 `VirtualScroller` 渲染 `DuplicateGroups` 資料
**And** 僅渲染前 20 個群組
**And** 支援滾動查看所有 2,000 個群組

#### Scenario: 重複檔案群組總覽（按重複次數排序）使用虛擬滾動

**Given** 報表包含 2,000 個重複檔案群組
**When** 使用者切換到「重複檔案群組總覽（按重複次數排序）」標籤頁
**Then** 系統應使用 `VirtualScroller` 渲染 `DuplicateGroupsByCount` 資料
**And** 僅渲染前 20 個群組
**And** 支援滾動查看所有 2,000 個群組

#### Scenario: 未標記檔案列表使用虛擬滾動

**Given** 報表包含 5,000 個未標記檔案
**When** 使用者切換到「未標記檔案」標籤頁
**Then** 系統應使用 `VirtualScroller` 渲染 `UnmarkedFiles` 資料
**And** 僅渲染前 20 個檔案
**And** 支援滾動查看所有 5,000 個檔案

#### Scenario: 已標記刪除檔案列表使用虛擬滾動

**Given** 報表包含 3,000 個已標記刪除檔案
**When** 使用者切換到「已標記刪除檔案」標籤頁
**Then** 系統應使用 `VirtualScroller` 渲染 `MarkedForDeletion` 資料
**And** 僅渲染前 20 個檔案
**And** 支援滾動查看所有 3,000 個檔案

#### Scenario: 已標記移動檔案列表使用虛擬滾動

**Given** 報表包含 1,500 個已標記移動檔案
**When** 使用者切換到「已標記移動檔案」標籤頁
**Then** 系統應使用 `VirtualScroller` 渲染 `MarkedForMove` 資料
**And** 僅渲染前 20 個檔案
**And** 支援滾動查看所有 1,500 個檔案

#### Scenario: 已標記略過檔案列表使用虛擬滾動

**Given** 報表包含 800 個已標記略過檔案
**When** 使用者切換到「已標記略過檔案」標籤頁
**Then** 系統應使用 `VirtualScroller` 渲染 `SkippedFiles` 資料
**And** 僅渲染前 20 個檔案
**And** 支援滾動查看所有 800 個檔案

---

### Requirement: 維持現有的互動功能

虛擬滾動功能 MUST 與現有的互動功能相容。

#### Scenario: 展開/收合重複檔案群組的檔案列表

**Given** 虛擬滾動器正在渲染重複檔案群組
**And** 某個群組包含 10 個重複檔案
**When** 使用者點擊「▶ 展開檔案列表 (10)」按鈕
**Then** 系統應展開該群組的檔案列表
**And** 按鈕文字應更新為「▼ 收合檔案列表 (10)」
**And** 檔案列表應顯示所有 10 個檔案的詳細資訊
**And** 展開/收合功能應與虛擬滾動無縫整合

#### Scenario: 標籤頁切換時重置滾動位置

**Given** 使用者在「未標記檔案」標籤頁已滾動至第 100 筆資料
**When** 使用者切換到「已標記刪除檔案」標籤頁
**Then** 新標籤頁的滾動位置應重置為頂部
**And** 渲染前 20 筆資料
**And** 避免顯示上一個標籤頁的滾動位置

---

### Requirement: 固定每頁顯示筆數

系統 MUST 固定每次渲染 20 筆資料，不提供使用者自訂選項。

#### Scenario: 預設每頁顯示 20 筆資料

**Given** 虛擬滾動器初始化
**When** 頁面載入完成
**Then** 系統應渲染前 20 筆資料
**And** `visibleCount` 參數應固定為 20
**And** 不提供使用者自訂每頁筆數的 UI 控制項

#### Scenario: 緩衝區額外渲染 10 筆資料

**Given** 虛擬滾動器正在渲染第 50-70 筆資料（可見範圍）
**When** 系統計算實際渲染範圍
**Then** 應包含上方 5 筆緩衝區（第 45-49 筆）
**And** 應包含下方 5 筆緩衝區（第 71-75 筆）
**And** 總共渲染 30 筆資料（20 筆可見 + 10 筆緩衝）

---

### Requirement: 效能指標

虛擬滾動功能 MUST 滿足以下效能指標。

#### Scenario: 初次載入時間少於 1 秒

**Given** 報表包含 10,000 個重複檔案群組
**When** 使用者開啟 HTML 報表
**Then** 頁面應在 1 秒內完成初次渲染
**And** 使用者應能立即看到前 20 筆資料
**And** 滾動條應正確顯示總高度

#### Scenario: 滾動更新延遲少於 100ms

**Given** 虛擬滾動器已初始化
**When** 使用者滾動到新的位置
**Then** 系統應在 100ms 內完成 DOM 更新
**And** 新的可見項目應立即顯示
**And** 滾動體驗應保持流暢

#### Scenario: DOM 元素數量限制

**Given** 報表包含 100,000 個檔案
**When** 使用者滾動到任意位置
**Then** DOM 中的檔案項目元素應不超過 30 個
**And** 記憶體使用應維持在合理範圍內
**And** 瀏覽器應保持響應狀態

---

### Requirement: 視覺一致性

虛擬滾動功能 MUST NOT 改變現有的視覺樣式。

#### Scenario: 維持現有的 CSS 樣式

**Given** 虛擬滾動器渲染檔案項目
**When** 檔案項目顯示在螢幕上
**Then** 應使用現有的 `.file-item` CSS 類別
**And** 應保持現有的邊框顏色、間距、陰影效果
**And** 應保持現有的徽章樣式（存在/遺失、已處理/待處理）
**And** 視覺效果應與原有設計完全一致

#### Scenario: 維持現有的容器高度

**Given** 原有報表設計中 `.file-list` 的最大高度為 600px
**When** 虛擬滾動器初始化
**Then** 虛擬滾動容器的最大高度應設定為 600px
**And** 超過 600px 的內容應顯示垂直滾動條
**And** 滾動條樣式應與瀏覽器預設一致

---

### Requirement: 瀏覽器相容性

虛擬滾動功能 MUST 支援所有現代瀏覽器。

#### Scenario: 在 Chrome 瀏覽器中正常運作

**Given** 使用者使用 Chrome 90 或更高版本
**When** 開啟 HTML 報表
**Then** 虛擬滾動功能應正常運作
**And** 不應出現 JavaScript 錯誤

#### Scenario: 在 Firefox 瀏覽器中正常運作

**Given** 使用者使用 Firefox 88 或更高版本
**When** 開啟 HTML 報表
**Then** 虛擬滾動功能應正常運作
**And** 不應出現 JavaScript 錯誤

#### Scenario: 在 Edge 瀏覽器中正常運作

**Given** 使用者使用 Edge 90 或更高版本
**When** 開啟 HTML 報表
**Then** 虛擬滾動功能應正常運作
**And** 不應出現 JavaScript 錯誤

## MODIFIED Requirements

無。此變更為新增功能，不修改現有需求。

## REMOVED Requirements

無。此變更不移除任何現有功能。
