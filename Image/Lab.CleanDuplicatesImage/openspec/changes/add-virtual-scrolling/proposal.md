# Proposal: 為報表加入虛擬滾動功能

## Metadata
- **Change ID**: `add-virtual-scrolling`
- **Status**: Proposed
- **Author**: Claude Code
- **Created**: 2025-10-25
- **Type**: Enhancement

## Problem Statement

目前的 HTML 報表（`ComprehensiveFileStatusReport.html`）當資料量龐大時（例如數千個重複檔案群組或標記檔案），會一次性將所有資料渲染到 DOM 中，導致：

1. **效能問題**：大量 DOM 元素造成頁面載入緩慢、滾動卡頓
2. **記憶體消耗**：瀏覽器需要維護所有 DOM 元素的狀態
3. **使用者體驗不佳**：初次載入時間過長，影響互動流暢度

具體影響的標籤頁包括：
- 重複檔案群組總覽（按大小排序）
- 重複檔案群組總覽（按重複次數排序）
- 未標記檔案 (MarkType = 0)
- 已標記刪除檔案 (MarkType = 1)
- 已標記移動檔案 (MarkType = 2)
- 已標記略過檔案 (MarkType = 3)

## Proposed Solution

實作**虛擬滾動（Virtual Scrolling）**機制，僅渲染可見區域的資料項目，滾動時動態更新 DOM。

### 核心特性
- **視窗化渲染**：僅渲染可見區域 + 緩衝區的資料項目（預設 20 筆）
- **動態更新**：監聽滾動事件，根據滾動位置更新可見項目
- **適用範圍**：套用到所有 6 個標籤頁的檔案列表
- **固定每頁筆數**：預設顯示 20 筆，不提供使用者自訂選項
- **無縫滾動體驗**：使用空白佔位元素維持滾動條高度

### 技術實作方式
- 純 JavaScript 實作（無需引入外部函式庫）
- 計算每個項目的預估高度（基於現有樣式）
- 監聽容器的 `scroll` 事件
- 動態計算可見範圍並更新 DOM

## Impact Assessment

### 效能提升
- **初次載入時間**：減少 90% 以上（僅渲染 20 筆 vs 數千筆）
- **記憶體使用**：大幅降低 DOM 元素數量
- **滾動流暢度**：即使資料量達到數萬筆也能保持 60 FPS

### 使用者體驗
- **立即回應**：報表開啟後立即可見前 20 筆資料
- **無感知延遲**：滾動時資料更新迅速
- **視覺一致性**：維持現有的 UI/UX 設計

### 程式碼變更範圍
- **修改檔案**：`Templates/ComprehensiveFileStatusReport.html`
- **新增功能**：虛擬滾動 JavaScript 模組
- **不影響**：後端 C# 程式碼、資料庫結構、JSON 報表格式

## Success Criteria

1. ✅ 所有 6 個標籤頁均實作虛擬滾動
2. ✅ 預設每次渲染 20 筆資料
3. ✅ 滾動時動態載入可見區域的資料
4. ✅ 維持現有的視覺樣式與互動功能（展開/收合檔案列表等）
5. ✅ 瀏覽器相容性：支援現代瀏覽器（Chrome、Firefox、Edge）
6. ✅ 效能驗證：處理 10,000+ 筆資料時，初次載入 < 1 秒

## Alternatives Considered

### 選項 A：傳統分頁（Pagination）
- **優點**：實作簡單、易於理解
- **缺點**：需要頁碼切換，破壞連續瀏覽體驗
- **結論**：不符合使用者需求

### 選項 B：引入外部函式庫（如 react-window、virtual-scroller）
- **優點**：功能完善、經過實戰驗證
- **缺點**：增加依賴、打包體積增大、需要引入建置工具
- **結論**：過度工程化，自行實作更輕量

## Dependencies

- 無外部依賴
- 需修改 `Templates/ComprehensiveFileStatusReport.html`

## Risks and Mitigations

| 風險 | 影響 | 緩解措施 |
|------|------|----------|
| 項目高度不一致導致滾動跳躍 | 中 | 使用動態高度測量，並設定合理的預估高度 |
| 快速滾動時可能出現空白 | 低 | 增加緩衝區項目數量（上下各多渲染 5 筆） |
| 瀏覽器相容性問題 | 低 | 使用標準 DOM API，避免使用實驗性特性 |

## Timeline

預計完成時間：**1 個工作日**

- 設計與實作虛擬滾動邏輯：4 小時
- 整合到 6 個標籤頁：2 小時
- 測試與優化：2 小時

## Related Specs

- `report-pagination`: 報表虛擬滾動功能規範
