# Program.cs 重構計畫

經過分析，我發現以下重複的程式碼模式，以下是消除重複的重構計畫:

## 🔍 重複模式識別

### 1. 預覽功能重複 (出現 3 次)
- `ViewMarkedForDeletionFiles()` 第 997-1040 行
- `ViewSkippedFiles()` 第 814-874 行
- `InteractiveDeleteDuplicates()` 第 358-393 行

這三處都有類似的預覽邏輯，處理 `p` 指令並解析編號。

### 2. 報表生成重複 (出現 2 次)
- `GenerateJsonReport()` 第 1420-1461 行
- `GenerateMarkedForDeletionJsonReport()` 第 1463-1504 行
- `GenerateHtmlReport()` 第 1506-1559 行
- `GenerateMarkedForDeletionHtmlReport()` 第 1561-1614 行

這些方法結構幾乎相同，只是資料來源不同。

### 3. 確認對話框重複 (出現多次)
- 第 426-430 行、501-504 行、663-666 行、878-881 行、1044-1047 行、1091-1094 行

多處使用相同的 `(Y/n)` 確認邏輯。

### 4. 資料庫操作重複
- `LoadMarkedForDeletionFilesWithDetails()` 和 `LoadMarkedForDeletionFilesGroupedByHash()`
- `GenerateJsonReport()` 和 `GenerateMarkedForDeletionJsonReport()`

## 📋 重構計畫

### 階段 1: 提取共用方法 ✅

- [x] 1.1 提取預覽功能
  ```csharp
  static List<int> ParsePreviewIndices(string previewPart, int maxCount)
  static bool HandlePreviewCommand(string? choice, List<string> files)
  ```

- [x] 1.2 提取確認對話框
  ```csharp
  static bool ConfirmAction(string message)
  ```

- [x] 1.3 統一報表生成
  ```csharp
  static void GenerateReport(
      Dictionary<string, List<(string path, string timestamp)>> groups,
      string reportPrefix,
      string templateFileName,
      string timestampLabel)
  ```

- [x] 1.4 提取 JSON 序列化邏輯
  ```csharp
  static string SerializeReportData(object reportData, bool indent = true)
  static object CreateReportData(
      Dictionary<string, List<(string path, string timestamp)>> groups,
      string timestampLabel)
  ```

### 階段 2: 重構資料結構 ✅

- [x] 2.1 建立共用資料模型
  ```csharp
  record FileRecord(string Path, string Timestamp, bool Exists, long Size, DateTime? CreatedTime, DateTime? ModifiedTime)
  record FileGroup(string Hash, List<FileRecord> Files)
  ```

- [x] 2.2 統一資料載入方法
  ```csharp
  static Dictionary<string, List<(string path, string timestamp)>> LoadFilesGroupedByHash(
      string tableName,
      string timestampColumn)
  ```

### 階段 3: 簡化操作選單 ✅

- [x] 3.1 提取顯示處理邏輯
  ```csharp
  static void DisplayMenu(params string[] options)
  static void DisplayFileInfo(string path, bool showDetails = true)
  static void DisplayFileGroup(List<(string path, string timestamp)> files, string timestampLabel)
  ```

- [x] 3.2 統一編號解析（已在階段1完成）
  ```csharp
  static List<int> ParseIndices(string? input, int maxCount)
  // 已在 ViewSkippedFiles、ViewMarkedForDeletionFiles、InteractiveDeleteDuplicates 中使用
  ```

### 階段 4: 改善架構 ✅ (部分完成)

- [x] 4.1 建立資料庫輔助類別（輕量級）
  ```csharp
  static class DatabaseHelper
  {
      static SqliteConnection CreateConnection()
      static int ExecuteNonQuery(string commandText, Action<SqliteCommand>? configureParameters)
      static T ExecuteQuery<T>(string commandText, Func<SqliteDataReader, T> processReader, ...)
      static void ExecuteTransaction(Action<SqliteConnection, SqliteTransaction> action)
  }
  // 已應用於: LoadFilesGroupedByHash, ClearAllMarks, ClearAllSkippedMarks
  ```

- [x] 4.2 報表服務（已在階段1完成）
  ```csharp
  // GenerateReport, CreateReportData, SerializeReportData 已在階段1建立
  ```

- [x] 4.3 檔案預覽服務（已在階段1完成）
  ```csharp
  // PreviewFiles, HandlePreviewCommand 已在階段1建立
  ```

- [x] 4.4 UI 邏輯分離（已在階段3完成）
  ```csharp
  // DisplayMenu, DisplayFileInfo, DisplayFileGroup, ConfirmAction 已在階段1&3建立
  ```

## 📊 實際成果 vs 預期效果

### 預期效果
- **程式碼行數**: 從 1990 行減少到約 1400-1500 行 (減少 25-30%)
- **方法數量**: 從 40+ 個方法整合到約 30 個
- **可維護性**: 修改報表格式或預覽邏輯只需改一處
- **可測試性**: 提取的小方法更容易進行單元測試

### 實際成果
- **程式碼行數**: 從 1990 行到 1977 行（淨減少 13 行，約 0.7%）
  - 階段 1: -146 行（消除重複）
  - 階段 2: +44 行（新增資料模型）
  - 階段 3: +33 行（新增顯示方法）
  - 階段 4: +56 行（新增 DatabaseHelper）
- **新增共用方法**: 14 個
  - 階段 1: 7 個（工具方法）
  - 階段 2: 1 個（資料載入）
  - 階段 3: 3 個（UI 顯示）
  - 階段 4: 3 個（DatabaseHelper 方法，實際為靜態類別的 4 個方法）
- **刪除重複方法**: 6 個（4 個報表 + 2 個載入）
- **新增資料模型**: 2 個（FileRecord + FileGroup）
- **新增輔助類別**: 1 個（DatabaseHelper）
- **可維護性**: ✅ 達成 - 報表、預覽、確認對話框、選單顯示都已統一
- **可測試性**: ✅ 達成 - 方法更小、職責更單一

## 🎯 優先順序建議

1. **高優先**: 階段 1 (提取共用方法) - 立即見效
2. **中優先**: 階段 2 (重構資料結構) - 長期維護
3. **低優先**: 階段 3-4 (架構改善) - 可選擇性執行

## 📝 執行記錄

- [x] 階段 1 完成 (2025-10-06)
  - 程式碼行數：從 1990 行減少到 1844 行（減少 146 行，約 7.3%）
  - 編譯結果：成功，0 警告 0 錯誤
  - 主要改善：
    - 提取了 4 個共用方法（HandlePreviewCommand、ConfirmAction、ParseIndices、ParsePreviewIndices）
    - 統一了報表生成邏輯（CreateReportData、SerializeReportData、GenerateReport）
    - 刪除了 4 個重複的報表生成方法
    - 所有預覽功能和確認對話框都已重構使用共用方法
- [x] 階段 2 完成 (2025-10-06)
  - 程式碼行數：從 1844 行增加到 1888 行（增加 44 行，主要是新增資料模型定義）
  - 編譯結果：成功，0 警告 0 錯誤
  - 主要改善：
    - 新增 FileRecord 和 FileGroup 資料模型，提供強型別支援
    - 統一資料載入方法 LoadFilesGroupedByHash，消除重複的資料庫查詢邏輯
    - LoadMarkedForDeletionFilesGroupedByHash 和 LoadSkippedFilesGroupedByHash 簡化為一行呼叫
    - 為未來擴充奠定良好的資料結構基礎
- [x] 階段 3 完成 (2025-10-06)
  - 程式碼行數：從 1888 行增加到 1921 行（增加 33 行，主要是新增顯示輔助方法）
  - 編譯結果：成功，0 警告 0 錯誤
  - 主要改善：
    - 新增 DisplayMenu 統一選單顯示邏輯（3 處使用）
    - 新增 DisplayFileInfo 統一檔案資訊顯示
    - 新增 DisplayFileGroup 統一檔案群組顯示（簡化 ViewSkippedFiles 的顯示邏輯）
    - 驗證 ParseIndices 在階段 1 已完整應用於所有需要的地方
    - 改善程式碼可讀性和一致性
- [x] 階段 4 完成 (2025-10-06) - 部分完成
  - 程式碼行數：從 1921 行增加到 1977 行（增加 56 行，主要是新增 DatabaseHelper 類別）
  - 編譯結果：成功（DLL 編譯成功，EXE 被程式鎖定）
  - 主要改善：
    - 新增 DatabaseHelper 輕量級資料庫輔助類別，提供 4 個核心方法
    - 示範性地改寫 3 個方法使用 DatabaseHelper（LoadFilesGroupedByHash, ClearAllMarks, ClearAllSkippedMarks）
    - 其他服務層功能已在階段 1-3 完成（報表、預覽、UI）
    - 為未來進一步架構改善奠定基礎
  - 註記：階段 4 採取輕量級實作方式，避免過度設計，保持程式碼簡潔
