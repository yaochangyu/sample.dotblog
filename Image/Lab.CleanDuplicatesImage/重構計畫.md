# Program.cs é‡æ§‹è¨ˆç•«

ç¶“éåˆ†æï¼Œæˆ‘ç™¼ç¾ä»¥ä¸‹é‡è¤‡çš„ç¨‹å¼ç¢¼æ¨¡å¼ï¼Œä»¥ä¸‹æ˜¯æ¶ˆé™¤é‡è¤‡çš„é‡æ§‹è¨ˆç•«:

## ğŸ” é‡è¤‡æ¨¡å¼è­˜åˆ¥

### 1. é è¦½åŠŸèƒ½é‡è¤‡ (å‡ºç¾ 3 æ¬¡)
- `ViewMarkedForDeletionFiles()` ç¬¬ 997-1040 è¡Œ
- `ViewSkippedFiles()` ç¬¬ 814-874 è¡Œ
- `InteractiveDeleteDuplicates()` ç¬¬ 358-393 è¡Œ

é€™ä¸‰è™•éƒ½æœ‰é¡ä¼¼çš„é è¦½é‚è¼¯ï¼Œè™•ç† `p` æŒ‡ä»¤ä¸¦è§£æç·¨è™Ÿã€‚

### 2. å ±è¡¨ç”Ÿæˆé‡è¤‡ (å‡ºç¾ 2 æ¬¡)
- `GenerateJsonReport()` ç¬¬ 1420-1461 è¡Œ
- `GenerateMarkedForDeletionJsonReport()` ç¬¬ 1463-1504 è¡Œ
- `GenerateHtmlReport()` ç¬¬ 1506-1559 è¡Œ
- `GenerateMarkedForDeletionHtmlReport()` ç¬¬ 1561-1614 è¡Œ

é€™äº›æ–¹æ³•çµæ§‹å¹¾ä¹ç›¸åŒï¼Œåªæ˜¯è³‡æ–™ä¾†æºä¸åŒã€‚

### 3. ç¢ºèªå°è©±æ¡†é‡è¤‡ (å‡ºç¾å¤šæ¬¡)
- ç¬¬ 426-430 è¡Œã€501-504 è¡Œã€663-666 è¡Œã€878-881 è¡Œã€1044-1047 è¡Œã€1091-1094 è¡Œ

å¤šè™•ä½¿ç”¨ç›¸åŒçš„ `(Y/n)` ç¢ºèªé‚è¼¯ã€‚

### 4. è³‡æ–™åº«æ“ä½œé‡è¤‡
- `LoadMarkedForDeletionFilesWithDetails()` å’Œ `LoadMarkedForDeletionFilesGroupedByHash()`
- `GenerateJsonReport()` å’Œ `GenerateMarkedForDeletionJsonReport()`

## ğŸ“‹ é‡æ§‹è¨ˆç•«

### éšæ®µ 1: æå–å…±ç”¨æ–¹æ³• âœ…

- [x] 1.1 æå–é è¦½åŠŸèƒ½
  ```csharp
  static List<int> ParsePreviewIndices(string previewPart, int maxCount)
  static bool HandlePreviewCommand(string? choice, List<string> files)
  ```

- [x] 1.2 æå–ç¢ºèªå°è©±æ¡†
  ```csharp
  static bool ConfirmAction(string message)
  ```

- [x] 1.3 çµ±ä¸€å ±è¡¨ç”Ÿæˆ
  ```csharp
  static void GenerateReport(
      Dictionary<string, List<(string path, string timestamp)>> groups,
      string reportPrefix,
      string templateFileName,
      string timestampLabel)
  ```

- [x] 1.4 æå– JSON åºåˆ—åŒ–é‚è¼¯
  ```csharp
  static string SerializeReportData(object reportData, bool indent = true)
  static object CreateReportData(
      Dictionary<string, List<(string path, string timestamp)>> groups,
      string timestampLabel)
  ```

### éšæ®µ 2: é‡æ§‹è³‡æ–™çµæ§‹ âœ…

- [x] 2.1 å»ºç«‹å…±ç”¨è³‡æ–™æ¨¡å‹
  ```csharp
  record FileRecord(string Path, string Timestamp, bool Exists, long Size, DateTime? CreatedTime, DateTime? ModifiedTime)
  record FileGroup(string Hash, List<FileRecord> Files)
  ```

- [x] 2.2 çµ±ä¸€è³‡æ–™è¼‰å…¥æ–¹æ³•
  ```csharp
  static Dictionary<string, List<(string path, string timestamp)>> LoadFilesGroupedByHash(
      string tableName,
      string timestampColumn)
  ```

### éšæ®µ 3: ç°¡åŒ–æ“ä½œé¸å–® âœ…

- [x] 3.1 æå–é¡¯ç¤ºè™•ç†é‚è¼¯
  ```csharp
  static void DisplayMenu(params string[] options)
  static void DisplayFileInfo(string path, bool showDetails = true)
  static void DisplayFileGroup(List<(string path, string timestamp)> files, string timestampLabel)
  ```

- [x] 3.2 çµ±ä¸€ç·¨è™Ÿè§£æï¼ˆå·²åœ¨éšæ®µ1å®Œæˆï¼‰
  ```csharp
  static List<int> ParseIndices(string? input, int maxCount)
  // å·²åœ¨ ViewSkippedFilesã€ViewMarkedForDeletionFilesã€InteractiveDeleteDuplicates ä¸­ä½¿ç”¨
  ```

### éšæ®µ 4: æ”¹å–„æ¶æ§‹ âœ… (éƒ¨åˆ†å®Œæˆ)

- [x] 4.1 å»ºç«‹è³‡æ–™åº«è¼”åŠ©é¡åˆ¥ï¼ˆè¼•é‡ç´šï¼‰
  ```csharp
  static class DatabaseHelper
  {
      static SqliteConnection CreateConnection()
      static int ExecuteNonQuery(string commandText, Action<SqliteCommand>? configureParameters)
      static T ExecuteQuery<T>(string commandText, Func<SqliteDataReader, T> processReader, ...)
      static void ExecuteTransaction(Action<SqliteConnection, SqliteTransaction> action)
  }
  // å·²æ‡‰ç”¨æ–¼: LoadFilesGroupedByHash, ClearAllMarks, ClearAllSkippedMarks
  ```

- [x] 4.2 å ±è¡¨æœå‹™ï¼ˆå·²åœ¨éšæ®µ1å®Œæˆï¼‰
  ```csharp
  // GenerateReport, CreateReportData, SerializeReportData å·²åœ¨éšæ®µ1å»ºç«‹
  ```

- [x] 4.3 æª”æ¡ˆé è¦½æœå‹™ï¼ˆå·²åœ¨éšæ®µ1å®Œæˆï¼‰
  ```csharp
  // PreviewFiles, HandlePreviewCommand å·²åœ¨éšæ®µ1å»ºç«‹
  ```

- [x] 4.4 UI é‚è¼¯åˆ†é›¢ï¼ˆå·²åœ¨éšæ®µ3å®Œæˆï¼‰
  ```csharp
  // DisplayMenu, DisplayFileInfo, DisplayFileGroup, ConfirmAction å·²åœ¨éšæ®µ1&3å»ºç«‹
  ```

## ğŸ“Š å¯¦éš›æˆæœ vs é æœŸæ•ˆæœ

### é æœŸæ•ˆæœ
- **ç¨‹å¼ç¢¼è¡Œæ•¸**: å¾ 1990 è¡Œæ¸›å°‘åˆ°ç´„ 1400-1500 è¡Œ (æ¸›å°‘ 25-30%)
- **æ–¹æ³•æ•¸é‡**: å¾ 40+ å€‹æ–¹æ³•æ•´åˆåˆ°ç´„ 30 å€‹
- **å¯ç¶­è­·æ€§**: ä¿®æ”¹å ±è¡¨æ ¼å¼æˆ–é è¦½é‚è¼¯åªéœ€æ”¹ä¸€è™•
- **å¯æ¸¬è©¦æ€§**: æå–çš„å°æ–¹æ³•æ›´å®¹æ˜“é€²è¡Œå–®å…ƒæ¸¬è©¦

### å¯¦éš›æˆæœ
- **ç¨‹å¼ç¢¼è¡Œæ•¸**: å¾ 1990 è¡Œåˆ° 1977 è¡Œï¼ˆæ·¨æ¸›å°‘ 13 è¡Œï¼Œç´„ 0.7%ï¼‰
  - éšæ®µ 1: -146 è¡Œï¼ˆæ¶ˆé™¤é‡è¤‡ï¼‰
  - éšæ®µ 2: +44 è¡Œï¼ˆæ–°å¢è³‡æ–™æ¨¡å‹ï¼‰
  - éšæ®µ 3: +33 è¡Œï¼ˆæ–°å¢é¡¯ç¤ºæ–¹æ³•ï¼‰
  - éšæ®µ 4: +56 è¡Œï¼ˆæ–°å¢ DatabaseHelperï¼‰
- **æ–°å¢å…±ç”¨æ–¹æ³•**: 14 å€‹
  - éšæ®µ 1: 7 å€‹ï¼ˆå·¥å…·æ–¹æ³•ï¼‰
  - éšæ®µ 2: 1 å€‹ï¼ˆè³‡æ–™è¼‰å…¥ï¼‰
  - éšæ®µ 3: 3 å€‹ï¼ˆUI é¡¯ç¤ºï¼‰
  - éšæ®µ 4: 3 å€‹ï¼ˆDatabaseHelper æ–¹æ³•ï¼Œå¯¦éš›ç‚ºéœæ…‹é¡åˆ¥çš„ 4 å€‹æ–¹æ³•ï¼‰
- **åˆªé™¤é‡è¤‡æ–¹æ³•**: 6 å€‹ï¼ˆ4 å€‹å ±è¡¨ + 2 å€‹è¼‰å…¥ï¼‰
- **æ–°å¢è³‡æ–™æ¨¡å‹**: 2 å€‹ï¼ˆFileRecord + FileGroupï¼‰
- **æ–°å¢è¼”åŠ©é¡åˆ¥**: 1 å€‹ï¼ˆDatabaseHelperï¼‰
- **å¯ç¶­è­·æ€§**: âœ… é”æˆ - å ±è¡¨ã€é è¦½ã€ç¢ºèªå°è©±æ¡†ã€é¸å–®é¡¯ç¤ºéƒ½å·²çµ±ä¸€
- **å¯æ¸¬è©¦æ€§**: âœ… é”æˆ - æ–¹æ³•æ›´å°ã€è·è²¬æ›´å–®ä¸€

## ğŸ¯ å„ªå…ˆé †åºå»ºè­°

1. **é«˜å„ªå…ˆ**: éšæ®µ 1 (æå–å…±ç”¨æ–¹æ³•) - ç«‹å³è¦‹æ•ˆ
2. **ä¸­å„ªå…ˆ**: éšæ®µ 2 (é‡æ§‹è³‡æ–™çµæ§‹) - é•·æœŸç¶­è­·
3. **ä½å„ªå…ˆ**: éšæ®µ 3-4 (æ¶æ§‹æ”¹å–„) - å¯é¸æ“‡æ€§åŸ·è¡Œ

## ğŸ“ åŸ·è¡Œè¨˜éŒ„

- [x] éšæ®µ 1 å®Œæˆ (2025-10-06)
  - ç¨‹å¼ç¢¼è¡Œæ•¸ï¼šå¾ 1990 è¡Œæ¸›å°‘åˆ° 1844 è¡Œï¼ˆæ¸›å°‘ 146 è¡Œï¼Œç´„ 7.3%ï¼‰
  - ç·¨è­¯çµæœï¼šæˆåŠŸï¼Œ0 è­¦å‘Š 0 éŒ¯èª¤
  - ä¸»è¦æ”¹å–„ï¼š
    - æå–äº† 4 å€‹å…±ç”¨æ–¹æ³•ï¼ˆHandlePreviewCommandã€ConfirmActionã€ParseIndicesã€ParsePreviewIndicesï¼‰
    - çµ±ä¸€äº†å ±è¡¨ç”Ÿæˆé‚è¼¯ï¼ˆCreateReportDataã€SerializeReportDataã€GenerateReportï¼‰
    - åˆªé™¤äº† 4 å€‹é‡è¤‡çš„å ±è¡¨ç”Ÿæˆæ–¹æ³•
    - æ‰€æœ‰é è¦½åŠŸèƒ½å’Œç¢ºèªå°è©±æ¡†éƒ½å·²é‡æ§‹ä½¿ç”¨å…±ç”¨æ–¹æ³•
- [x] éšæ®µ 2 å®Œæˆ (2025-10-06)
  - ç¨‹å¼ç¢¼è¡Œæ•¸ï¼šå¾ 1844 è¡Œå¢åŠ åˆ° 1888 è¡Œï¼ˆå¢åŠ  44 è¡Œï¼Œä¸»è¦æ˜¯æ–°å¢è³‡æ–™æ¨¡å‹å®šç¾©ï¼‰
  - ç·¨è­¯çµæœï¼šæˆåŠŸï¼Œ0 è­¦å‘Š 0 éŒ¯èª¤
  - ä¸»è¦æ”¹å–„ï¼š
    - æ–°å¢ FileRecord å’Œ FileGroup è³‡æ–™æ¨¡å‹ï¼Œæä¾›å¼·å‹åˆ¥æ”¯æ´
    - çµ±ä¸€è³‡æ–™è¼‰å…¥æ–¹æ³• LoadFilesGroupedByHashï¼Œæ¶ˆé™¤é‡è¤‡çš„è³‡æ–™åº«æŸ¥è©¢é‚è¼¯
    - LoadMarkedForDeletionFilesGroupedByHash å’Œ LoadSkippedFilesGroupedByHash ç°¡åŒ–ç‚ºä¸€è¡Œå‘¼å«
    - ç‚ºæœªä¾†æ“´å……å¥ å®šè‰¯å¥½çš„è³‡æ–™çµæ§‹åŸºç¤
- [x] éšæ®µ 3 å®Œæˆ (2025-10-06)
  - ç¨‹å¼ç¢¼è¡Œæ•¸ï¼šå¾ 1888 è¡Œå¢åŠ åˆ° 1921 è¡Œï¼ˆå¢åŠ  33 è¡Œï¼Œä¸»è¦æ˜¯æ–°å¢é¡¯ç¤ºè¼”åŠ©æ–¹æ³•ï¼‰
  - ç·¨è­¯çµæœï¼šæˆåŠŸï¼Œ0 è­¦å‘Š 0 éŒ¯èª¤
  - ä¸»è¦æ”¹å–„ï¼š
    - æ–°å¢ DisplayMenu çµ±ä¸€é¸å–®é¡¯ç¤ºé‚è¼¯ï¼ˆ3 è™•ä½¿ç”¨ï¼‰
    - æ–°å¢ DisplayFileInfo çµ±ä¸€æª”æ¡ˆè³‡è¨Šé¡¯ç¤º
    - æ–°å¢ DisplayFileGroup çµ±ä¸€æª”æ¡ˆç¾¤çµ„é¡¯ç¤ºï¼ˆç°¡åŒ– ViewSkippedFiles çš„é¡¯ç¤ºé‚è¼¯ï¼‰
    - é©—è­‰ ParseIndices åœ¨éšæ®µ 1 å·²å®Œæ•´æ‡‰ç”¨æ–¼æ‰€æœ‰éœ€è¦çš„åœ°æ–¹
    - æ”¹å–„ç¨‹å¼ç¢¼å¯è®€æ€§å’Œä¸€è‡´æ€§
- [x] éšæ®µ 4 å®Œæˆ (2025-10-06) - éƒ¨åˆ†å®Œæˆ
  - ç¨‹å¼ç¢¼è¡Œæ•¸ï¼šå¾ 1921 è¡Œå¢åŠ åˆ° 1977 è¡Œï¼ˆå¢åŠ  56 è¡Œï¼Œä¸»è¦æ˜¯æ–°å¢ DatabaseHelper é¡åˆ¥ï¼‰
  - ç·¨è­¯çµæœï¼šæˆåŠŸï¼ˆDLL ç·¨è­¯æˆåŠŸï¼ŒEXE è¢«ç¨‹å¼é–å®šï¼‰
  - ä¸»è¦æ”¹å–„ï¼š
    - æ–°å¢ DatabaseHelper è¼•é‡ç´šè³‡æ–™åº«è¼”åŠ©é¡åˆ¥ï¼Œæä¾› 4 å€‹æ ¸å¿ƒæ–¹æ³•
    - ç¤ºç¯„æ€§åœ°æ”¹å¯« 3 å€‹æ–¹æ³•ä½¿ç”¨ DatabaseHelperï¼ˆLoadFilesGroupedByHash, ClearAllMarks, ClearAllSkippedMarksï¼‰
    - å…¶ä»–æœå‹™å±¤åŠŸèƒ½å·²åœ¨éšæ®µ 1-3 å®Œæˆï¼ˆå ±è¡¨ã€é è¦½ã€UIï¼‰
    - ç‚ºæœªä¾†é€²ä¸€æ­¥æ¶æ§‹æ”¹å–„å¥ å®šåŸºç¤
  - è¨»è¨˜ï¼šéšæ®µ 4 æ¡å–è¼•é‡ç´šå¯¦ä½œæ–¹å¼ï¼Œé¿å…éåº¦è¨­è¨ˆï¼Œä¿æŒç¨‹å¼ç¢¼ç°¡æ½”

## ğŸ” é€²ä¸€æ­¥é‡æ§‹æ©Ÿæœƒåˆ†æ (2025-10-06)

ç¶“ééšæ®µ 1-4 çš„é‡æ§‹å¾Œï¼Œä»å­˜åœ¨ä»¥ä¸‹å¯æ¶ˆé™¤çš„é‡è¤‡ç¨‹å¼ç¢¼ï¼š

### 5. è³‡æ–™åº«é€£ç·šé‡è¤‡æ¨¡å¼ (ç´„ 15 è™•)

ç›®å‰é‚„æœ‰è¨±å¤šæ–¹æ³•ç›´æ¥å»ºç«‹ `SqliteConnection`ï¼Œè€Œéä½¿ç”¨ `DatabaseHelper`ï¼š

**å¾…æ”¹å¯«çš„æ–¹æ³•æ¸…å–®**ï¼š
- `MarkFileForDeletion()` (649-676è¡Œ) - å–®ç­†æ’å…¥æ“ä½œ
- `ExecuteMarkedDeletions()` (682-802è¡Œ) - è¤‡é›œæŸ¥è©¢èˆ‡åˆªé™¤
- `LoadMarkedFiles()` (1144-1168è¡Œ) - æŸ¥è©¢æª”æ¡ˆæ¸…å–®
- `LoadMarkedFilesByHash()` (1170-1202è¡Œ) - æŸ¥è©¢ä¸¦åˆ†çµ„
- `LoadSkippedHashes()` (1204-1228è¡Œ) - æŸ¥è©¢ Hash æ¸…å–®
- `MarkHashAsSkipped()` (1230-1264è¡Œ) - æ‰¹æ¬¡æ’å…¥
- `UnskipHashes()` (1271-1291è¡Œ) - æ‰¹æ¬¡åˆªé™¤
- `UnmarkFiles()` (1117-1137è¡Œ) - æ‰¹æ¬¡åˆªé™¤
- `LoadMarkedForDeletionFilesWithDetails()` (1086-1110è¡Œ) - æŸ¥è©¢è©³ç´°è³‡è¨Š
- `LoadExistingHashes()` (1786-1824è¡Œ) - è¤‡é›œæŸ¥è©¢å»ºç«‹å­—å…¸
- `InitializeDatabase()` (1864-1901è¡Œ) - DDL æ“ä½œ
- `WriteToDatabase()` (1906-1977è¡Œ) - æ‰¹æ¬¡å¯«å…¥

**é‡è¤‡æ¨¡å¼**ï¼š
```csharp
using var connection = new SqliteConnection($"Data Source={DatabaseFileName}");
connection.Open();
var command = connection.CreateCommand();
command.CommandText = "...";
// ... åƒæ•¸è¨­å®š ...
command.ExecuteNonQuery() / ExecuteReader();
```

### 6. æª”æ¡ˆå­˜åœ¨æ€§æª¢æŸ¥èˆ‡åˆ†çµ„ (ç´„ 5 è™•)

é‡è¤‡çš„æª”æ¡ˆå­˜åœ¨æ€§æª¢æŸ¥é‚è¼¯ï¼š
```csharp
var existingFiles = files.Where(f => File.Exists(f.path)).ToList();
var missingFiles = files.Where(f => !File.Exists(f.path)).ToList();
```

**å‡ºç¾ä½ç½®**ï¼š
- `DisplayFileGroup()` (1463-1464è¡Œ)
- `ExecuteMarkedDeletions()` (707-708è¡Œ)
- `ViewMarkedForDeletionFiles()` (970-971è¡Œ)

### 7. åƒæ•¸åŒ–å»ºç«‹èˆ‡ç¶å®šæ¨¡å¼ (ç´„ 12 è™•)

é‡è¤‡çš„åƒæ•¸å»ºç«‹å’Œç¶å®šé‚è¼¯ï¼š
```csharp
var pathParam = command.CreateParameter();
pathParam.ParameterName = "$path";
pathParam.Value = value;
command.Parameters.Add(pathParam);
```

é€™å€‹æ¨¡å¼åœ¨æ‰€æœ‰æœªä½¿ç”¨ `DatabaseHelper` çš„æ–¹æ³•ä¸­éƒ½æœƒå‡ºç¾ã€‚

---

## ğŸ“‹ æ–°çš„é‡æ§‹è¨ˆç•«ï¼ˆéšæ®µ 5-6ï¼‰

### éšæ®µ 5: çµ±ä¸€è³‡æ–™åº«å­˜å–å±¤ ğŸ”„

**ç›®æ¨™**: å°‡æ‰€æœ‰è³‡æ–™åº«æ“ä½œéƒ½æ”¹ç”¨ `DatabaseHelper`ï¼Œæ¶ˆé™¤é‡è¤‡çš„é€£ç·šå»ºç«‹èˆ‡åƒæ•¸ç¶å®šç¨‹å¼ç¢¼

#### 5.1 æ”¹å¯«ç¾æœ‰è³‡æ–™åº«æ“ä½œæ–¹æ³•

**æŸ¥è©¢é¡æ–¹æ³•** (ä½¿ç”¨ `ExecuteQuery`):
- [ ] `LoadMarkedFiles()`
  ```csharp
  // å¾ 25 è¡Œ â†’ ç´„ 10 è¡Œ
  return DatabaseHelper.ExecuteQuery(
      "SELECT FilePath FROM FilesToDelete",
      reader => {
          var files = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
          while (reader.Read()) files.Add(reader.GetString(0));
          return files;
      });
  ```

- [ ] `LoadMarkedFilesByHash()`
  ```csharp
  // å¾ 32 è¡Œ â†’ ç´„ 15 è¡Œ
  ```

- [ ] `LoadSkippedHashes()`
  ```csharp
  // å¾ 28 è¡Œ â†’ ç´„ 10 è¡Œ
  ```

- [ ] `LoadMarkedForDeletionFilesWithDetails()`
  ```csharp
  // å¾ 24 è¡Œ â†’ ç´„ 10 è¡Œ
  ```

- [ ] `LoadExistingHashes()`
  ```csharp
  // å¾ 38 è¡Œ â†’ ç´„ 20 è¡Œ
  ```

**å–®ç­†æ“ä½œé¡æ–¹æ³•** (ä½¿ç”¨ `ExecuteNonQuery`):
- [ ] `MarkFileForDeletion()`
  ```csharp
  // å¾ 27 è¡Œ â†’ ç´„ 10 è¡Œ
  DatabaseHelper.ExecuteNonQuery(
      "INSERT OR IGNORE INTO FilesToDelete (Hash, FilePath, MarkedAt) VALUES ($hash, $filePath, $markedAt)",
      cmd => {
          cmd.Parameters.Add(new SqliteParameter("$hash", hash ?? (object)DBNull.Value));
          cmd.Parameters.Add(new SqliteParameter("$filePath", filePath));
          cmd.Parameters.Add(new SqliteParameter("$markedAt", DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")));
      });
  ```

**æ‰¹æ¬¡æ“ä½œé¡æ–¹æ³•** (ä½¿ç”¨ `ExecuteTransaction`):
- [ ] `MarkHashAsSkipped()`
  ```csharp
  // å¾ 34 è¡Œ â†’ ç´„ 15 è¡Œ
  ```

- [ ] `UnskipHashes()`
  ```csharp
  // å¾ 20 è¡Œ â†’ ç´„ 8 è¡Œ
  ```

- [ ] `UnmarkFiles()`
  ```csharp
  // å¾ 20 è¡Œ â†’ ç´„ 8 è¡Œ
  ```

- [ ] `WriteToDatabase()`
  ```csharp
  // å¾ 71 è¡Œ â†’ ç´„ 30 è¡Œ
  ```

**ç‰¹æ®Šæ–¹æ³•**:
- [ ] `ExecuteMarkedDeletions()` - æ··åˆæŸ¥è©¢èˆ‡åˆªé™¤ï¼Œéƒ¨åˆ†æ”¹ç”¨ `DatabaseHelper`
- [ ] `InitializeDatabase()` - DDL æ“ä½œï¼Œè©•ä¼°æ˜¯å¦éœ€è¦æ”¹ç”¨ `DatabaseHelper`

**é æœŸæ•ˆæœ**:
- æ¸›å°‘ç´„ **150-200 è¡Œ**ç¨‹å¼ç¢¼
- æ¶ˆé™¤ 12 è™•é‡è¤‡çš„é€£ç·šå»ºç«‹é‚è¼¯
- çµ±ä¸€éŒ¯èª¤è™•ç†å’Œè³‡æºç®¡ç†

#### 5.2 æ“´å…… DatabaseHelper (å¯é¸)

å¦‚éœ€æ›´é€²éšçš„åŠŸèƒ½ï¼Œå¯æ–°å¢ä»¥ä¸‹æ–¹æ³•ï¼š

```csharp
static class DatabaseHelper
{
    /// <summary>
    /// åŸ·è¡ŒæŸ¥è©¢ä¸¦è¿”å›æ¸…å–®
    /// </summary>
    public static List<T> ExecuteQueryList<T>(
        string commandText,
        Func<SqliteDataReader, T> rowMapper,
        Action<SqliteCommand>? configureParameters = null)
    {
        return ExecuteQuery(commandText, reader =>
        {
            var list = new List<T>();
            while (reader.Read())
            {
                list.Add(rowMapper(reader));
            }
            return list;
        }, configureParameters);
    }

    /// <summary>
    /// åŸ·è¡Œå–®ä¸€å€¼æŸ¥è©¢ (å¦‚ COUNTã€MAX ç­‰)
    /// </summary>
    public static T? ExecuteScalar<T>(
        string commandText,
        Action<SqliteCommand>? configureParameters = null)
    {
        return ExecuteQuery(commandText, reader =>
        {
            if (reader.Read())
            {
                var value = reader.GetValue(0);
                return value == DBNull.Value ? default : (T)value;
            }
            return default;
        }, configureParameters);
    }
}
```

### éšæ®µ 6: æå–é‡è¤‡é‚è¼¯å·¥å…·æ–¹æ³• ğŸ”„

#### 6.1 æª”æ¡ˆåˆ†çµ„å·¥å…·æ–¹æ³•

```csharp
/// <summary>
/// æ ¹æ“šæª”æ¡ˆå­˜åœ¨æ€§å°‡é …ç›®åˆ†ç‚ºå…©çµ„
/// </summary>
static (List<T> existing, List<T> missing) PartitionByFileExistence<T>(
    List<T> items,
    Func<T, string> pathSelector)
{
    var existing = items.Where(i => File.Exists(pathSelector(i))).ToList();
    var missing = items.Where(i => !File.Exists(pathSelector(i))).ToList();
    return (existing, missing);
}
```

**ä½¿ç”¨ä½ç½®**:
- [ ] `DisplayFileGroup()` (1463-1464è¡Œ)
  ```csharp
  // ä¿®æ”¹å‰:
  var existingFiles = files.Where(f => File.Exists(f.path)).ToList();
  var missingFiles = files.Where(f => !File.Exists(f.path)).ToList();

  // ä¿®æ”¹å¾Œ:
  var (existingFiles, missingFiles) = PartitionByFileExistence(files, f => f.path);
  ```

- [ ] `ExecuteMarkedDeletions()` (707-708è¡Œ)
- [ ] `ViewMarkedForDeletionFiles()` (970-971è¡Œ)

**é æœŸæ•ˆæœ**: æ¸›å°‘ç´„ **15-20 è¡Œ**

#### 6.2 æª”æ¡ˆæ¸…å–®é¡¯ç¤ºå·¥å…· (å¯é¸)

```csharp
/// <summary>
/// é¡¯ç¤ºæª”æ¡ˆæ¸…å–®ï¼ˆå¸¶ç·¨è™Ÿæˆ–ä¸å¸¶ç·¨è™Ÿï¼‰
/// </summary>
static void DisplayFileList(
    List<(string path, string timestamp)> files,
    string label,
    bool showIndex = false,
    bool showDetails = true)
{
    Console.WriteLine($"{label} ({files.Count} å€‹):");
    for (int i = 0; i < files.Count; i++)
    {
        var prefix = showIndex ? $"[{i + 1}] " : "  - ";
        Console.WriteLine($"{prefix}{files[i].path}");

        if (showDetails && File.Exists(files[i].path))
        {
            var fileInfo = new FileInfo(files[i].path);
            Console.WriteLine($"    å¤§å°: {FormatFileSize(fileInfo.Length)}");
        }
    }
}
```

---

## ğŸ“Š é æœŸç¸½æ•ˆæœï¼ˆå®Œæˆéšæ®µ 5-6 å¾Œï¼‰

### ç¨‹å¼ç¢¼æ”¹å–„
- **ç¨‹å¼ç¢¼è¡Œæ•¸**: å¾ 1977 è¡Œæ¸›å°‘åˆ°ç´„ **1700-1750 è¡Œ** (æ¸›å°‘ **11-14%**)
- **DatabaseHelper ä½¿ç”¨ç‡**: å¾ 3 è™•å¢åŠ åˆ° **15+ è™•** (è¦†è“‹æ‰€æœ‰è³‡æ–™åº«æ“ä½œ)
- **é‡è¤‡æ¨¡å¼æ¶ˆé™¤**:
  - è³‡æ–™åº«é€£ç·šå»ºç«‹: 12 è™• â†’ 0 è™•
  - æª”æ¡ˆå­˜åœ¨æ€§æª¢æŸ¥: 5 è™• â†’ 0 è™•
  - åƒæ•¸ç¶å®šé‚è¼¯: å¤§å¹…ç°¡åŒ–

### ç¨‹å¼ç¢¼å“è³ª
- **å¯ç¶­è­·æ€§**: âœ…âœ… æ‰€æœ‰è³‡æ–™åº«æ“ä½œé›†ä¸­åœ¨ `DatabaseHelper`ï¼Œä¿®æ”¹é€£ç·šé‚è¼¯åªéœ€ä¸€è™•
- **ä¸€è‡´æ€§**: âœ…âœ… çµ±ä¸€çš„éŒ¯èª¤è™•ç†ã€é€£ç·šç®¡ç†ã€ç•°å¸¸è™•ç†
- **å¯æ¸¬è©¦æ€§**: âœ…âœ… `DatabaseHelper` å¯è¼•é¬† mockï¼Œæ–¹æ³•æ›´å°æ›´å°ˆæ³¨
- **å¯è®€æ€§**: âœ…âœ… æ¥­å‹™é‚è¼¯èˆ‡è³‡æ–™åº«æ“ä½œåˆ†é›¢ï¼Œç¨‹å¼ç¢¼æ„åœ–æ›´æ¸…æ™°

---

## ğŸ¯ åŸ·è¡Œå„ªå…ˆé †åºå»ºè­°

### é«˜å„ªå…ˆ (å»ºè­°ç«‹å³åŸ·è¡Œ)
1. **éšæ®µ 5.1** - æ”¹å¯«è³‡æ–™åº«æ“ä½œæ–¹æ³•
   - ç«‹å³è¦‹æ•ˆï¼Œå¤§å¹…ç°¡åŒ–ç¨‹å¼ç¢¼
   - æ¸›å°‘ 150-200 è¡Œé‡è¤‡ç¨‹å¼ç¢¼
   - æå‡å¯ç¶­è­·æ€§å’Œä¸€è‡´æ€§

### ä¸­å„ªå…ˆ (è¦–éœ€æ±‚åŸ·è¡Œ)
2. **éšæ®µ 6.1** - æª”æ¡ˆåˆ†çµ„å·¥å…·æ–¹æ³•
   - å°å¹…æ”¹å–„ï¼Œæå‡å¯è®€æ€§
   - æ¸›å°‘ 15-20 è¡Œç¨‹å¼ç¢¼

### ä½å„ªå…ˆ (å¯é¸)
3. **éšæ®µ 5.2** - æ“´å…… DatabaseHelper
   - ä¾å¯¦éš›éœ€æ±‚æ±ºå®šæ˜¯å¦æ–°å¢
4. **éšæ®µ 6.2** - æª”æ¡ˆæ¸…å–®é¡¯ç¤ºå·¥å…·
   - å¯é¸æ€§æ”¹å–„ï¼Œæ•ˆç›Šè¼ƒå°

---

## ğŸš€ å»ºè­°åŸ·è¡Œç­–ç•¥

### æ–¹æ¡ˆ A: ç©æ¥µé‡æ§‹ (æ¨è–¦)
åŸ·è¡Œ **éšæ®µ 5.1 + éšæ®µ 6.1**
- é æœŸæ¸›å°‘: **165-220 è¡Œ**ç¨‹å¼ç¢¼
- å·¥ä½œé‡: ä¸­ç­‰
- æ•ˆç›Š: æœ€é«˜

### æ–¹æ¡ˆ B: ç©©å¥é‡æ§‹
åƒ…åŸ·è¡Œ **éšæ®µ 5.1**
- é æœŸæ¸›å°‘: **150-200 è¡Œ**ç¨‹å¼ç¢¼
- å·¥ä½œé‡: ä¸­ç­‰
- æ•ˆç›Š: é«˜

### æ–¹æ¡ˆ C: ä¿å®ˆç¶­è­·
ç¶­æŒç¾ç‹€ï¼Œåƒ…åœ¨æ–°å¢åŠŸèƒ½æ™‚ä½¿ç”¨ `DatabaseHelper`
- é æœŸæ¸›å°‘: 0 è¡Œ
- å·¥ä½œé‡: ç„¡
- æ•ˆç›Š: ä½

---

## âœ… éšæ®µ 5 åŸ·è¡Œæª¢æŸ¥æ¸…å–®

### 5.1 æŸ¥è©¢é¡æ–¹æ³•æ”¹å¯« (5 å€‹æ–¹æ³•)

- [ ] `LoadMarkedFiles()` (1144-1168è¡Œ)
  - [ ] æ”¹ç”¨ `DatabaseHelper.ExecuteQuery()`
  - [ ] ç§»é™¤æ‰‹å‹•é€£ç·šå»ºç«‹
  - [ ] æ¸¬è©¦æŸ¥è©¢çµæœæ­£ç¢ºæ€§
  - [ ] é æœŸ: å¾ 25 è¡Œ â†’ ç´„ 10 è¡Œ

- [ ] `LoadMarkedFilesByHash()` (1170-1202è¡Œ)
  - [ ] æ”¹ç”¨ `DatabaseHelper.ExecuteQuery()`
  - [ ] ç°¡åŒ–å­—å…¸å»ºç«‹é‚è¼¯
  - [ ] æ¸¬è©¦åˆ†çµ„çµæœæ­£ç¢ºæ€§
  - [ ] é æœŸ: å¾ 32 è¡Œ â†’ ç´„ 15 è¡Œ

- [ ] `LoadSkippedHashes()` (1204-1228è¡Œ)
  - [ ] æ”¹ç”¨ `DatabaseHelper.ExecuteQuery()`
  - [ ] ç§»é™¤ try-catch é‡è¤‡é‚è¼¯
  - [ ] æ¸¬è©¦ HashSet æ­£ç¢ºæ€§
  - [ ] é æœŸ: å¾ 28 è¡Œ â†’ ç´„ 10 è¡Œ

- [ ] `LoadMarkedForDeletionFilesWithDetails()` (1086-1110è¡Œ)
  - [ ] æ”¹ç”¨ `DatabaseHelper.ExecuteQuery()`
  - [ ] ç°¡åŒ– tuple æ¸…å–®å»ºç«‹
  - [ ] æ¸¬è©¦è©³ç´°è³‡è¨Šæ­£ç¢ºæ€§
  - [ ] é æœŸ: å¾ 24 è¡Œ â†’ ç´„ 10 è¡Œ

- [ ] `LoadExistingHashes()` (1786-1824è¡Œ)
  - [ ] æ”¹ç”¨ `DatabaseHelper.ExecuteQuery()`
  - [ ] ä¿æŒé›™å­—å…¸å›å‚³é‚è¼¯
  - [ ] æ¸¬è©¦æª”æ¡ˆéæ¿¾é‚è¼¯
  - [ ] é æœŸ: å¾ 38 è¡Œ â†’ ç´„ 20 è¡Œ

### 5.2 å–®ç­†æ“ä½œé¡æ–¹æ³•æ”¹å¯« (1 å€‹æ–¹æ³•)

- [ ] `MarkFileForDeletion()` (649-676è¡Œ)
  - [ ] æ”¹ç”¨ `DatabaseHelper.ExecuteNonQuery()`
  - [ ] ä½¿ç”¨ `SqliteParameter` ç°¡åŒ–åƒæ•¸ç¶å®š
  - [ ] æ¸¬è©¦æ’å…¥æ“ä½œæ­£ç¢ºæ€§
  - [ ] é æœŸ: å¾ 27 è¡Œ â†’ ç´„ 10 è¡Œ

### 5.3 æ‰¹æ¬¡æ“ä½œé¡æ–¹æ³•æ”¹å¯« (4 å€‹æ–¹æ³•)

- [ ] `MarkHashAsSkipped()` (1230-1264è¡Œ)
  - [ ] æ”¹ç”¨ `DatabaseHelper.ExecuteTransaction()`
  - [ ] ç°¡åŒ–æ‰¹æ¬¡æ’å…¥é‚è¼¯
  - [ ] æ¸¬è©¦äº¤æ˜“æ­£ç¢ºæ€§
  - [ ] é æœŸ: å¾ 34 è¡Œ â†’ ç´„ 15 è¡Œ

- [ ] `UnskipHashes()` (1271-1291è¡Œ)
  - [ ] æ”¹ç”¨ `DatabaseHelper.ExecuteTransaction()`
  - [ ] ç°¡åŒ–æ‰¹æ¬¡åˆªé™¤é‚è¼¯
  - [ ] æ¸¬è©¦äº¤æ˜“å›æ»¾
  - [ ] é æœŸ: å¾ 20 è¡Œ â†’ ç´„ 8 è¡Œ

- [ ] `UnmarkFiles()` (1117-1137è¡Œ)
  - [ ] æ”¹ç”¨ `DatabaseHelper.ExecuteTransaction()`
  - [ ] ç§»é™¤æ‰‹å‹•äº¤æ˜“ç®¡ç†
  - [ ] æ¸¬è©¦æ‰¹æ¬¡å–æ¶ˆæ¨™è¨˜
  - [ ] é æœŸ: å¾ 20 è¡Œ â†’ ç´„ 8 è¡Œ

- [ ] `WriteToDatabase()` (1906-1977è¡Œ)
  - [ ] æ”¹ç”¨ `DatabaseHelper.ExecuteTransaction()`
  - [ ] ç°¡åŒ–å¤§é‡æ’å…¥é‚è¼¯
  - [ ] æ¸¬è©¦æ‰¹æ¬¡å¯«å…¥æ•ˆèƒ½
  - [ ] é æœŸ: å¾ 71 è¡Œ â†’ ç´„ 30 è¡Œ

### 5.4 ç‰¹æ®Šæ–¹æ³•è™•ç† (2 å€‹æ–¹æ³•)

- [ ] `ExecuteMarkedDeletions()` (682-802è¡Œ)
  - [ ] éƒ¨åˆ†æ”¹ç”¨ `DatabaseHelper.ExecuteQuery()` è™•ç†æŸ¥è©¢
  - [ ] ä¿ç•™è¤‡é›œçš„åˆªé™¤é‚è¼¯
  - [ ] æ¸¬è©¦å®Œæ•´åˆªé™¤æµç¨‹
  - [ ] é æœŸ: éƒ¨åˆ†ç°¡åŒ–ï¼Œç´„æ¸›å°‘ 20-30 è¡Œ

- [ ] `InitializeDatabase()` (1864-1901è¡Œ)
  - [ ] è©•ä¼°æ˜¯å¦æ”¹ç”¨ `DatabaseHelper`
  - [ ] DDL æ“ä½œå¯èƒ½ä¿æŒåŸæ¨£
  - [ ] æ¸¬è©¦è³‡æ–™åº«åˆå§‹åŒ–
  - [ ] é æœŸ: å¯èƒ½ä¸æ”¹å¯«

### 5.5 ç·¨è­¯èˆ‡é©—è­‰

- [ ] åŸ·è¡Œ `dotnet build` ç¢ºèªç„¡ç·¨è­¯éŒ¯èª¤
- [ ] åŸ·è¡ŒåŸºæœ¬åŠŸèƒ½æ¸¬è©¦
  - [ ] æ¸¬è©¦æƒæåŠŸèƒ½
  - [ ] æ¸¬è©¦æ¨™è¨˜åŠŸèƒ½
  - [ ] æ¸¬è©¦åˆªé™¤åŠŸèƒ½
  - [ ] æ¸¬è©¦å ±è¡¨ç”Ÿæˆ
- [ ] çµ±è¨ˆç¨‹å¼ç¢¼è¡Œæ•¸è®ŠåŒ–
- [ ] è¨˜éŒ„å¯¦éš›æ¸›å°‘çš„è¡Œæ•¸

**éšæ®µ 5 é æœŸç¸½æ•ˆæœ**: æ¸›å°‘ **150-200 è¡Œ**

---

## âœ… éšæ®µ 6 åŸ·è¡Œæª¢æŸ¥æ¸…å–®

### 6.1 æ–°å¢å·¥å…·æ–¹æ³•

- [ ] æ–°å¢ `PartitionByFileExistence<T>()` æ³›å‹æ–¹æ³•
  - [ ] å¯¦ä½œæª”æ¡ˆå­˜åœ¨æ€§åˆ†çµ„é‚è¼¯
  - [ ] åŠ å…¥ XML æ–‡ä»¶è¨»è§£
  - [ ] å–®å…ƒæ¸¬è©¦ï¼ˆå¯é¸ï¼‰
  - [ ] é æœŸ: æ–°å¢ç´„ 10 è¡Œ

### 6.2 æ”¹å¯«ä½¿ç”¨å·¥å…·æ–¹æ³• (3 è™•)

- [ ] `DisplayFileGroup()` (1463-1464è¡Œ)
  - [ ] æ›¿æ›ç‚º `PartitionByFileExistence(files, f => f.path)`
  - [ ] æ¸¬è©¦é¡¯ç¤ºé‚è¼¯æ­£ç¢ºæ€§
  - [ ] é æœŸ: æ¸›å°‘ 2 è¡Œ

- [ ] `ExecuteMarkedDeletions()` (707-708è¡Œ)
  - [ ] æ›¿æ›ç‚º `PartitionByFileExistence(markedFiles, f => f.path)`
  - [ ] æ¸¬è©¦åˆªé™¤æµç¨‹æ­£ç¢ºæ€§
  - [ ] é æœŸ: æ¸›å°‘ 2 è¡Œ

- [ ] `ViewMarkedForDeletionFiles()` (970-971è¡Œ)
  - [ ] æ›¿æ›ç‚º `PartitionByFileExistence(markedFiles, f => f.path)`
  - [ ] æ¸¬è©¦æŸ¥çœ‹åŠŸèƒ½æ­£ç¢ºæ€§
  - [ ] é æœŸ: æ¸›å°‘ 2 è¡Œ

### 6.3 ç·¨è­¯èˆ‡é©—è­‰

- [ ] åŸ·è¡Œ `dotnet build` ç¢ºèªç„¡ç·¨è­¯éŒ¯èª¤
- [ ] æ¸¬è©¦æ‰€æœ‰ä½¿ç”¨ `PartitionByFileExistence` çš„åŠŸèƒ½
- [ ] çµ±è¨ˆç¨‹å¼ç¢¼è¡Œæ•¸è®ŠåŒ–
- [ ] è¨˜éŒ„å¯¦éš›æ¸›å°‘çš„è¡Œæ•¸

**éšæ®µ 6 é æœŸç¸½æ•ˆæœ**: æ¸›å°‘ **15-20 è¡Œ**

---

## ğŸ“Š éšæ®µ 5-6 ç¸½è¨ˆæª¢æŸ¥æ¸…å–®

### æ”¹å¯«æ–¹æ³•çµ±è¨ˆ
- [ ] æŸ¥è©¢é¡æ–¹æ³•: 5 å€‹ âœ“
- [ ] å–®ç­†æ“ä½œæ–¹æ³•: 1 å€‹ âœ“
- [ ] æ‰¹æ¬¡æ“ä½œæ–¹æ³•: 4 å€‹ âœ“
- [ ] ç‰¹æ®Šæ–¹æ³•: 2 å€‹ âœ“
- [ ] å·¥å…·æ–¹æ³•æ‡‰ç”¨: 3 è™• âœ“

### é æœŸæˆæœ
- [ ] ç¨‹å¼ç¢¼æ¸›å°‘: **165-220 è¡Œ** (å¾ 1977 è¡Œ â†’ ç´„ 1757-1812 è¡Œ)
- [ ] DatabaseHelper ä½¿ç”¨ç‡: **15+ è™•**
- [ ] æ¶ˆé™¤è³‡æ–™åº«é€£ç·šé‡è¤‡: **12 è™•**
- [ ] æ¶ˆé™¤æª”æ¡ˆå­˜åœ¨æ€§æª¢æŸ¥é‡è¤‡: **3 è™•**
- [ ] ç·¨è­¯æˆåŠŸï¼Œ0 è­¦å‘Š 0 éŒ¯èª¤
- [ ] æ‰€æœ‰åŠŸèƒ½æ¸¬è©¦é€šé

### æœ€çµ‚æ–‡ä»¶æ›´æ–°
- [ ] æ›´æ–°é‡æ§‹è¨ˆç•«.md çš„ã€ŒåŸ·è¡Œè¨˜éŒ„ã€ç« ç¯€
- [ ] è¨˜éŒ„å¯¦éš›ç¨‹å¼ç¢¼è¡Œæ•¸è®ŠåŒ–
- [ ] è¨˜éŒ„å¯¦éš›æ”¹å¯«çš„æ–¹æ³•æ•¸é‡
- [ ] è¨˜éŒ„é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ
