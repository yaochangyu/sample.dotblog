<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Protected å®‰å…¨æ¸¬è©¦é é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .test-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .test-item h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .test-item p {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            display: none;
        }

        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .result.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            display: block;
        }

        .summary {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .summary h2 {
            margin-bottom: 15px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-item .number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }

        .stat-item .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .token-display {
            background: #f1f3f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›¡ï¸ API Protected å®‰å…¨æ¸¬è©¦</h1>
            <p>å®Œæ•´çš„ CSRFã€Token æ´©æ¼ã€çˆ¬èŸ²é˜²è­·æ¸¬è©¦å¥—ä»¶</p>
        </div>

        <div class="content">
            <!-- Token é¡¯ç¤ºå€ -->
            <div class="test-section">
                <h2>ğŸ”‘ Token ç‹€æ…‹</h2>
                <button onclick="getToken()">å–å¾—æ–° Token</button>
                <div id="tokenDisplay" class="token-display" style="display:none;">
                    <strong>ç›®å‰ Token:</strong> <span id="currentToken"></span>
                </div>
            </div>

            <!-- CSRF é˜²è­·æ¸¬è©¦ -->
            <div class="test-section">
                <h2>ğŸ”’ CSRF é˜²è­·æ¸¬è©¦ (7 é …)</h2>
                <div class="test-grid">
                    <div class="test-item">
                        <h3>TC-CSRF-01</h3>
                        <p>ç„¡ Token çš„è«‹æ±‚</p>
                        <button onclick="testNoToken()">åŸ·è¡Œæ¸¬è©¦</button>
                        <div id="result-csrf-01" class="result"></div>
                    </div>

                    <div class="test-item">
                        <h3>TC-CSRF-02</h3>
                        <p>å½é€  Token çš„è«‹æ±‚</p>
                        <button onclick="testFakeToken()">åŸ·è¡Œæ¸¬è©¦</button>
                        <div id="result-csrf-02" class="result"></div>
                    </div>

                    <div class="test-item">
                        <h3>TC-CSRF-03</h3>
                        <p>éæœŸ Token çš„è«‹æ±‚ (éœ€ç­‰å¾… 6 ç§’)</p>
                        <button onclick="testExpiredToken()">åŸ·è¡Œæ¸¬è©¦</button>
                        <div id="result-csrf-03" class="result"></div>
                    </div>

                    <div class="test-item">
                        <h3>TC-CSRF-04</h3>
                        <p>é‡è¤‡ä½¿ç”¨ Token (è¶…éæ¬¡æ•¸é™åˆ¶)</p>
                        <button onclick="testReusedToken()">åŸ·è¡Œæ¸¬è©¦</button>
                        <div id="result-csrf-04" class="result"></div>
                    </div>

                    <div class="test-item">
                        <h3>TC-CSRF-05</h3>
                        <p>CORS æ”¿ç­–æª¢æŸ¥</p>
                        <button onclick="testCORS()">åŸ·è¡Œæ¸¬è©¦</button>
                        <div id="result-csrf-05" class="result"></div>
                    </div>

                    <div class="test-item">
                        <h3>TC-CSRF-06</h3>
                        <p>Referer Header é©—è­‰ (ç€è¦½å™¨é™åˆ¶)</p>
                        <button onclick="testReferer()">åŸ·è¡Œæ¸¬è©¦</button>
                        <div id="result-csrf-06" class="result"></div>
                    </div>

                    <div class="test-item">
                        <h3>TC-CSRF-07</h3>
                        <p>Origin Header é©—è­‰ (ç€è¦½å™¨é™åˆ¶)</p>
                        <button onclick="testOrigin()">åŸ·è¡Œæ¸¬è©¦</button>
                        <div id="result-csrf-07" class="result"></div>
                    </div>
                </div>
            </div>

            <!-- Token æ´©æ¼é˜²è­·æ¸¬è©¦ -->
            <div class="test-section">
                <h2>ğŸ”“ Token æ´©æ¼é˜²è­·æ¸¬è©¦ (2 é …)</h2>
                <div class="test-grid">
                    <div class="test-item">
                        <h3>TC-LEAK-02</h3>
                        <p>Token æ‰¹æ¬¡è«‹æ±‚ (10 æ¬¡)</p>
                        <button onclick="testBatchRequest()">åŸ·è¡Œæ¸¬è©¦</button>
                        <div id="result-leak-02" class="result"></div>
                    </div>

                    <div class="test-item">
                        <h3>TC-LEAK-04</h3>
                        <p>User-Agent ä¸€è‡´æ€§ (ç„¡æ³•åœ¨ç€è¦½å™¨æ¸¬è©¦)</p>
                        <button disabled>éœ€ç”¨ PowerShell æ¸¬è©¦</button>
                        <div class="result warning" style="display:block;">
                            âš ï¸ ç€è¦½å™¨ç„¡æ³•ä¿®æ”¹ User-Agentï¼Œè«‹ä½¿ç”¨ PowerShell è…³æœ¬æ¸¬è©¦
                        </div>
                    </div>
                </div>
            </div>

            <!-- çˆ¬èŸ²é˜²è­·æ¸¬è©¦ -->
            <div class="test-section">
                <h2>ğŸ¤– çˆ¬èŸ²é˜²è­·æ¸¬è©¦ (3 é …)</h2>
                <div class="test-grid">
                    <div class="test-item">
                        <h3>TC-BOT-03</h3>
                        <p>é«˜é »ç‡è«‹æ±‚æ¸¬è©¦ (30 æ¬¡)</p>
                        <button onclick="testRateLimit()">åŸ·è¡Œæ¸¬è©¦</button>
                        <div id="result-bot-03" class="result"></div>
                    </div>

                    <div class="test-item">
                        <h3>TC-BOT-04</h3>
                        <p>Token ç”Ÿæˆé€Ÿç‡é™åˆ¶ (20 æ¬¡)</p>
                        <button onclick="testTokenRateLimit()">åŸ·è¡Œæ¸¬è©¦</button>
                        <div id="result-bot-04" class="result"></div>
                    </div>

                    <div class="test-item">
                        <h3>TC-BOT-06</h3>
                        <p>Honeypot é™·é˜±æ¬„ä½</p>
                        <button onclick="testHoneypot()">åŸ·è¡Œæ¸¬è©¦</button>
                        <div id="result-bot-06" class="result"></div>
                    </div>
                </div>
            </div>

            <!-- æ¸¬è©¦æ‘˜è¦ -->
            <div class="summary">
                <h2>ğŸ“Š æ¸¬è©¦æ‘˜è¦</h2>
                <div class="stats">
                    <div class="stat-item">
                        <span class="number" id="totalTests">0</span>
                        <span class="label">ç¸½æ¸¬è©¦æ•¸</span>
                    </div>
                    <div class="stat-item">
                        <span class="number" id="passedTests">0</span>
                        <span class="label">âœ… é€šé</span>
                    </div>
                    <div class="stat-item">
                        <span class="number" id="failedTests">0</span>
                        <span class="label">âŒ å¤±æ•—</span>
                    </div>
                    <div class="stat-item">
                        <span class="number" id="passRate">0%</span>
                        <span class="label">é€šéç‡</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        let currentToken = null;
        let testStats = { total: 0, passed: 0, failed: 0 };

        // æ›´æ–°æ¸¬è©¦çµ±è¨ˆ
        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
            const passRate = testStats.total > 0 
                ? Math.round((testStats.passed / testStats.total) * 100) 
                : 0;
            document.getElementById('passRate').textContent = passRate + '%';
        }

        // é¡¯ç¤ºçµæœ
        function showResult(elementId, success, message) {
            const element = document.getElementById(elementId);
            element.className = 'result ' + (success ? 'success' : 'error');
            element.textContent = (success ? 'âœ… ' : 'âŒ ') + message;
            
            testStats.total++;
            if (success) testStats.passed++;
            else testStats.failed++;
            updateStats();
        }

        // å–å¾— Token
        async function getToken() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/token`);
                const token = response.headers.get('X-CSRF-Token');
                
                if (token) {
                    currentToken = token;
                    document.getElementById('currentToken').textContent = token;
                    document.getElementById('tokenDisplay').style.display = 'block';
                    alert('âœ… Token å–å¾—æˆåŠŸï¼');
                } else {
                    alert('âŒ ç„¡æ³•å–å¾— Token');
                }
            } catch (error) {
                alert('âŒ éŒ¯èª¤: ' + error.message);
            }
        }

        // TC-CSRF-01: ç„¡ Token çš„è«‹æ±‚
        async function testNoToken() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/protected`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: 'test' })
                });
                
                const passed = response.status === 401;
                showResult('result-csrf-01', passed, 
                    passed ? 'PASS - æ­£ç¢ºæ‹’çµ•ç„¡ Token è«‹æ±‚ (401)' 
                           : `FAIL - é æœŸ 401ï¼Œå¯¦éš› ${response.status}`);
            } catch (error) {
                showResult('result-csrf-01', false, 'ERROR - ' + error.message);
            }
        }

        // TC-CSRF-02: å½é€  Token çš„è«‹æ±‚
        async function testFakeToken() {
            try {
                const fakeToken = crypto.randomUUID();
                const response = await fetch(`${API_BASE_URL}/api/protected`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': fakeToken
                    },
                    body: JSON.stringify({ data: 'test' })
                });
                
                const passed = response.status === 401;
                showResult('result-csrf-02', passed, 
                    passed ? 'PASS - æ­£ç¢ºæ‹’çµ•å‡ Token (401)' 
                           : `FAIL - é æœŸ 401ï¼Œå¯¦éš› ${response.status}`);
            } catch (error) {
                showResult('result-csrf-02', false, 'ERROR - ' + error.message);
            }
        }

        // TC-CSRF-03: éæœŸ Token çš„è«‹æ±‚
        async function testExpiredToken() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> ç­‰å¾… 6 ç§’...';
                
                const tokenResponse = await fetch(`${API_BASE_URL}/api/token`);
                const token = tokenResponse.headers.get('X-CSRF-Token');
                
                await new Promise(resolve => setTimeout(resolve, 6000));
                
                const response = await fetch(`${API_BASE_URL}/api/protected`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': token
                    },
                    body: JSON.stringify({ data: 'test' })
                });
                
                const passed = response.status === 401;
                showResult('result-csrf-03', passed, 
                    passed ? 'PASS - æ­£ç¢ºæ‹’çµ•éæœŸ Token (401)' 
                           : `FAIL - é æœŸ 401ï¼Œå¯¦éš› ${response.status}`);
                
                btn.disabled = false;
                btn.textContent = 'åŸ·è¡Œæ¸¬è©¦';
            } catch (error) {
                showResult('result-csrf-03', false, 'ERROR - ' + error.message);
                event.target.disabled = false;
                event.target.textContent = 'åŸ·è¡Œæ¸¬è©¦';
            }
        }

        // TC-CSRF-04: é‡è¤‡ä½¿ç”¨ Token
        async function testReusedToken() {
            try {
                const tokenResponse = await fetch(`${API_BASE_URL}/api/token`);
                const token = tokenResponse.headers.get('X-CSRF-Token');
                
                const response1 = await fetch(`${API_BASE_URL}/api/protected`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': token
                    },
                    body: JSON.stringify({ data: 'test' })
                });
                
                const response2 = await fetch(`${API_BASE_URL}/api/protected`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': token
                    },
                    body: JSON.stringify({ data: 'test' })
                });
                
                const passed = response1.status === 200 && response2.status === 401;
                showResult('result-csrf-04', passed, 
                    passed ? 'PASS - ç¬¬1æ¬¡æˆåŠŸï¼Œç¬¬2æ¬¡æ‹’çµ•' 
                           : `FAIL - ç¬¬1æ¬¡:${response1.status}, ç¬¬2æ¬¡:${response2.status}`);
            } catch (error) {
                showResult('result-csrf-04', false, 'ERROR - ' + error.message);
            }
        }

        // TC-CSRF-05: CORS æ”¿ç­–æª¢æŸ¥
        async function testCORS() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/token`);
                const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                
                const passed = corsHeader !== '*';
                showResult('result-csrf-05', passed, 
                    passed ? 'PASS - CORS æœªå…è¨±ä»»æ„ä¾†æº' 
                           : 'FAIL - âš ï¸ CORS è¨­å®šç‚º AllowAnyOriginï¼Œæœ‰å®‰å…¨é¢¨éšª');
            } catch (error) {
                showResult('result-csrf-05', false, 'ERROR - ' + error.message);
            }
        }

        // TC-CSRF-06 & 07: Referer/Origin (ç€è¦½å™¨é™åˆ¶)
        function testReferer() {
            showResult('result-csrf-06', false, 
                'SKIP - ç€è¦½å™¨ä¸å…è¨±ä¿®æ”¹ Referer Headerï¼Œè«‹ç”¨ PowerShell æ¸¬è©¦');
        }

        function testOrigin() {
            showResult('result-csrf-07', false, 
                'SKIP - ç€è¦½å™¨ä¸å…è¨±ä¿®æ”¹ Origin Headerï¼Œè«‹ç”¨ PowerShell æ¸¬è©¦');
        }

        // TC-LEAK-02: Token æ‰¹æ¬¡è«‹æ±‚
        async function testBatchRequest() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> åŸ·è¡Œä¸­...';
                
                const tokenResponse = await fetch(`${API_BASE_URL}/api/token`);
                const token = tokenResponse.headers.get('X-CSRF-Token');
                
                let successCount = 0;
                for (let i = 0; i < 10; i++) {
                    const response = await fetch(`${API_BASE_URL}/api/protected`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': token
                        },
                        body: JSON.stringify({ data: 'test' })
                    });
                    if (response.status === 200) successCount++;
                }
                
                const passed = successCount <= 1;
                showResult('result-leak-02', passed, 
                    passed ? `PASS - åƒ… ${successCount} æ¬¡æˆåŠŸ (æ¬¡æ•¸é™åˆ¶ç”Ÿæ•ˆ)` 
                           : `FAIL - ${successCount} æ¬¡æˆåŠŸ (æ‡‰åƒ… 1 æ¬¡)`);
                
                btn.disabled = false;
                btn.textContent = 'åŸ·è¡Œæ¸¬è©¦';
            } catch (error) {
                showResult('result-leak-02', false, 'ERROR - ' + error.message);
                event.target.disabled = false;
                event.target.textContent = 'åŸ·è¡Œæ¸¬è©¦';
            }
        }

        // TC-BOT-03: é«˜é »ç‡è«‹æ±‚
        async function testRateLimit() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> ç™¼é€ 30 æ¬¡è«‹æ±‚...';
                
                let rateLimited = false;
                for (let i = 0; i < 30; i++) {
                    const tokenResponse = await fetch(`${API_BASE_URL}/api/token`);
                    const token = tokenResponse.headers.get('X-CSRF-Token');
                    
                    const response = await fetch(`${API_BASE_URL}/api/protected`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': token
                        },
                        body: JSON.stringify({ data: 'test' })
                    });
                    
                    if (response.status === 429) {
                        rateLimited = true;
                        break;
                    }
                }
                
                showResult('result-bot-03', rateLimited, 
                    rateLimited ? 'PASS - è§¸ç™¼é€Ÿç‡é™åˆ¶ (429)' 
                                : 'FAIL - âš ï¸ æœªå¯¦ä½œé€Ÿç‡é™åˆ¶');
                
                btn.disabled = false;
                btn.textContent = 'åŸ·è¡Œæ¸¬è©¦';
            } catch (error) {
                showResult('result-bot-03', false, 'ERROR - ' + error.message);
                event.target.disabled = false;
                event.target.textContent = 'åŸ·è¡Œæ¸¬è©¦';
            }
        }

        // TC-BOT-04: Token ç”Ÿæˆé€Ÿç‡é™åˆ¶
        async function testTokenRateLimit() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> ç™¼é€ 20 æ¬¡è«‹æ±‚...';
                
                let rateLimited = false;
                for (let i = 0; i < 20; i++) {
                    const response = await fetch(`${API_BASE_URL}/api/token`);
                    if (response.status === 429) {
                        rateLimited = true;
                        break;
                    }
                }
                
                showResult('result-bot-04', rateLimited, 
                    rateLimited ? 'PASS - è§¸ç™¼ Token ç”Ÿæˆé€Ÿç‡é™åˆ¶ (429)' 
                                : 'FAIL - âš ï¸ æœªå¯¦ä½œ Token ç”Ÿæˆé€Ÿç‡é™åˆ¶');
                
                btn.disabled = false;
                btn.textContent = 'åŸ·è¡Œæ¸¬è©¦';
            } catch (error) {
                showResult('result-bot-04', false, 'ERROR - ' + error.message);
                event.target.disabled = false;
                event.target.textContent = 'åŸ·è¡Œæ¸¬è©¦';
            }
        }

        // TC-BOT-06: Honeypot é™·é˜±æ¬„ä½
        async function testHoneypot() {
            try {
                const tokenResponse = await fetch(`${API_BASE_URL}/api/token`);
                const token = tokenResponse.headers.get('X-CSRF-Token');
                
                const response = await fetch(`${API_BASE_URL}/api/protected`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': token
                    },
                    body: JSON.stringify({ 
                        data: 'test', 
                        hidden_field: 'bot_detected' 
                    })
                });
                
                const passed = response.status === 403;
                showResult('result-bot-06', passed, 
                    passed ? 'PASS - æ­£ç¢ºè­˜åˆ¥ Honeypot (403)' 
                           : 'FAIL - âš ï¸ æœªå¯¦ä½œ Honeypot æ©Ÿåˆ¶');
            } catch (error) {
                showResult('result-bot-06', false, 'ERROR - ' + error.message);
            }
        }
    </script>
</body>
</html>
