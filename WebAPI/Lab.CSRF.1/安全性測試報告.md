# CSRF å®‰å…¨æ”¹å–„æ¸¬è©¦å ±å‘Š

## ğŸ“Š å¯¦ä½œå®Œæˆæ‘˜è¦

æ‰€æœ‰æ”¹å–„æ­¥é©Ÿå·²å®Œæˆï¼š

- âœ… **æ­¥é©Ÿ 1**ï¼šæ›´æ–° Program.cs - å•Ÿç”¨ Session èˆ‡ç›¸é—œæœå‹™
- âœ… **æ­¥é©Ÿ 2**ï¼šä¿®æ”¹ CsrfTokenService - å¯¦ä½œ Token èˆ‡ Session ç¶å®š
- âœ… **æ­¥é©Ÿ 3**ï¼šæª¢æŸ¥å‰ç«¯æ¸¬è©¦é é¢ï¼ˆå·²åŒ…å« credentials: 'include'ï¼‰
- âœ… **æ­¥é©Ÿ 4**ï¼šå»ºç½®æˆåŠŸï¼ˆ0 å€‹è­¦å‘Šï¼Œ0 å€‹éŒ¯èª¤ï¼‰

---

## ğŸ”§ ä¸»è¦è®Šæ›´

### 1. Program.cs
- âœ… è¨»å†Š `AddHttpContextAccessor()`
- âœ… å°‡ `AddMemoryCache()` æ”¹ç‚º `AddDistributedMemoryCache()`
- âœ… å•Ÿç”¨ Session ä¸¦è¨­å®šå®‰å…¨ Cookie å±¬æ€§ï¼š
  - `HttpOnly = true` - é˜²æ­¢ JavaScript è®€å–
  - `SecurePolicy = Always` - åªåœ¨ HTTPS ä¸‹å‚³é€
  - `SameSite = Strict` - é˜²æ­¢ CSRF
- âœ… åœ¨ middleware pipeline åŠ å…¥ `UseSession()`

### 2. CsrfTokenService.cs
- âœ… å°‡ `IMemoryCache` æ”¹ç‚º `IDistributedCache`
- âœ… æ³¨å…¥ `IHttpContextAccessor`
- âœ… `GenerateToken()`: Token èˆ‡ Session ID ç¶å®šï¼ˆKey: `csrf:{sessionId}:{token}`ï¼‰
- âœ… `ValidateToken()`: é©—è­‰ Token æ˜¯å¦èˆ‡ç•¶å‰ Session é…å°
- âœ… `RemoveToken()`: ä½¿ç”¨æ­£ç¢ºçš„ Cache Key åˆªé™¤
- âœ… åŠ å…¥ Session ä¸å­˜åœ¨æ™‚çš„éŒ¯èª¤è™•ç†

---

## ğŸ§ª æ¸¬è©¦æ–¹æ³•

### æ–¹æ³• 1ï¼šä½¿ç”¨å‰ç«¯æ¸¬è©¦é é¢ï¼ˆæ¨è–¦ï¼‰

1. **å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼**ï¼š
   ```bash
   cd "C:\Users\LaLa\Documents\lab\sample.dotblog\WebAPI\Lab.CSRF.1\Lab.CSRF.WebApi"
   dotnet run
   ```

2. **é–‹å•Ÿæ¸¬è©¦é é¢**ï¼š
   - ç€è¦½å™¨è¨ªå•ï¼š`https://localhost:7001/index.html`

3. **åŸ·è¡Œæ¸¬è©¦**ï¼š
   - âœ… é»æ“Šã€Œå–å¾— CSRF Tokenã€â†’ æ‡‰è©²æˆåŠŸ
   - âœ… é»æ“Šã€Œé€å‡º POST è«‹æ±‚ã€â†’ æ‡‰è©²æˆåŠŸ
   - âœ… é»æ“Šã€Œæ¸¬è©¦ä¸å¸¶ Tokenï¼ˆæ‡‰è©²å¤±æ•—ï¼‰ã€â†’ æ‡‰è©²æ”¶åˆ° 403 éŒ¯èª¤
   - âœ… æ¸¬è©¦ PUT å’Œ DELETE ç«¯é» â†’ æ‡‰è©²æˆåŠŸ
   - âœ… æ¸¬è©¦å…¬é–‹ç«¯é» â†’ æ‡‰è©²æˆåŠŸï¼ˆä¸éœ€è¦ Tokenï¼‰

4. **æª¢æŸ¥ Session Cookie**ï¼š
   - æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·
   - åˆ‡æ›åˆ°ã€Œæ‡‰ç”¨ç¨‹å¼ã€æˆ–ã€ŒApplicationã€é ç±¤
   - æŸ¥çœ‹ Cookies â†’ `https://localhost:7001`
   - ç¢ºèªæœ‰ä¸€å€‹åç‚º `.AspNetCore.Session` çš„ Cookie
   - ç¢ºèª Cookie å±¬æ€§ï¼š
     - âœ… HttpOnly: true
     - âœ… Secure: true
     - âœ… SameSite: Strict

### æ–¹æ³• 2ï¼šä½¿ç”¨ curl æ¸¬è©¦æ”»æ“Šæƒ…å¢ƒ

#### æ¸¬è©¦ 1ï¼šæ”»æ“Šè€…å˜—è©¦ç›´æ¥å–å¾—ä¸¦ä½¿ç”¨ Tokenï¼ˆæ‡‰è©²å¤±æ•—ï¼‰

```bash
# æ­¥é©Ÿ 1ï¼šå–å¾— Tokenï¼ˆé€™æœƒå»ºç«‹ä¸€å€‹æ–°çš„ Sessionï¼‰
curl -k -c cookies.txt https://localhost:7001/api/csrf/token

# æ­¥é©Ÿ 2ï¼šå˜—è©¦ä½¿ç”¨ Tokenï¼ˆä½†æ²’æœ‰ Session Cookieï¼Œæ‡‰è©²å¤±æ•—ï¼‰
curl -k -X POST https://localhost:7001/api/csrf/test \
  -H "Content-Type: application/json" \
  -H "X-CSRF-Token: <å¾ä¸Šä¸€æ­¥å–å¾—çš„ token>" \
  -d '{"message":"æ”»æ“Š"}'

# é æœŸçµæœï¼š403 Forbidden
# éŒ¯èª¤è¨Šæ¯ï¼šToken ç„¡æ•ˆæˆ–å·²éæœŸ
```

**ç‚ºä»€éº¼æœƒå¤±æ•—ï¼Ÿ**
- æ”»æ“Šè€…åªå–å¾—äº† Tokenï¼Œä½†æ²’æœ‰æ­£ç¢ºçš„ Session Cookie
- Token ç¶å®šåˆ°ç‰¹å®šçš„ Session IDï¼Œå¿…é ˆé…å°æ‰èƒ½é€šéé©—è­‰

#### æ¸¬è©¦ 2ï¼šæ­£å¸¸ä½¿ç”¨ï¼ˆæ‡‰è©²æˆåŠŸï¼‰

```bash
# æ­¥é©Ÿ 1ï¼šå–å¾— Tokenï¼ˆå„²å­˜ Cookieï¼‰
curl -k -c cookies.txt https://localhost:7001/api/csrf/token

# æ­¥é©Ÿ 2ï¼šä½¿ç”¨ Token å’Œ Cookieï¼ˆæ‡‰è©²æˆåŠŸï¼‰
curl -k -b cookies.txt -X POST https://localhost:7001/api/csrf/test \
  -H "Content-Type: application/json" \
  -H "X-CSRF-Token: <å¾ä¸Šä¸€æ­¥å–å¾—çš„ token>" \
  -d '{"message":"æ­£å¸¸è«‹æ±‚"}'

# é æœŸçµæœï¼š200 OK
# æˆåŠŸè¨Šæ¯ï¼šCSRF é©—è­‰é€šé
```

**ç‚ºä»€éº¼æœƒæˆåŠŸï¼Ÿ**
- `-c cookies.txt` å„²å­˜äº† Session Cookie
- `-b cookies.txt` åœ¨å¾ŒçºŒè«‹æ±‚ä¸­å¸¶ä¸Š Session Cookie
- Token å’Œ Session ID é…å°ï¼Œé©—è­‰é€šé

#### æ¸¬è©¦ 3ï¼šç«Šå– Token ä½†æ²’æœ‰ Sessionï¼ˆæ‡‰è©²å¤±æ•—ï¼‰

```bash
# æƒ…å¢ƒï¼šæ”»æ“Šè€…ç«Šå–åˆ° Tokenï¼Œä½†æ²’æœ‰å—å®³è€…çš„ Session Cookie

# æ”»æ“Šè€…è‡ªå·±å»ºç«‹ä¸€å€‹ Session
curl -k -c attacker-cookies.txt https://localhost:7001/api/csrf/token

# æ”»æ“Šè€…ä½¿ç”¨ç«Šå–åˆ°çš„ Tokenï¼Œä½†ä½¿ç”¨è‡ªå·±çš„ Session
curl -k -b attacker-cookies.txt -X POST https://localhost:7001/api/csrf/test \
  -H "Content-Type: application/json" \
  -H "X-CSRF-Token: <å—å®³è€…çš„ token>" \
  -d '{"message":"æ”»æ“Š"}'

# é æœŸçµæœï¼š403 Forbidden
# éŒ¯èª¤è¨Šæ¯ï¼šToken ç„¡æ•ˆæˆ–å·²éæœŸ
```

**ç‚ºä»€éº¼æœƒå¤±æ•—ï¼Ÿ**
- Token ç¶å®šåˆ°å—å®³è€…çš„ Session ID
- æ”»æ“Šè€…çš„ Session ID èˆ‡ Token ä¸é…å°
- é©—è­‰å¤±æ•—

---

## ğŸ“‹ æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### åŠŸèƒ½æ€§æ¸¬è©¦
- [ ] æ­£å¸¸å–å¾— Token â†’ æˆåŠŸ
- [ ] ä½¿ç”¨æœ‰æ•ˆ Token ç™¼é€ POST è«‹æ±‚ â†’ æˆåŠŸ
- [ ] ä½¿ç”¨æœ‰æ•ˆ Token ç™¼é€ PUT è«‹æ±‚ â†’ æˆåŠŸ
- [ ] ä½¿ç”¨æœ‰æ•ˆ Token ç™¼é€ DELETE è«‹æ±‚ â†’ æˆåŠŸ
- [ ] ä¸å¸¶ Token ç™¼é€è«‹æ±‚ â†’ å¤±æ•—ï¼ˆ403ï¼‰
- [ ] å…¬é–‹ç«¯é»ä¸éœ€è¦ Token â†’ æˆåŠŸ

### å®‰å…¨æ€§æ¸¬è©¦
- [ ] æ”»æ“Šè€…ç›´æ¥å–å¾— Token ä½†æ²’æœ‰ Session Cookie â†’ å¤±æ•—ï¼ˆ403ï¼‰
- [ ] æ”»æ“Šè€…ç«Šå– Token ä½†ä½¿ç”¨è‡ªå·±çš„ Session â†’ å¤±æ•—ï¼ˆ403ï¼‰
- [ ] Session Cookie è¨­å®š HttpOnly â†’ âœ…
- [ ] Session Cookie è¨­å®š Secure â†’ âœ…
- [ ] Session Cookie è¨­å®š SameSite=Strict â†’ âœ…

### æ•ˆèƒ½æ¸¬è©¦
- [ ] Token éæœŸå¾Œè‡ªå‹•å¤±æ•ˆï¼ˆ30 åˆ†é˜ï¼‰
- [ ] Session éæœŸå¾Œ Token ä¹Ÿå¤±æ•ˆ

---

## ğŸ”’ å®‰å…¨æ€§æå‡é©—è­‰

### æ”¹å–„å‰ï¼ˆä¸å®‰å…¨ï¼‰
```javascript
// âŒ æ”»æ“Šè€…å¯ä»¥é€™æ¨£åšï¼š
const response = await fetch('https://localhost:7001/api/csrf/token');
const { token } = await response.json();

// ä½¿ç”¨ Token ç™¼é€æƒ¡æ„è«‹æ±‚
await fetch('https://localhost:7001/api/csrf/test', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': token  // âŒ å¯ä»¥æˆåŠŸ
    },
    body: JSON.stringify({ message: 'æƒ¡æ„è«‹æ±‚' })
});
// çµæœï¼šæˆåŠŸ âŒ
```

### æ”¹å–„å¾Œï¼ˆå®‰å…¨ï¼‰
```javascript
// âœ… æ”»æ“Šè€…å˜—è©¦åŒæ¨£çš„æ”»æ“Šï¼š
const response = await fetch('https://localhost:7001/api/csrf/token');
const { token } = await response.json();

// ä½¿ç”¨ Token ç™¼é€æƒ¡æ„è«‹æ±‚
await fetch('https://localhost:7001/api/csrf/test', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': token
    },
    // âŒ æ²’æœ‰ Session Cookieï¼Œç„¡æ³•é€šéé©—è­‰
    body: JSON.stringify({ message: 'æƒ¡æ„è«‹æ±‚' })
});
// çµæœï¼š403 Forbidden âœ…
// éŒ¯èª¤ï¼šToken ç„¡æ•ˆæˆ–å·²éæœŸ
```

---

## ğŸ“Š æ”¹å–„æ•ˆæœå°ç…§è¡¨

| æ”»æ“Šå ´æ™¯ | æ”¹å–„å‰ | æ”¹å–„å¾Œ |
|---------|--------|--------|
| æ”»æ“Šè€…ç›´æ¥å–å¾— Token | âŒ å¯è¡Œ | âœ… ç„¡æ•ˆï¼ˆæ²’æœ‰å°æ‡‰ Sessionï¼‰ |
| æ”»æ“Šè€…ç«Šå– Cookie | N/A | âœ… é˜²è­·ï¼ˆHttpOnly + Secureï¼‰ |
| è·¨ç«™æ”»æ“Š | âš ï¸ éƒ¨åˆ†é˜²è­· | âœ… å®Œå…¨é˜²è­·ï¼ˆSameSiteï¼‰ |
| è‡ªå‹•åŒ–æ”»æ“Š | âŒ å¯è¡Œ | âœ… é˜²è­·ï¼ˆéœ€è¦æœ‰æ•ˆ Sessionï¼‰ |
| Token é‡è¤‡ä½¿ç”¨ | âš ï¸ å¯èƒ½ | âœ… ç¶å®š Sessionï¼ˆä¸åŒ Session ç„¡æ³•ä½¿ç”¨ï¼‰ |

---

## ğŸ¯ çµè«–

### âœ… å·²å¯¦ä½œçš„å®‰å…¨æ©Ÿåˆ¶

1. **Token èˆ‡ Session ç¶å®š**
   - Token åªèƒ½åœ¨å»ºç«‹å®ƒçš„ Session ä¸­ä½¿ç”¨
   - æ”»æ“Šè€…ç„¡æ³•è·¨ Session ä½¿ç”¨ Token

2. **Session Cookie å®‰å…¨è¨­å®š**
   - HttpOnlyï¼šé˜²æ­¢ XSS æ”»æ“Šç«Šå– Cookie
   - Secureï¼šåªåœ¨ HTTPS ä¸‹å‚³é€
   - SameSite=Strictï¼šé˜²æ­¢ CSRF æ”»æ“Š

3. **å®Œæ•´çš„éŒ¯èª¤è™•ç†**
   - Session ä¸å­˜åœ¨æ™‚æ‹‹å‡ºéŒ¯èª¤
   - Token é©—è­‰å¤±æ•—æ™‚è¨˜éŒ„æ—¥èªŒ
   - æ¸…æ¥šçš„éŒ¯èª¤è¨Šæ¯ï¼ˆä¸æ´©æ¼æ•æ„Ÿè³‡è¨Šï¼‰

4. **ç¬¦åˆ OWASP æœ€ä½³å¯¦è¸**
   - Token èˆ‡ä½¿ç”¨è€…èº«ä»½ç¶å®š
   - é›™é‡é©—è­‰æ©Ÿåˆ¶ï¼ˆToken + Sessionï¼‰
   - å®‰å…¨çš„ Cookie è¨­å®š

### ğŸ“ ä½¿ç”¨èªªæ˜

#### å‰ç«¯é–‹ç™¼è€…æ³¨æ„äº‹é …

**å¿…é ˆåœ¨æ‰€æœ‰è«‹æ±‚ä¸­åŠ å…¥ `credentials: 'include'`**ï¼š

```javascript
// âœ… æ­£ç¢º
fetch('https://api.example.com/api/csrf/token', {
    credentials: 'include'  // å¿…é ˆåŠ ä¸Š
});

// âŒ éŒ¯èª¤ï¼ˆSession Cookie ä¸æœƒå‚³é€ï¼‰
fetch('https://api.example.com/api/csrf/token');
```

#### å¾Œç«¯é–‹ç™¼è€…æ³¨æ„äº‹é …

**CORS å¿…é ˆè¨­å®š `AllowCredentials()`**ï¼š

```csharp
// âœ… å·²è¨­å®š
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowFrontend", policy =>
    {
        policy.WithOrigins("http://localhost:5173")
            .AllowAnyMethod()
            .AllowAnyHeader()
            .AllowCredentials()  // âœ… å¿…é ˆå•Ÿç”¨
            .WithExposedHeaders("X-CSRF-Token");
    });
});
```

### ğŸš€ ä¸‹ä¸€æ­¥å»ºè­°

1. **ç”Ÿç”¢ç’°å¢ƒ**ï¼š
   - ä½¿ç”¨ Redis å„²å­˜ Sessionï¼ˆè€Œé In-Memoryï¼‰
   - è¨­å®šé©ç•¶çš„ Session éæœŸæ™‚é–“
   - å¯¦ä½œ Session æ¸…ç†æ©Ÿåˆ¶

2. **é€²éšå®‰å…¨**ï¼š
   - åŠ å…¥ Rate Limiting é˜²æ­¢æš´åŠ›æ”»æ“Š
   - å¯¦ä½œä½¿ç”¨è€…èªè­‰ï¼ˆæ–¹æ¡ˆ 2ï¼‰
   - è¨˜éŒ„å®‰å…¨äº‹ä»¶æ—¥èªŒ

3. **ç›£æ§**ï¼š
   - ç›£æ§ CSRF Token é©—è­‰å¤±æ•—æ¬¡æ•¸
   - è¿½è¹¤å¯ç–‘çš„è«‹æ±‚æ¨¡å¼
   - è‡ªå‹•å°é–å¯ç–‘ IP

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [CSRFå®‰å…¨æ”¹å–„å¯¦ä½œè¨ˆç•«.md](./CSRFå®‰å…¨æ”¹å–„å¯¦ä½œè¨ˆç•«.md) - å®Œæ•´å¯¦ä½œèªªæ˜
- [è³‡å®‰æ¼æ´åˆ†æèˆ‡æ”¹å–„æ–¹æ¡ˆ.md](./è³‡å®‰æ¼æ´åˆ†æèˆ‡æ”¹å–„æ–¹æ¡ˆ.md) - åŸå§‹å®‰å…¨åˆ†æ
- [OWASP CSRF é˜²è­·æŒ‡å—](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)

---

## âœ… å¯¦ä½œå®Œæˆç¢ºèª

- [x] æ‰€æœ‰ç¨‹å¼ç¢¼ä¿®æ”¹å®Œæˆ
- [x] å»ºç½®æˆåŠŸï¼ˆ0 å€‹è­¦å‘Šï¼Œ0 å€‹éŒ¯èª¤ï¼‰
- [x] Session æ©Ÿåˆ¶æ­£ç¢ºå•Ÿç”¨
- [x] Token èˆ‡ Session ç¶å®šå¯¦ä½œå®Œæˆ
- [x] Cookie å®‰å…¨å±¬æ€§æ­£ç¢ºè¨­å®š
- [x] å‰ç«¯æ¸¬è©¦é é¢æ”¯æ´ Session Cookie
- [x] æ¸¬è©¦æ–‡ä»¶å®Œæ•´

**å°ˆæ¡ˆå·²æº–å‚™å¥½é€²è¡Œæ¸¬è©¦ï¼** ğŸ‰
