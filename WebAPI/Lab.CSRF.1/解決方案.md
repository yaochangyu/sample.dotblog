# ç¢ºä¿ API åªèƒ½è¢«ç•¶å‰é é¢å‘¼å«çš„è§£æ±ºæ–¹æ¡ˆ

## å•é¡Œæè¿°

å¦‚ä½•ç¢ºä¿ Web API åªæœƒè¢«ç•¶å‰çš„é é¢ä½¿ç”¨ï¼Œé˜²æ­¢å…¶ä»–ç¶²ç«™æ¿«ç”¨æˆ–ç™¼èµ· CSRFï¼ˆè·¨ç«™è«‹æ±‚å½é€ ï¼‰æ”»æ“Šï¼Ÿ

---

## è§£æ±ºæ–¹æ¡ˆæ¦‚è¿°

å¯¦ä½œå¤šå±¤æ¬¡çš„å®‰å…¨é˜²è­·æ©Ÿåˆ¶ï¼š

1. **Anti-CSRF Token æ©Ÿåˆ¶** - ä¸»è¦é˜²è­·
2. **CORSï¼ˆè·¨åŸŸè³‡æºå…±äº«ï¼‰é™åˆ¶** - é™åˆ¶ä¾†æºç¶²åŸŸ
3. **è‡ªè¨‚ Header é©—è­‰** - åˆ©ç”¨ç€è¦½å™¨åŒæºæ”¿ç­–
4. **HTTP Method æª¢æŸ¥** - åªé©—è­‰ä¸å®‰å…¨çš„æ“ä½œ

---

## æ–¹æ³• 1ï¼šAnti-CSRF Token æ©Ÿåˆ¶ï¼ˆæ¨è–¦ï¼‰

### åŸç†

- å‰ç«¯é é¢è¼‰å…¥æ™‚å‘ä¼ºæœå™¨è«‹æ±‚ä¸€å€‹å”¯ä¸€çš„ Token
- æ¯æ¬¡å¯«å…¥æ“ä½œï¼ˆPOST/PUT/DELETEï¼‰éƒ½å¿…é ˆåœ¨ Header ä¸­å¸¶ä¸Šé€™å€‹ Token
- ä¼ºæœå™¨é©—è­‰ Token æ˜¯å¦æœ‰æ•ˆ
- æƒ¡æ„ç¶²ç«™ç„¡æ³•å–å¾—é€™å€‹ Tokenï¼Œå› æ­¤ç„¡æ³•ç™¼é€æœ‰æ•ˆè«‹æ±‚

### å¯¦ä½œæ­¥é©Ÿ

#### 1. å»ºç«‹ Token æœå‹™ä»‹é¢

```csharp
namespace Lab.CSRF.WebApi.Services;

public interface ICsrfTokenService
{
    string GenerateToken();
    bool ValidateToken(string token);
    void RemoveToken(string token);
}
```

#### 2. å¯¦ä½œ Token æœå‹™

```csharp
using System.Security.Cryptography;
using Microsoft.Extensions.Caching.Memory;

namespace Lab.CSRF.WebApi.Services;

public class CsrfTokenService : ICsrfTokenService
{
    private readonly IMemoryCache _cache;
    private readonly TimeSpan _tokenExpiration = TimeSpan.FromMinutes(30);

    public CsrfTokenService(IMemoryCache cache)
    {
        _cache = cache;
    }

    public string GenerateToken()
    {
        // ä½¿ç”¨å¯†ç¢¼å­¸å®‰å…¨çš„éš¨æ©Ÿæ•¸ç”¢ç”Ÿå™¨
        var randomBytes = new byte[32];
        using var rng = RandomNumberGenerator.Create();
        rng.GetBytes(randomBytes);
        var token = Convert.ToBase64String(randomBytes);

        // å„²å­˜åˆ°å¿«å–ï¼Œè¨­å®šéæœŸæ™‚é–“
        _cache.Set(token, true, _tokenExpiration);

        return token;
    }

    public bool ValidateToken(string token)
    {
        if (string.IsNullOrWhiteSpace(token))
            return false;

        return _cache.TryGetValue(token, out _);
    }

    public void RemoveToken(string token)
    {
        _cache.Remove(token);
    }
}
```

#### 3. å»ºç«‹é©—è­‰ Filter

```csharp
using Lab.CSRF.WebApi.Services;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;

namespace Lab.CSRF.WebApi.Filters;

public class ValidateCsrfTokenAttribute : ActionFilterAttribute
{
    private const string CsrfTokenHeaderName = "X-CSRF-Token";

    public override void OnActionExecuting(ActionExecutingContext context)
    {
        var httpMethod = context.HttpContext.Request.Method;

        // åªé©—è­‰å¯«å…¥æ“ä½œï¼ˆPOST/PUT/DELETE/PATCHï¼‰
        if (httpMethod is "GET" or "HEAD" or "OPTIONS" or "TRACE")
        {
            base.OnActionExecuting(context);
            return;
        }

        var csrfTokenService = context.HttpContext.RequestServices
            .GetRequiredService<ICsrfTokenService>();

        // å¾ Header ä¸­å–å¾— Token
        if (!context.HttpContext.Request.Headers.TryGetValue(
            CsrfTokenHeaderName, out var tokenValue))
        {
            context.Result = new ObjectResult(new { error = "ç¼ºå°‘ CSRF Token" })
            {
                StatusCode = StatusCodes.Status403Forbidden
            };
            return;
        }

        // é©—è­‰ Token
        if (!csrfTokenService.ValidateToken(tokenValue.ToString()))
        {
            context.Result = new ObjectResult(new { error = "ç„¡æ•ˆçš„ CSRF Token" })
            {
                StatusCode = StatusCodes.Status403Forbidden
            };
            return;
        }

        base.OnActionExecuting(context);
    }
}
```

#### 4. è¨»å†Šæœå‹™ï¼ˆProgram.csï¼‰

```csharp
using Lab.CSRF.WebApi.Services;

var builder = WebApplication.CreateBuilder(args);

// è¨»å†Š Controllers
builder.Services.AddControllers();

// è¨»å†Š Memory Cache
builder.Services.AddMemoryCache();

// è¨»å†Š CSRF Token æœå‹™
builder.Services.AddScoped<ICsrfTokenService, CsrfTokenService>();
```

#### 5. å»ºç«‹ API ç«¯é»

```csharp
using Lab.CSRF.WebApi.Filters;
using Lab.CSRF.WebApi.Services;
using Microsoft.AspNetCore.Mvc;

namespace Lab.CSRF.WebApi.Controllers;

[ApiController]
[Route("api/[controller]")]
public class CsrfController : ControllerBase
{
    private readonly ICsrfTokenService _csrfTokenService;

    public CsrfController(ICsrfTokenService csrfTokenService)
    {
        _csrfTokenService = csrfTokenService;
    }

    // å–å¾— Token çš„ç«¯é»ï¼ˆä¸éœ€è¦é©—è­‰ï¼‰
    [HttpGet("token")]
    public IActionResult GetToken()
    {
        var token = _csrfTokenService.GenerateToken();
        return Ok(new { token, expiresIn = 1800 });
    }

    // éœ€è¦ä¿è­·çš„ç«¯é»ï¼ˆå¥—ç”¨é©—è­‰ï¼‰
    [HttpPost("data")]
    [ValidateCsrfToken]
    public IActionResult CreateData([FromBody] DataRequest request)
    {
        // ä½ çš„æ¥­å‹™é‚è¼¯
        return Ok(new { success = true, message = "è³‡æ–™å»ºç«‹æˆåŠŸ" });
    }

    [HttpPut("data/{id}")]
    [ValidateCsrfToken]
    public IActionResult UpdateData(int id, [FromBody] DataRequest request)
    {
        // ä½ çš„æ¥­å‹™é‚è¼¯
        return Ok(new { success = true, message = "è³‡æ–™æ›´æ–°æˆåŠŸ" });
    }

    [HttpDelete("data/{id}")]
    [ValidateCsrfToken]
    public IActionResult DeleteData(int id)
    {
        // ä½ çš„æ¥­å‹™é‚è¼¯
        return Ok(new { success = true, message = "è³‡æ–™åˆªé™¤æˆåŠŸ" });
    }
}
```

#### 6. å‰ç«¯æ•´åˆ

```javascript
// 1. é é¢è¼‰å…¥æ™‚å–å¾— Token
let csrfToken = null;

async function initializePage() {
    const response = await fetch('https://your-api.com/api/csrf/token');
    const data = await response.json();
    csrfToken = data.token;
}

// 2. ç™¼é€è«‹æ±‚æ™‚å¸¶ä¸Š Token
async function createData(message) {
    const response = await fetch('https://your-api.com/api/csrf/data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken  // å¿…é ˆå¸¶ä¸Š Token
        },
        body: JSON.stringify({ message })
    });

    return await response.json();
}

// åˆå§‹åŒ–
initializePage();
```

### å„ªé»

âœ… æœ‰æ•ˆé˜²æ­¢ CSRF æ”»æ“Š
âœ… å¯¦ä½œç°¡å–®æ¸…æ™°
âœ… Token æœ‰æ™‚æ•ˆæ€§
âœ… æƒ¡æ„ç¶²ç«™ç„¡æ³•å–å¾— Token

### ç¼ºé»

âš ï¸ éœ€è¦é¡å¤–çš„ HTTP è«‹æ±‚å–å¾— Token
âš ï¸ éœ€è¦å‰ç«¯é…åˆå¯¦ä½œ
âš ï¸ å–®ä¼ºæœå™¨ç’°å¢ƒéœ€æ³¨æ„å¿«å–åŒæ­¥ï¼ˆå»ºè­°ä½¿ç”¨ Redisï¼‰

---

## æ–¹æ³• 2ï¼šCORSï¼ˆè·¨åŸŸè³‡æºå…±äº«ï¼‰é™åˆ¶

### åŸç†

é€é CORS è¨­å®šï¼Œé™åˆ¶åªæœ‰ç‰¹å®šç¶²åŸŸå¯ä»¥å‘¼å« APIã€‚

### å¯¦ä½œæ­¥é©Ÿ

#### åœ¨ Program.cs ä¸­è¨­å®š CORS

```csharp
var builder = WebApplication.CreateBuilder(args);

// è¨­å®š CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowFrontend", policy =>
    {
        policy.WithOrigins("https://your-frontend.com")  // åªå…è¨±ä½ çš„å‰ç«¯ç¶²åŸŸ
            .AllowAnyMethod()
            .AllowAnyHeader()
            .AllowCredentials();
    });
});

var app = builder.Build();

// å•Ÿç”¨ CORS
app.UseCors("AllowFrontend");
```

### å„ªé»

âœ… é™åˆ¶ API åªèƒ½è¢«ç‰¹å®šç¶²åŸŸå‘¼å«
âœ… ç€è¦½å™¨è‡ªå‹•åŸ·è¡Œæª¢æŸ¥
âœ… è¨­å®šç°¡å–®

### ç¼ºé»

âš ï¸ åªèƒ½åœ¨ç€è¦½å™¨ç’°å¢ƒä¸­ç”Ÿæ•ˆ
âš ï¸ ç„¡æ³•é˜²æ­¢åŒæºæ”»æ“Š
âš ï¸ ä¸èƒ½å–®ç¨ä½œç‚º CSRF é˜²è­·

---

## æ–¹æ³• 3ï¼šè‡ªè¨‚ Header + CORS çµ„åˆ

### åŸç†

åˆ©ç”¨ç€è¦½å™¨çš„åŒæºæ”¿ç­–ï¼Œè·¨ç«™è«‹æ±‚ç„¡æ³•è¨­å®šè‡ªè¨‚ Headerã€‚

### å¯¦ä½œæ­¥é©Ÿ

#### 1. è¨­å®š CORS å…è¨±è‡ªè¨‚ Header

```csharp
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowFrontend", policy =>
    {
        policy.WithOrigins("https://your-frontend.com")
            .AllowAnyMethod()
            .AllowAnyHeader()
            .AllowCredentials()
            .WithExposedHeaders("X-Custom-Header");  // æš´éœ²è‡ªè¨‚ Header
    });
});
```

#### 2. å»ºç«‹ Middleware æª¢æŸ¥è‡ªè¨‚ Header

```csharp
public class CustomHeaderValidationMiddleware
{
    private readonly RequestDelegate _next;
    private const string RequiredHeader = "X-Requested-With";
    private const string RequiredValue = "XMLHttpRequest";

    public CustomHeaderValidationMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var method = context.Request.Method;

        // åªé©—è­‰å¯«å…¥æ“ä½œ
        if (method is "POST" or "PUT" or "DELETE" or "PATCH")
        {
            if (!context.Request.Headers.TryGetValue(RequiredHeader, out var headerValue) ||
                headerValue != RequiredValue)
            {
                context.Response.StatusCode = StatusCodes.Status403Forbidden;
                await context.Response.WriteAsJsonAsync(new { error = "ç¼ºå°‘å¿…è¦çš„ Header" });
                return;
            }
        }

        await _next(context);
    }
}

// åœ¨ Program.cs ä¸­è¨»å†Š
app.UseMiddleware<CustomHeaderValidationMiddleware>();
```

#### 3. å‰ç«¯ç™¼é€è«‹æ±‚æ™‚åŠ ä¸Šè‡ªè¨‚ Header

```javascript
fetch('https://your-api.com/api/data', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'  // åŠ ä¸Šè‡ªè¨‚ Header
    },
    body: JSON.stringify({ message: 'Hello' })
});
```

### å„ªé»

âœ… åˆ©ç”¨ç€è¦½å™¨åŒæºæ”¿ç­–
âœ… è·¨ç«™è«‹æ±‚ç„¡æ³•è¨­å®šè‡ªè¨‚ Header
âœ… å¯¦ä½œç°¡å–®

### ç¼ºé»

âš ï¸ å¯ä»¥è¢«ç¹éï¼ˆå¦‚æœ CORS è¨­å®šéæ–¼å¯¬é¬†ï¼‰
âš ï¸ ä¸å»ºè­°å–®ç¨ä½¿ç”¨

---

## æ–¹æ³• 4ï¼šé©—è­‰ Origin/Referer Header

### åŸç†

æª¢æŸ¥è«‹æ±‚çš„ä¾†æºæ˜¯å¦ç¬¦åˆé æœŸçš„ç¶²åŸŸã€‚

### å¯¦ä½œæ­¥é©Ÿ

```csharp
public class OriginValidationMiddleware
{
    private readonly RequestDelegate _next;
    private readonly string[] _allowedOrigins = new[]
    {
        "https://your-frontend.com",
        "https://www.your-frontend.com"
    };

    public OriginValidationMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var method = context.Request.Method;

        if (method is "POST" or "PUT" or "DELETE" or "PATCH")
        {
            var origin = context.Request.Headers["Origin"].ToString();
            var referer = context.Request.Headers["Referer"].ToString();

            bool isValid = false;

            // æª¢æŸ¥ Origin
            if (!string.IsNullOrEmpty(origin))
            {
                isValid = _allowedOrigins.Contains(origin);
            }
            // å¦‚æœæ²’æœ‰ Originï¼Œæª¢æŸ¥ Referer
            else if (!string.IsNullOrEmpty(referer))
            {
                isValid = _allowedOrigins.Any(o => referer.StartsWith(o));
            }

            if (!isValid)
            {
                context.Response.StatusCode = StatusCodes.Status403Forbidden;
                await context.Response.WriteAsJsonAsync(new { error = "ä¾†æºä¸å—ä¿¡ä»»" });
                return;
            }
        }

        await _next(context);
    }
}
```

### å„ªé»

âœ… ç°¡å–®ç›´æ¥
âœ… å¯ä»¥ä½œç‚ºé¡å¤–çš„é˜²è­·å±¤

### ç¼ºé»

âš ï¸ Origin/Referer å¯èƒ½è¢«çœç•¥ï¼ˆæŸäº›ç€è¦½å™¨éš±ç§è¨­å®šï¼‰
âš ï¸ ä¸å¤ å¯é ï¼Œä¸å»ºè­°å–®ç¨ä½¿ç”¨

---

## å»ºè­°çš„çµ„åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å¯¦è¸ï¼‰

### æ–¹æ¡ˆï¼šAnti-CSRF Token + CORS + è‡ªè¨‚ Header

çµåˆå¤šç¨®æ–¹æ³•ï¼Œæä¾›æœ€å¼·çš„ä¿è­·ï¼š

```csharp
// Program.cs
var builder = WebApplication.CreateBuilder(args);

// 1. è¨»å†Šæœå‹™
builder.Services.AddControllers();
builder.Services.AddMemoryCache();
builder.Services.AddScoped<ICsrfTokenService, CsrfTokenService>();

// 2. è¨­å®š CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowFrontend", policy =>
    {
        policy.WithOrigins("https://your-frontend.com")
            .AllowAnyMethod()
            .AllowAnyHeader()
            .AllowCredentials()
            .WithExposedHeaders("X-CSRF-Token");
    });
});

var app = builder.Build();

// 3. å•Ÿç”¨ CORS
app.UseCors("AllowFrontend");

// 4. å•Ÿç”¨ HTTPS é‡å°å‘
app.UseHttpsRedirection();

// 5. å•Ÿç”¨ Controllers
app.MapControllers();

app.Run();
```

### é˜²è­·å±¤æ¬¡

1. **CORS** - ç¬¬ä¸€å±¤ï¼šé™åˆ¶åªæœ‰æŒ‡å®šç¶²åŸŸå¯ä»¥å‘¼å«
2. **Anti-CSRF Token** - ç¬¬äºŒå±¤ï¼šé©—è­‰è«‹æ±‚ç¢ºå¯¦ä¾†è‡ªåˆæ³•é é¢
3. **è‡ªè¨‚ Header** - ç¬¬ä¸‰å±¤ï¼šåˆ©ç”¨åŒæºæ”¿ç­–é¡å¤–ä¿è­·

---

## å®Œæ•´æµç¨‹åœ–

```
å‰ç«¯é é¢è¼‰å…¥
    â†“
è«‹æ±‚ CSRF Token (GET /api/csrf/token)
    â†“
å„²å­˜ Token åˆ°è®Šæ•¸
    â†“
ä½¿ç”¨è€…åŸ·è¡Œæ“ä½œ
    â†“
ç™¼é€è«‹æ±‚ï¼ŒHeader ä¸­å¸¶ä¸Š Token
    â†“
ä¼ºæœå™¨æª¢æŸ¥ï¼š
  â”œâ”€ CORSï¼šä¾†æºç¶²åŸŸæ˜¯å¦å…è¨±ï¼Ÿ
  â”œâ”€ Tokenï¼šæ˜¯å¦å­˜åœ¨ï¼Ÿ
  â”œâ”€ Tokenï¼šæ˜¯å¦æœ‰æ•ˆï¼Ÿ
  â””â”€ Tokenï¼šæ˜¯å¦éæœŸï¼Ÿ
    â†“
å…¨éƒ¨é€šé â†’ è™•ç†è«‹æ±‚
ä»»ä¸€å¤±æ•— â†’ å›å‚³ 403 Forbidden
```

---

## æ¸¬è©¦é©—è­‰

### æ¸¬è©¦æ¡ˆä¾‹ 1ï¼šæ­£å¸¸è«‹æ±‚ âœ…

```bash
# 1. å–å¾— Token
TOKEN=$(curl -s "https://your-api.com/api/csrf/token" | jq -r .token)

# 2. ä½¿ç”¨ Token ç™¼é€è«‹æ±‚
curl -X POST "https://your-api.com/api/csrf/data" \
  -H "Content-Type: application/json" \
  -H "X-CSRF-Token: $TOKEN" \
  -d '{"message": "test"}'

# é æœŸçµæœï¼š200 OK
```

### æ¸¬è©¦æ¡ˆä¾‹ 2ï¼šç¼ºå°‘ Token âŒ

```bash
curl -X POST "https://your-api.com/api/csrf/data" \
  -H "Content-Type: application/json" \
  -d '{"message": "test"}'

# é æœŸçµæœï¼š403 Forbidden
# {"error": "ç¼ºå°‘ CSRF Token"}
```

### æ¸¬è©¦æ¡ˆä¾‹ 3ï¼šç„¡æ•ˆ Token âŒ

```bash
curl -X POST "https://your-api.com/api/csrf/data" \
  -H "Content-Type: application/json" \
  -H "X-CSRF-Token: INVALID_TOKEN" \
  -d '{"message": "test"}'

# é æœŸçµæœï¼š403 Forbidden
# {"error": "ç„¡æ•ˆçš„ CSRF Token"}
```

---

## å®‰å…¨æ€§è€ƒé‡

### âœ… å·²é˜²è­·

- **CSRF æ”»æ“Š**ï¼šæƒ¡æ„ç¶²ç«™ç„¡æ³•å–å¾—æœ‰æ•ˆ Token
- **è·¨åŸŸæ”»æ“Š**ï¼šCORS é™åˆ¶åªæœ‰æŒ‡å®šç¶²åŸŸå¯å‘¼å«
- **é‡æ”¾æ”»æ“Š**ï¼šToken æœ‰æ™‚æ•ˆæ€§ï¼ˆ30 åˆ†é˜ï¼‰

### âš ï¸ éœ€è¦é¡å¤–é˜²è­·

- **XSS æ”»æ“Š**ï¼šéœ€è¦è¼¸å…¥é©—è­‰å’Œè¼¸å‡ºç·¨ç¢¼
- **SQL Injection**ï¼šä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢
- **æš´åŠ›ç ´è§£**ï¼šåŠ å…¥ Rate Limiting
- **ä¸­é–“äººæ”»æ“Š**ï¼šå¼·åˆ¶ä½¿ç”¨ HTTPS

### ğŸ”’ ç”Ÿç”¢ç’°å¢ƒå»ºè­°

1. **å¼·åˆ¶ HTTPS**
   ```csharp
   app.UseHttpsRedirection();
   app.UseHsts();
   ```

2. **Token èˆ‡ Session ç¶å®š**
   ```csharp
   var sessionId = context.Session.Id;
   _cache.Set($"{sessionId}:{token}", true, _tokenExpiration);
   ```

3. **ä½¿ç”¨åˆ†æ•£å¼å¿«å–ï¼ˆå¤šä¼ºæœå™¨ç’°å¢ƒï¼‰**
   ```csharp
   builder.Services.AddStackExchangeRedisCache(options =>
   {
       options.Configuration = "localhost:6379";
   });
   ```

4. **åŠ å…¥ Rate Limiting**
   ```csharp
   builder.Services.AddRateLimiter(options =>
   {
       options.AddFixedWindowLimiter("api", opt =>
       {
           opt.Window = TimeSpan.FromMinutes(1);
           opt.PermitLimit = 10;
       });
   });
   ```

5. **è¨­å®šå®‰å…¨çš„ Cookie å±¬æ€§**
   ```csharp
   builder.Services.AddSession(options =>
   {
       options.Cookie.HttpOnly = true;
       options.Cookie.SecurePolicy = CookieSecurePolicy.Always;
       options.Cookie.SameSite = SameSiteMode.Strict;
   });
   ```

---

## å¸¸è¦‹å•é¡Œ

### Q1: ç‚ºä»€éº¼ GET è«‹æ±‚ä¸éœ€è¦é©—è­‰ï¼Ÿ

A: æ ¹æ“š HTTP è¦ç¯„å’Œ RESTful åŸå‰‡ï¼ŒGET è«‹æ±‚æ‡‰è©²æ˜¯ã€Œå®‰å…¨ã€ä¸”ã€Œå†ªç­‰ã€çš„ï¼Œä¸æ‡‰è©²ä¿®æ”¹ä¼ºæœå™¨ç‹€æ…‹ã€‚å› æ­¤ä¸éœ€è¦ CSRF ä¿è­·ã€‚åªæœ‰æœƒæ”¹è®Šç‹€æ…‹çš„æ“ä½œï¼ˆPOST/PUT/DELETEï¼‰æ‰éœ€è¦é©—è­‰ã€‚

### Q2: Token å„²å­˜åœ¨å“ªè£¡ï¼Ÿ

A: Token å„²å­˜åœ¨ä¼ºæœå™¨ç«¯çš„å¿«å–ä¸­ï¼ˆè¨˜æ†¶é«”æˆ– Redisï¼‰ã€‚å®¢æˆ¶ç«¯åªæ˜¯æŒæœ‰ Token çš„å‰¯æœ¬ï¼Œä¸¦åœ¨æ¯æ¬¡è«‹æ±‚æ™‚å‚³é€ã€‚

### Q3: å®¢æˆ¶ç«¯æ‡‰è©²å¦‚ä½•å„²å­˜ Tokenï¼Ÿ

A: å¯ä»¥å„²å­˜åœ¨ï¼š
- JavaScript è®Šæ•¸ï¼ˆæœ€ç°¡å–®ï¼Œä½†é‡æ–°æ•´ç†å¾Œéºå¤±ï¼‰
- sessionStorageï¼ˆé—œé–‰ç€è¦½å™¨å¾Œæ¸…é™¤ï¼‰
- localStorageï¼ˆæŒä¹…ä¿å­˜ï¼Œä½†è¦æ³¨æ„ XSS é¢¨éšªï¼‰

### Q4: å¯ä»¥ç”¨ Cookie å‚³é€ Token å—ï¼Ÿ

A: ä¸å»ºè­°ã€‚ä½¿ç”¨ Cookie å‚³é€ Token æœƒå¤±å» CSRF ä¿è­·çš„æ•ˆæœï¼Œå› ç‚ºç€è¦½å™¨æœƒè‡ªå‹•å¸¶ä¸Š Cookieã€‚æ‡‰è©²ä½¿ç”¨è‡ªè¨‚ Headerã€‚

### Q5: Token éæœŸå¾Œæ€éº¼è¾¦ï¼Ÿ

A: å®¢æˆ¶ç«¯æ‡‰è©²è™•ç† 403 éŒ¯èª¤ï¼Œé‡æ–°è«‹æ±‚æ–°çš„ Tokenã€‚

```javascript
async function apiRequest(url, options) {
    let response = await fetch(url, options);

    if (response.status === 403) {
        // Token å¯èƒ½éæœŸï¼Œé‡æ–°å–å¾—
        await initializePage();

        // ä½¿ç”¨æ–° Token é‡è©¦
        options.headers['X-CSRF-Token'] = csrfToken;
        response = await fetch(url, options);
    }

    return response;
}
```

### Q6: é€™å€‹æ–¹æ³•å¯ä»¥é˜²æ­¢æ‰€æœ‰æ”»æ“Šå—ï¼Ÿ

A: ä¸è¡Œã€‚é€™åªé˜²è­· CSRF æ”»æ“Šã€‚ä½ é‚„éœ€è¦ï¼š
- é˜²æ­¢ XSSï¼ˆè¼¸å…¥é©—è­‰ã€è¼¸å‡ºç·¨ç¢¼ã€CSPï¼‰
- é˜²æ­¢ SQL Injectionï¼ˆåƒæ•¸åŒ–æŸ¥è©¢ã€ORMï¼‰
- é˜²æ­¢æš´åŠ›ç ´è§£ï¼ˆRate Limitingã€å¸³è™Ÿé–å®šï¼‰
- é˜²æ­¢ä¸­é–“äººæ”»æ“Šï¼ˆHTTPSï¼‰

---

## ç¸½çµ

### æœ€ä½³æ–¹æ¡ˆ

**Anti-CSRF Token + CORS + HTTPS**

é€™å€‹çµ„åˆæä¾›ï¼š
- âœ… æœ‰æ•ˆé˜²æ­¢ CSRF æ”»æ“Š
- âœ… é™åˆ¶ä¾†æºç¶²åŸŸ
- âœ… åˆ©ç”¨ç€è¦½å™¨å®‰å…¨æ©Ÿåˆ¶
- âœ… å¯¦ä½œæ¸…æ™°æ˜“ç¶­è­·

### å¯¦ä½œæª¢æŸ¥æ¸…å–®

- [ ] å¯¦ä½œ Token ç”¢ç”Ÿå’Œé©—è­‰æœå‹™
- [ ] å»ºç«‹é©—è­‰ Filter æˆ– Middleware
- [ ] è¨­å®š CORS å…è¨±çš„ä¾†æº
- [ ] åœ¨éœ€è¦ä¿è­·çš„ç«¯é»å¥—ç”¨é©—è­‰
- [ ] å‰ç«¯æ•´åˆ Token å–å¾—å’Œå‚³é€
- [ ] å¼·åˆ¶ä½¿ç”¨ HTTPS
- [ ] è¨­å®š Token éæœŸæ™‚é–“
- [ ] å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œæ—¥èªŒ
- [ ] æ¸¬è©¦æ‰€æœ‰æƒ…å¢ƒï¼ˆæˆåŠŸã€å¤±æ•—ã€éæœŸï¼‰
- [ ] ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨åˆ†æ•£å¼å¿«å–

---

## åƒè€ƒè³‡æº

- [OWASP CSRF é˜²è­·æŒ‡å—](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)
- [ASP.NET Core å®‰å…¨æ€§](https://learn.microsoft.com/zh-tw/aspnet/core/security/)
- [CORS è¨­å®š](https://learn.microsoft.com/zh-tw/aspnet/core/security/cors)
- æœ¬å°ˆæ¡ˆå¯¦ä½œç¯„ä¾‹ï¼š`Lab.CSRF.WebApi/`
