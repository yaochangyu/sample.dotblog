# Lab.CSRF.1 - 使用說明

## 專案完成 ✅

已成功建立完整的 CSRF 保護 Web API 專案。

## 快速開始

### 1. 啟動 API 伺服器

```bash
cd Lab.CSRF.WebApi
dotnet run
```

伺服器會在以下位址啟動：
- HTTPS: `https://localhost:7001`
- HTTP: `http://localhost:5000`

### 2. 開啟測試頁面

在瀏覽器中開啟：
```
https://localhost:7001/index.html
```

### 3. 測試 CSRF 保護機制

依序執行以下測試：

#### ✅ 測試 1：正常流程
1. 點擊「取得 CSRF Token」按鈕
2. 輸入訊息內容
3. 點擊「送出 POST 請求」
4. 應該看到成功訊息

#### ❌ 測試 2：缺少 Token（應該失敗）
1. 點擊「測試不帶 Token（應該失敗）」按鈕
2. 應該看到 403 Forbidden 錯誤
3. 錯誤訊息：「缺少 CSRF Token」

#### ✅ 測試 3：PUT 請求
1. 確保已取得 Token
2. 輸入 ID 和更新內容
3. 點擊「送出 PUT 請求」
4. 應該看到更新成功訊息

#### ✅ 測試 4：DELETE 請求
1. 確保已取得 Token
2. 輸入要刪除的 ID
3. 點擊「送出 DELETE 請求」
4. 應該看到刪除成功訊息

#### ✅ 測試 5：公開端點（不需要 Token）
1. 點擊「呼叫公開 API」按鈕
2. 不需要 Token 也能成功呼叫
3. 應該看到公開端點的回應

## 專案結構

```
Lab.CSRF.1/
├── Lab.CSRF.WebApi/               # Web API 專案
│   ├── Controllers/               # API 控制器
│   │   └── CsrfController.cs     # CSRF 測試端點
│   ├── Filters/                   # 過濾器
│   │   └── ValidateCsrfTokenAttribute.cs  # CSRF 驗證
│   ├── Services/                  # 服務
│   │   ├── ICsrfTokenService.cs  # Token 服務介面
│   │   └── CsrfTokenService.cs   # Token 服務實作
│   ├── wwwroot/                   # 靜態檔案
│   │   └── index.html            # 測試頁面
│   ├── Program.cs                 # 程式進入點
│   └── README.md                  # 詳細說明
├── CSRF保護實作計畫.md            # 實作計畫
└── 使用說明.md                    # 本檔案
```

## CSRF 保護機制說明

### 什麼是 CSRF？

CSRF（Cross-Site Request Forgery，跨站請求偽造）是一種網路攻擊手法：
- 攻擊者誘導使用者點擊惡意連結
- 利用使用者的身份向目標網站發送請求
- 在使用者不知情的情況下執行操作

### 如何防護？

此專案使用多層防護機制：

#### 1. Anti-CSRF Token
- 每次請求前必須先取得唯一的 Token
- Token 必須在 `X-CSRF-Token` Header 中傳送
- Token 有效期 30 分鐘
- 惡意網站無法取得這個 Token

#### 2. CORS 限制
- 只允許特定網域的請求
- 限制跨域資源存取
- 防止惡意網站直接呼叫 API

#### 3. 自訂 Header
- 利用瀏覽器同源政策
- 跨站請求無法設定自訂 Header
- 只有同源網站可以加上 `X-CSRF-Token`

## API 端點說明

### 取得 Token
```http
GET /api/csrf/token
```

### 測試 POST（需要 Token）
```http
POST /api/csrf/test
Headers: X-CSRF-Token: {token}
Content-Type: application/json

{
  "message": "test message"
}
```

### 測試 PUT（需要 Token）
```http
PUT /api/csrf/update/123
Headers: X-CSRF-Token: {token}
Content-Type: application/json

{
  "message": "updated message"
}
```

### 測試 DELETE（需要 Token）
```http
DELETE /api/csrf/delete/456
Headers: X-CSRF-Token: {token}
```

### 公開端點（不需要 Token）
```http
GET /api/csrf/public
```

## 常見問題

### Q: 為什麼我的請求被拒絕？
A: 檢查以下項目：
1. 是否已取得 Token？
2. Token 是否放在 `X-CSRF-Token` Header 中？
3. Token 是否已過期（30 分鐘）？
4. 請求來源是否在 CORS 允許清單中？

### Q: 如何在自己的專案中使用？
A: 參考 `Lab.CSRF.WebApi/README.md` 中的「如何套用到現有專案」章節。

### Q: Token 過期後怎麼辦？
A: 重新呼叫 `/api/csrf/token` 取得新的 Token。

### Q: 可以用 Cookie 傳送 Token 嗎？
A: 不建議。使用 Cookie 會失去 CSRF 保護效果，應該使用自訂 Header。

## 安全性建議

### ✅ 生產環境必須：
- 使用 HTTPS
- 設定正確的 CORS 來源
- 啟用 Rate Limiting
- 記錄可疑的驗證失敗
- 定期輪換 Token

### ⚠️ 注意事項：
- Token 只防護 CSRF，不防護 XSS
- 需搭配其他安全措施（輸入驗證、輸出編碼等）
- 多伺服器環境建議使用分散式快取（Redis）

## 參考資源

- 詳細說明：`Lab.CSRF.WebApi/README.md`
- 實作計畫：`CSRF保護實作計畫.md`
- OWASP CSRF 指南：https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html

## 完成清單

- ✅ ASP.NET Core Web API 專案
- ✅ CSRF Token 產生和驗證服務
- ✅ 自動驗證 Filter
- ✅ 測試用 Controller（GET/POST/PUT/DELETE）
- ✅ CORS 設定
- ✅ 完整的測試頁面
- ✅ README 文件
- ✅ 編譯成功，無警告錯誤

---

🎉 **專案已完成！現在可以開始測試 CSRF 保護機制了！**
