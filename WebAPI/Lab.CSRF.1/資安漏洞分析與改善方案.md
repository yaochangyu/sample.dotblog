# è³‡å®‰æ¼æ´åˆ†æèˆ‡æ”¹å–„æ–¹æ¡ˆ

## ğŸš¨ ç™¼ç¾çš„å®‰å…¨æ¼æ´

### å•é¡Œæè¿°

ç•¶å‰å¯¦ä½œä¸­ï¼ŒCSRF Token çš„å–å¾—ç«¯é»æ˜¯**å®Œå…¨å…¬é–‹**çš„ï¼š

```javascript
// ä»»ä½•äººï¼ˆåŒ…æ‹¬æ”»æ“Šè€…ï¼‰éƒ½å¯ä»¥é€™æ¨£åšï¼š
const response = await fetch('https://localhost:7001/api/csrf/token');
const { token } = await response.json();

// ç„¶å¾Œä½¿ç”¨é€™å€‹ Token ç™¼é€æƒ¡æ„è«‹æ±‚
await fetch('https://localhost:7001/api/csrf/test', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': token
    },
    body: JSON.stringify({ message: 'æƒ¡æ„è«‹æ±‚' })
});
```

### æ¼æ´åš´é‡æ€§è©•ä¼°

**é¢¨éšªç­‰ç´šï¼šé«˜ï¼ˆHighï¼‰**

#### æ”»æ“Šå ´æ™¯

1. **è‡ªå‹•åŒ–æ”»æ“Š**
   - æ”»æ“Šè€…å¯«ä¸€å€‹ç°¡å–®çš„è…³æœ¬
   - å…ˆå‘¼å« `/api/csrf/token` å–å¾— Token
   - ä½¿ç”¨ Token ç™¼é€å¤§é‡æƒ¡æ„è«‹æ±‚

2. **ç¹é CSRF ä¿è­·**
   - CSRF Token çš„ç›®çš„æ˜¯é˜²æ­¢æƒ¡æ„ç¶²ç«™åˆ©ç”¨å—å®³è€…çš„èº«ä»½
   - ä½†å¦‚æœæ”»æ“Šè€…å¯ä»¥ç›´æ¥å–å¾— Tokenï¼Œä¿è­·æ©Ÿåˆ¶å°±å¤±æ•ˆäº†

3. **å¯¦éš›å½±éŸ¿**
   - è³‡æ–™è¢«æƒ¡æ„ä¿®æ”¹
   - æœªæˆæ¬Šçš„æ“ä½œ
   - API æ¿«ç”¨å’Œ DoS æ”»æ“Š

### ç‚ºä»€éº¼æœƒæœ‰é€™å€‹å•é¡Œï¼Ÿ

å‚³çµ±çš„ CSRF é˜²è­·å‡è¨­ï¼š
- âœ… Token åªèƒ½ç”±åˆæ³•é é¢å–å¾—
- âœ… æƒ¡æ„ç¶²ç«™å› ç‚ºã€ŒåŒæºæ”¿ç­–ã€ç„¡æ³•è®€å– Token
- âŒ **ä½†å¿½ç•¥äº†æ”»æ“Šè€…å¯ä»¥ç›´æ¥å‘¼å« API å–å¾— Token**

---

## âœ… æ”¹å–„æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šToken èˆ‡ Session ç¶å®šï¼ˆæœ€æ¨è–¦ï¼‰

å°‡ CSRF Token èˆ‡ä½¿ç”¨è€…çš„ Session ç¶å®šï¼Œå³ä½¿æ”»æ“Šè€…å–å¾— Tokenï¼Œæ²’æœ‰å°æ‡‰çš„ Session Cookie ä¹Ÿç„¡æ³•ä½¿ç”¨ã€‚

#### å¯¦ä½œæ­¥é©Ÿ

##### 1. æ›´æ–° CsrfTokenService

```csharp
using System.Security.Cryptography;
using Microsoft.Extensions.Caching.Distributed;

namespace Lab.CSRF.WebApi.Services;

public class CsrfTokenService : ICsrfTokenService
{
    private readonly IDistributedCache _cache;
    private readonly IHttpContextAccessor _httpContextAccessor;
    private readonly ILogger<CsrfTokenService> _logger;
    private readonly TimeSpan _tokenExpiration = TimeSpan.FromMinutes(30);

    public CsrfTokenService(
        IDistributedCache cache,
        IHttpContextAccessor httpContextAccessor,
        ILogger<CsrfTokenService> logger)
    {
        _cache = cache;
        _httpContextAccessor = httpContextAccessor;
        _logger = logger;
    }

    public string GenerateToken()
    {
        // å–å¾—æˆ–å»ºç«‹ Session ID
        var httpContext = _httpContextAccessor.HttpContext;
        var sessionId = httpContext?.Session?.Id;

        if (string.IsNullOrEmpty(sessionId))
        {
            _logger.LogWarning("ç„¡æ³•å–å¾— Session ID");
            throw new InvalidOperationException("Session æœªå•Ÿç”¨");
        }

        // ç”¢ç”Ÿ Token
        var token = GenerateRandomToken();

        // å°‡ Token èˆ‡ Session ID ç¶å®š
        var cacheKey = $"csrf:{sessionId}:{token}";
        _cache.SetString(cacheKey, "valid", new DistributedCacheEntryOptions
        {
            AbsoluteExpirationRelativeToNow = _tokenExpiration
        });

        _logger.LogInformation("ç”¢ç”Ÿæ–°çš„ CSRF Tokenï¼Œç¶å®š Session: {SessionId}", sessionId);

        return token;
    }

    public bool ValidateToken(string token)
    {
        if (string.IsNullOrWhiteSpace(token))
        {
            _logger.LogWarning("Token ç‚ºç©º");
            return false;
        }

        var httpContext = _httpContextAccessor.HttpContext;
        var sessionId = httpContext?.Session?.Id;

        if (string.IsNullOrEmpty(sessionId))
        {
            _logger.LogWarning("ç„¡æ³•å–å¾— Session ID é€²è¡Œé©—è­‰");
            return false;
        }

        // é©—è­‰ Token æ˜¯å¦èˆ‡ç•¶å‰ Session ç¶å®š
        var cacheKey = $"csrf:{sessionId}:{token}";
        var cachedValue = _cache.GetString(cacheKey);

        if (cachedValue == null)
        {
            _logger.LogWarning("Token ç„¡æ•ˆæˆ–å·²éæœŸï¼ŒSession: {SessionId}, Token: {Token}",
                sessionId, token);
            return false;
        }

        _logger.LogInformation("Token é©—è­‰æˆåŠŸï¼ŒSession: {SessionId}", sessionId);
        return true;
    }

    public void RemoveToken(string token)
    {
        var httpContext = _httpContextAccessor.HttpContext;
        var sessionId = httpContext?.Session?.Id;

        if (!string.IsNullOrEmpty(sessionId) && !string.IsNullOrWhiteSpace(token))
        {
            var cacheKey = $"csrf:{sessionId}:{token}";
            _cache.Remove(cacheKey);
            _logger.LogInformation("ç§»é™¤ Tokenï¼ŒSession: {SessionId}", sessionId);
        }
    }

    private static string GenerateRandomToken()
    {
        var randomBytes = new byte[32];
        using var rng = RandomNumberGenerator.Create();
        rng.GetBytes(randomBytes);
        return Convert.ToBase64String(randomBytes);
    }
}
```

##### 2. è¨»å†Šæœå‹™ï¼ˆProgram.csï¼‰

```csharp
using Lab.CSRF.WebApi.Services;

var builder = WebApplication.CreateBuilder(args);

// è¨»å†Š Controllers
builder.Services.AddControllers();

// è¨»å†Š HttpContextAccessorï¼ˆå¿…è¦ï¼‰
builder.Services.AddHttpContextAccessor();

// å•Ÿç”¨ Session
builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;  // é˜²æ­¢ JavaScript è®€å–
    options.Cookie.IsEssential = true;
    options.Cookie.SecurePolicy = CookieSecurePolicy.Always;  // åªåœ¨ HTTPS ä¸‹å‚³é€
    options.Cookie.SameSite = SameSiteMode.Strict;  // é˜²æ­¢ CSRF
});

// ä½¿ç”¨åˆ†æ•£å¼è¨˜æ†¶é«”å¿«å–ï¼ˆæˆ– Redisï¼‰
builder.Services.AddDistributedMemoryCache();
// ç”Ÿç”¢ç’°å¢ƒå»ºè­°ä½¿ç”¨ Redisï¼š
// builder.Services.AddStackExchangeRedisCache(options =>
// {
//     options.Configuration = "localhost:6379";
// });

// è¨»å†Š CSRF Token æœå‹™
builder.Services.AddScoped<ICsrfTokenService, CsrfTokenService>();

// è¨­å®š CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowFrontend", policy =>
    {
        policy.WithOrigins("https://your-frontend.com")
            .AllowAnyMethod()
            .AllowAnyHeader()
            .AllowCredentials()  // å¿…é ˆå•Ÿç”¨ï¼Œæ‰èƒ½å‚³é€ Cookie
            .WithExposedHeaders("X-CSRF-Token");
    });
});

var app = builder.Build();

app.UseHttpsRedirection();
app.UseCors("AllowFrontend");

// å•Ÿç”¨ Sessionï¼ˆå¿…é ˆåœ¨ UseCors ä¹‹å¾Œï¼‰
app.UseSession();

app.MapControllers();
app.Run();
```

##### 3. å‰ç«¯æ•´åˆ

```javascript
// å–å¾— Tokenï¼ˆæœƒè‡ªå‹•å»ºç«‹ Sessionï¼‰
async function getToken() {
    const response = await fetch('https://your-api.com/api/csrf/token', {
        credentials: 'include'  // å¿…é ˆåŠ ä¸Šï¼Œæ‰æœƒå‚³é€å’Œå„²å­˜ Cookie
    });

    const data = await response.json();
    return data.token;
}

// ç™¼é€è«‹æ±‚ï¼ˆæœƒè‡ªå‹•å¸¶ä¸Š Session Cookieï¼‰
async function createData(token, message) {
    const response = await fetch('https://your-api.com/api/csrf/data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': token
        },
        credentials: 'include',  // å¿…é ˆåŠ ä¸Šï¼Œæ‰æœƒå‚³é€ Session Cookie
        body: JSON.stringify({ message })
    });

    return await response.json();
}
```

#### ç‚ºä»€éº¼é€™æ¨£æ›´å®‰å…¨ï¼Ÿ

**æ”»æ“Šè€…ç„¡æ³•å–å¾— Session Cookie**

å³ä½¿æ”»æ“Šè€…å¯ä»¥ï¼š
1. âœ… å‘¼å« `/api/csrf/token` å–å¾— Token
2. âŒ **ä½†ç„¡æ³•å–å¾—å—å®³è€…çš„ Session Cookie**ï¼ˆå› ç‚º HttpOnly å’Œ SameSite è¨­å®šï¼‰

å› æ­¤ï¼š
- æ”»æ“Šè€…ç”¨è‡ªå·±çš„ Session å–å¾—çš„ Tokenï¼Œåªèƒ½æ”»æ“Šè‡ªå·±
- ç„¡æ³•ç”¨é€™å€‹ Token å†’å……å…¶ä»–ä½¿ç”¨è€…

#### å®‰å…¨æ€§æå‡

| æ”»æ“Šå ´æ™¯ | åŸå¯¦ä½œ | Session ç¶å®š |
|---------|--------|-------------|
| æ”»æ“Šè€…ç›´æ¥å–å¾— Token | âŒ å¯è¡Œ | âœ… ç„¡æ•ˆï¼ˆæ²’æœ‰å°æ‡‰ Sessionï¼‰ |
| æ”»æ“Šè€…ç«Šå– Cookie | N/A | âœ… é˜²è­·ï¼ˆHttpOnly + Secureï¼‰ |
| è·¨ç«™æ”»æ“Š | âš ï¸ éƒ¨åˆ†é˜²è­· | âœ… å®Œå…¨é˜²è­·ï¼ˆSameSiteï¼‰ |
| è‡ªå‹•åŒ–æ”»æ“Š | âŒ å¯è¡Œ | âœ… é˜²è­·ï¼ˆéœ€è¦æœ‰æ•ˆ Sessionï¼‰ |

---

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨è€…èªè­‰ + Tokenï¼ˆæœ€å®‰å…¨ï¼‰

è¦æ±‚ä½¿ç”¨è€…å¿…é ˆå…ˆç™»å…¥ï¼Œåªæœ‰å·²èªè­‰çš„ä½¿ç”¨è€…æ‰èƒ½å–å¾— CSRF Tokenã€‚

#### å¯¦ä½œæ­¥é©Ÿ

##### 1. å»ºç«‹èªè­‰ä¸­ä»‹å±¤

```csharp
public class AuthenticationMiddleware
{
    private readonly RequestDelegate _next;

    public AuthenticationMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ä½¿ç”¨è€…èªè­‰
        // é€™è£¡ä½¿ç”¨ç°¡å–®çš„ Session æª¢æŸ¥ï¼Œå¯¦éš›æ‡‰è©²ç”¨ JWT æˆ–å…¶ä»–èªè­‰æ©Ÿåˆ¶
        var userId = context.Session.GetString("UserId");

        if (string.IsNullOrEmpty(userId))
        {
            // æœªç™»å…¥çš„ä½¿ç”¨è€…åªèƒ½è¨ªå•ç™»å…¥ç›¸é—œç«¯é»
            var path = context.Request.Path.Value?.ToLower() ?? "";
            if (!path.StartsWith("/api/auth/"))
            {
                context.Response.StatusCode = StatusCodes.Status401Unauthorized;
                await context.Response.WriteAsJsonAsync(new { error = "æœªç™»å…¥" });
                return;
            }
        }
        else
        {
            // å°‡ä½¿ç”¨è€… ID åŠ åˆ° HttpContextï¼Œæ–¹ä¾¿å¾ŒçºŒä½¿ç”¨
            context.Items["UserId"] = userId;
        }

        await _next(context);
    }
}

// åœ¨ Program.cs ä¸­è¨»å†Š
app.UseSession();
app.UseMiddleware<AuthenticationMiddleware>();
```

##### 2. å»ºç«‹ç™»å…¥ç«¯é»

```csharp
[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    [HttpPost("login")]
    public IActionResult Login([FromBody] LoginRequest request)
    {
        // é©—è­‰ä½¿ç”¨è€…å¸³è™Ÿå¯†ç¢¼ï¼ˆé€™è£¡ç°¡åŒ–ï¼‰
        if (request.Username == "user" && request.Password == "pass")
        {
            // å»ºç«‹ Session
            HttpContext.Session.SetString("UserId", "user123");

            return Ok(new { success = true, message = "ç™»å…¥æˆåŠŸ" });
        }

        return Unauthorized(new { error = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤" });
    }

    [HttpPost("logout")]
    public IActionResult Logout()
    {
        HttpContext.Session.Clear();
        return Ok(new { success = true, message = "ç™»å‡ºæˆåŠŸ" });
    }
}

public record LoginRequest(string Username, string Password);
```

##### 3. ä¿®æ”¹ CSRF Token ç«¯é»

```csharp
[ApiController]
[Route("api/[controller]")]
public class CsrfController : ControllerBase
{
    private readonly ICsrfTokenService _csrfTokenService;

    public CsrfController(ICsrfTokenService csrfTokenService)
    {
        _csrfTokenService = csrfTokenService;
    }

    // åªæœ‰ç™»å…¥çš„ä½¿ç”¨è€…æ‰èƒ½å–å¾— Token
    [HttpGet("token")]
    public IActionResult GetToken()
    {
        // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²ç™»å…¥
        var userId = HttpContext.Items["UserId"]?.ToString();
        if (string.IsNullOrEmpty(userId))
        {
            return Unauthorized(new { error = "è«‹å…ˆç™»å…¥" });
        }

        var token = _csrfTokenService.GenerateToken();
        return Ok(new { token, expiresIn = 1800 });
    }

    // å…¶ä»–å—ä¿è­·çš„ç«¯é»...
}
```

##### 4. å‰ç«¯æ•´åˆ

```javascript
// 1. å…ˆç™»å…¥
async function login(username, password) {
    const response = await fetch('https://your-api.com/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username, password })
    });

    return await response.json();
}

// 2. ç™»å…¥å¾Œæ‰èƒ½å–å¾— Token
async function getToken() {
    const response = await fetch('https://your-api.com/api/csrf/token', {
        credentials: 'include'
    });

    if (response.status === 401) {
        // æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é 
        window.location.href = '/login';
        return null;
    }

    const data = await response.json();
    return data.token;
}

// 3. æ­£å¸¸ä½¿ç”¨
async function main() {
    // ç™»å…¥
    await login('user', 'pass');

    // å–å¾— Token
    const token = await getToken();

    // ç™¼é€è«‹æ±‚
    await createData(token, 'Hello');
}
```

#### ç‚ºä»€éº¼é€™æ¨£æœ€å®‰å…¨ï¼Ÿ

**é›™é‡é©—è­‰**

1. **ç¬¬ä¸€å±¤ï¼šä½¿ç”¨è€…èªè­‰**
   - å¿…é ˆå…ˆç™»å…¥æ‰èƒ½å–å¾— Token
   - æ”»æ“Šè€…ç„¡æ³•ç™»å…¥ï¼Œå°±ç„¡æ³•å–å¾— Token

2. **ç¬¬äºŒå±¤ï¼šCSRF Token**
   - å³ä½¿æ”»æ“Šè€…æœ‰å¸³è™Ÿï¼Œä¹Ÿéœ€è¦ Token
   - Token èˆ‡ Session ç¶å®šï¼Œç„¡æ³•è·¨å¸³è™Ÿä½¿ç”¨

3. **ç¬¬ä¸‰å±¤ï¼šSession ç¶å®š**
   - Token å¿…é ˆèˆ‡æ­£ç¢ºçš„ Session é…å°
   - é˜²æ­¢ Token è¢«ç«Šå–å¾Œæ¿«ç”¨

---

### æ–¹æ¡ˆ 3ï¼šDouble Submit Cookie æ¨¡å¼

Token åŒæ™‚åœ¨ Cookie å’Œ Header ä¸­å‚³é€ï¼Œä¼ºæœå™¨é©—è­‰å…©è€…æ˜¯å¦ä¸€è‡´ã€‚

#### å¯¦ä½œæ­¥é©Ÿ

##### 1. ç”¢ç”Ÿ Token æ™‚è¨­å®š Cookie

```csharp
[HttpGet("token")]
public IActionResult GetToken()
{
    var token = _csrfTokenService.GenerateToken();

    // åŒæ™‚å°‡ Token è¨­å®šåˆ° Cookie ä¸­
    Response.Cookies.Append("CSRF-TOKEN", token, new CookieOptions
    {
        HttpOnly = false,  // JavaScript éœ€è¦è®€å–
        Secure = true,
        SameSite = SameSiteMode.Strict,
        MaxAge = TimeSpan.FromMinutes(30)
    });

    return Ok(new { token, expiresIn = 1800 });
}
```

##### 2. é©—è­‰æ™‚æª¢æŸ¥ Cookie å’Œ Header

```csharp
public override void OnActionExecuting(ActionExecutingContext context)
{
    var httpMethod = context.HttpContext.Request.Method;

    if (httpMethod is "GET" or "HEAD" or "OPTIONS" or "TRACE")
    {
        base.OnActionExecuting(context);
        return;
    }

    // å¾ Header å–å¾— Token
    if (!context.HttpContext.Request.Headers.TryGetValue("X-CSRF-Token", out var headerToken))
    {
        context.Result = new ObjectResult(new { error = "ç¼ºå°‘ CSRF Token Header" })
        {
            StatusCode = StatusCodes.Status403Forbidden
        };
        return;
    }

    // å¾ Cookie å–å¾— Token
    if (!context.HttpContext.Request.Cookies.TryGetValue("CSRF-TOKEN", out var cookieToken))
    {
        context.Result = new ObjectResult(new { error = "ç¼ºå°‘ CSRF Token Cookie" })
        {
            StatusCode = StatusCodes.Status403Forbidden
        };
        return;
    }

    // é©—è­‰å…©å€‹ Token æ˜¯å¦ä¸€è‡´
    if (headerToken != cookieToken)
    {
        context.Result = new ObjectResult(new { error = "CSRF Token ä¸ä¸€è‡´" })
        {
            StatusCode = StatusCodes.Status403Forbidden
        };
        return;
    }

    // é©—è­‰ Token æ˜¯å¦æœ‰æ•ˆ
    var csrfTokenService = context.HttpContext.RequestServices
        .GetRequiredService<ICsrfTokenService>();

    if (!csrfTokenService.ValidateToken(headerToken))
    {
        context.Result = new ObjectResult(new { error = "ç„¡æ•ˆçš„ CSRF Token" })
        {
            StatusCode = StatusCodes.Status403Forbidden
        };
        return;
    }

    base.OnActionExecuting(context);
}
```

##### 3. å‰ç«¯æ•´åˆ

```javascript
// å–å¾— Tokenï¼ˆæœƒè‡ªå‹•è¨­å®šåˆ° Cookieï¼‰
async function getToken() {
    const response = await fetch('https://your-api.com/api/csrf/token', {
        credentials: 'include'
    });

    const data = await response.json();
    return data.token;
}

// ç™¼é€è«‹æ±‚æ™‚ï¼ŒCookie æœƒè‡ªå‹•å¸¶ä¸Š
async function createData(token, message) {
    const response = await fetch('https://your-api.com/api/csrf/data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': token  // Header ä¸­çš„ Token
            // Cookie ä¸­çš„ Token æœƒè‡ªå‹•å¸¶ä¸Š
        },
        credentials: 'include',
        body: JSON.stringify({ message })
    });

    return await response.json();
}
```

#### ç‚ºä»€éº¼é€™æ¨£æ›´å®‰å…¨ï¼Ÿ

**æ”»æ“Šè€…ç„¡æ³•åŒæ™‚å½é€  Cookie å’Œ Header**

1. æƒ¡æ„ç¶²ç«™å¯ä»¥è®€å–è‡ªå·±åŸŸåä¸‹çš„ Cookie
2. ä½†ç„¡æ³•è®€å–å…¶ä»–åŸŸåçš„ Cookieï¼ˆåŒæºæ”¿ç­–ï¼‰
3. æ”»æ“Šè€…ç„¡æ³•åœ¨ Header ä¸­æ”¾å…¥æ­£ç¢ºçš„ Tokenï¼ˆå› ç‚ºä¸çŸ¥é“ Cookie çš„å€¼ï¼‰

---

## ğŸ“Š æ–¹æ¡ˆæ¯”è¼ƒ

| æ–¹æ¡ˆ | å®‰å…¨æ€§ | å¯¦ä½œè¤‡é›œåº¦ | ä½¿ç”¨è€…é«”é©— | é©ç”¨å ´æ™¯ |
|-----|--------|-----------|----------|---------|
| Session ç¶å®š | â­â­â­â­ | ä¸­ | å¥½ | ä¸€èˆ¬ Web æ‡‰ç”¨ |
| ä½¿ç”¨è€…èªè­‰ + Token | â­â­â­â­â­ | é«˜ | éœ€ç™»å…¥ | ä¼æ¥­æ‡‰ç”¨ã€æ•æ„Ÿæ“ä½œ |
| Double Submit Cookie | â­â­â­â­ | ä¸­ | å¥½ | ç„¡ç‹€æ…‹ API |

---

## ğŸ¯ å»ºè­°æ¡ç”¨æ–¹æ¡ˆ

### ä¸€èˆ¬æƒ…æ³ï¼šæ–¹æ¡ˆ 1ï¼ˆSession ç¶å®šï¼‰

**å„ªé»**ï¼š
- âœ… å®‰å…¨æ€§é«˜
- âœ… å¯¦ä½œç›¸å°ç°¡å–®
- âœ… ä¸éœ€è¦é¡å¤–çš„ä½¿ç”¨è€…èªè­‰
- âœ… ä½¿ç”¨è€…é«”é©—å¥½

**å¯¦ä½œè¦é»**ï¼š
1. å•Ÿç”¨ Session
2. Token èˆ‡ Session ID ç¶å®š
3. è¨­å®š Cookie å®‰å…¨å±¬æ€§ï¼ˆHttpOnly, Secure, SameSiteï¼‰
4. å‰ç«¯å¿…é ˆä½¿ç”¨ `credentials: 'include'`

### é«˜å®‰å…¨éœ€æ±‚ï¼šæ–¹æ¡ˆ 2ï¼ˆä½¿ç”¨è€…èªè­‰ + Tokenï¼‰

**å„ªé»**ï¼š
- âœ… æœ€é«˜å®‰å…¨æ€§
- âœ… é›™é‡é©—è­‰
- âœ… å¯è¿½è¹¤ä½¿ç”¨è€…æ“ä½œ
- âœ… ç¬¦åˆä¼æ¥­å®‰å…¨æ¨™æº–

**å¯¦ä½œè¦é»**ï¼š
1. å¯¦ä½œå®Œæ•´çš„ä½¿ç”¨è€…èªè­‰ç³»çµ±
2. Token ç¶å®šåˆ°å·²èªè­‰çš„ä½¿ç”¨è€…
3. ä½¿ç”¨ JWT æˆ– Session ç®¡ç†
4. å¯¦ä½œå®Œæ•´çš„æ¬Šé™æ§åˆ¶

---

## ğŸ”’ é¡å¤–çš„å®‰å…¨å¼·åŒ–

### 1. Rate Limitingï¼ˆé€Ÿç‡é™åˆ¶ï¼‰

é˜²æ­¢æš´åŠ›ç ´è§£å’Œæ¿«ç”¨ï¼š

```csharp
builder.Services.AddRateLimiter(options =>
{
    options.AddFixedWindowLimiter("csrf", opt =>
    {
        opt.Window = TimeSpan.FromMinutes(1);
        opt.PermitLimit = 10;  // æ¯åˆ†é˜æœ€å¤š 10 å€‹è«‹æ±‚
        opt.QueueProcessingOrder = QueueProcessingOrder.OldestFirst;
        opt.QueueLimit = 0;
    });
});

app.UseRateLimiter();

// åœ¨ Controller ä¸Šå¥—ç”¨
[EnableRateLimiting("csrf")]
[HttpGet("token")]
public IActionResult GetToken() { ... }
```

### 2. IP ç™½åå–®

åªå…è¨±ç‰¹å®š IP å–å¾— Tokenï¼š

```csharp
public class IpWhitelistMiddleware
{
    private readonly RequestDelegate _next;
    private readonly string[] _allowedIps = new[] { "192.168.1.1", "10.0.0.1" };

    public async Task InvokeAsync(HttpContext context)
    {
        var remoteIp = context.Connection.RemoteIpAddress?.ToString();

        if (!_allowedIps.Contains(remoteIp))
        {
            context.Response.StatusCode = StatusCodes.Status403Forbidden;
            await context.Response.WriteAsJsonAsync(new { error = "IP ä¸åœ¨ç™½åå–®ä¸­" });
            return;
        }

        await _next(context);
    }
}
```

### 3. User-Agent æª¢æŸ¥

æ‹’çµ•å·²çŸ¥çš„çˆ¬èŸ²å’Œè‡ªå‹•åŒ–å·¥å…·ï¼š

```csharp
public class UserAgentValidationMiddleware
{
    private readonly RequestDelegate _next;
    private readonly string[] _blockedAgents = new[]
    {
        "bot", "crawler", "spider", "scraper", "curl", "wget"
    };

    public async Task InvokeAsync(HttpContext context)
    {
        var userAgent = context.Request.Headers["User-Agent"].ToString().ToLower();

        if (_blockedAgents.Any(agent => userAgent.Contains(agent)))
        {
            context.Response.StatusCode = StatusCodes.Status403Forbidden;
            await context.Response.WriteAsJsonAsync(new { error = "ä¸å…è¨±çš„ User-Agent" });
            return;
        }

        await _next(context);
    }
}
```

### 4. Token ä½¿ç”¨æ¬¡æ•¸é™åˆ¶

æ¯å€‹ Token åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼ˆä¸€æ¬¡æ€§ Tokenï¼‰ï¼š

```csharp
public bool ValidateToken(string token)
{
    if (string.IsNullOrWhiteSpace(token))
        return false;

    var httpContext = _httpContextAccessor.HttpContext;
    var sessionId = httpContext?.Session?.Id;

    if (string.IsNullOrEmpty(sessionId))
        return false;

    var cacheKey = $"csrf:{sessionId}:{token}";
    var cachedValue = _cache.GetString(cacheKey);

    if (cachedValue == null)
        return false;

    // é©—è­‰æˆåŠŸå¾Œç«‹å³åˆªé™¤ Tokenï¼ˆä¸€æ¬¡æ€§ï¼‰
    _cache.Remove(cacheKey);

    _logger.LogInformation("Token å·²ä½¿ç”¨ä¸¦åˆªé™¤ï¼ŒSession: {SessionId}", sessionId);
    return true;
}
```

---

## ğŸ“ å¯¦ä½œæª¢æŸ¥æ¸…å–®

### å¿…é ˆå¯¦ä½œï¼ˆé«˜å„ªå…ˆç´šï¼‰

- [ ] Token èˆ‡ Session ç¶å®š
- [ ] å•Ÿç”¨ Session ä¸¦è¨­å®šå®‰å…¨å±¬æ€§
- [ ] Cookie è¨­å®š HttpOnlyã€Secureã€SameSite
- [ ] å‰ç«¯ä½¿ç”¨ `credentials: 'include'`
- [ ] é©—è­‰ Token æ™‚æª¢æŸ¥ Session
- [ ] å¼·åˆ¶ä½¿ç”¨ HTTPS

### å»ºè­°å¯¦ä½œï¼ˆä¸­å„ªå…ˆç´šï¼‰

- [ ] åŠ å…¥ä½¿ç”¨è€…èªè­‰æ©Ÿåˆ¶
- [ ] å¯¦ä½œ Rate Limiting
- [ ] è¨˜éŒ„å®‰å…¨ç›¸é—œçš„æ—¥èªŒ
- [ ] Token éæœŸè‡ªå‹•æ¸…ç†
- [ ] éŒ¯èª¤è¨Šæ¯ä¸æ´©æ¼æ•æ„Ÿè³‡è¨Š

### é€²éšå¯¦ä½œï¼ˆä½å„ªå…ˆç´šï¼‰

- [ ] IP ç™½åå–®
- [ ] User-Agent æª¢æŸ¥
- [ ] ä¸€æ¬¡æ€§ Token
- [ ] ç›£æ§ç•°å¸¸è«‹æ±‚æ¨¡å¼
- [ ] è‡ªå‹•å°é–å¯ç–‘ IP

---

## ğŸ§ª å®‰å…¨æ¸¬è©¦

### æ¸¬è©¦æ¡ˆä¾‹ 1ï¼šæ”»æ“Šè€…å˜—è©¦ç›´æ¥å–å¾—ä¸¦ä½¿ç”¨ Token

**åŸå¯¦ä½œï¼ˆä¸å®‰å…¨ï¼‰**ï¼š
```bash
# æ”»æ“Šè€…å¯ä»¥æˆåŠŸ
TOKEN=$(curl -s "https://your-api.com/api/csrf/token" | jq -r .token)
curl -X POST "https://your-api.com/api/csrf/data" \
  -H "X-CSRF-Token: $TOKEN" \
  -d '{"message": "æ”»æ“Š"}'
# çµæœï¼šæˆåŠŸ âŒ
```

**æ”¹å–„å¾Œï¼ˆå®‰å…¨ï¼‰**ï¼š
```bash
# æ”»æ“Šè€…ç„¡æ³•æˆåŠŸ
TOKEN=$(curl -s "https://your-api.com/api/csrf/token" | jq -r .token)
curl -X POST "https://your-api.com/api/csrf/data" \
  -H "X-CSRF-Token: $TOKEN" \
  -d '{"message": "æ”»æ“Š"}'
# çµæœï¼š403 Forbidden âœ…
# éŒ¯èª¤ï¼šToken èˆ‡ Session ä¸åŒ¹é…
```

### æ¸¬è©¦æ¡ˆä¾‹ 2ï¼šæ”»æ“Šè€…å˜—è©¦ç«Šå–å—å®³è€…çš„ Token

**æ”¹å–„å¾Œï¼ˆå®‰å…¨ï¼‰**ï¼š
```bash
# å³ä½¿ç«Šå–åˆ° Tokenï¼Œä¹Ÿç„¡æ³•ä½¿ç”¨
# å› ç‚ºæ²’æœ‰å—å®³è€…çš„ Session Cookie
curl -X POST "https://your-api.com/api/csrf/data" \
  -H "X-CSRF-Token: STOLEN_TOKEN" \
  -d '{"message": "æ”»æ“Š"}'
# çµæœï¼š403 Forbidden âœ…
# éŒ¯èª¤ï¼šToken èˆ‡ Session ä¸åŒ¹é…
```

---

## ğŸ“š åƒè€ƒè³‡æº

- [OWASP CSRF é˜²è­·æŒ‡å—](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)
- [ASP.NET Core Session](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/app-state)
- [Cookie å®‰å…¨æ€§](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#security)
- [SameSite Cookie èªªæ˜](https://web.dev/samesite-cookies-explained/)

---

## ç¸½çµ

### åŸå¯¦ä½œçš„å•é¡Œ

âŒ Token å–å¾—ç«¯é»å®Œå…¨å…¬é–‹
âŒ æ”»æ“Šè€…å¯ä»¥è‡ªå‹•åŒ–å–å¾— Token
âŒ Token æ²’æœ‰èˆ‡ä½¿ç”¨è€…èº«ä»½ç¶å®š
âŒ ç„¡æ³•é˜²æ­¢è‡ªå‹•åŒ–æ”»æ“Š

### æ”¹å–„å¾Œçš„å„ªå‹¢

âœ… Token èˆ‡ Session ç¶å®šï¼Œæ”»æ“Šè€…ç„¡æ³•ä½¿ç”¨
âœ… Cookie å®‰å…¨è¨­å®šï¼Œé˜²æ­¢ XSS å’Œ CSRF
âœ… å¯é¸åŠ å…¥ä½¿ç”¨è€…èªè­‰ï¼Œæå‡å®‰å…¨æ€§
âœ… Rate Limiting é˜²æ­¢æ¿«ç”¨
âœ… å®Œæ•´çš„æ—¥èªŒè¿½è¹¤

### å»ºè­°

**ç«‹å³å¯¦ä½œï¼šæ–¹æ¡ˆ 1ï¼ˆSession ç¶å®šï¼‰**

é€™æ˜¯å®‰å…¨æ€§å’Œå¯¦ä½œè¤‡é›œåº¦çš„æœ€ä½³å¹³è¡¡é»ï¼Œå¯ä»¥æœ‰æ•ˆè§£æ±ºç•¶å‰çš„å®‰å…¨æ¼æ´ã€‚
