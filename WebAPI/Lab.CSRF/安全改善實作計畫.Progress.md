# 安全改善實作計畫 - 進度追蹤

## 實作步驟

### 優先級 P0：立即處理（第一週）

- [ ] **步驟 1：實作 Rate Limiting（速率限制）**
  - 原因：防止 DDoS 攻擊與爬蟲大量請求，這是目前最嚴重的漏洞
  - 內容：
    - 安裝 AspNetCoreRateLimit 套件
    - 設定 IP 層級速率限制
    - 針對不同端點設定不同限制
    - Token 端點：每分鐘 5 次
    - Protected 端點：每分鐘 10 次

- [ ] **步驟 2：實作 Referer 驗證**
  - 原因：確保請求來自合法的前端頁面，防止命令列直接攻擊
  - 內容：
    - 建立 RefererValidationAttribute
    - 驗證 Referer Header 必須存在
    - 檢查 Referer 是否來自允許的網域清單
    - 套用至所有受保護的端點

- [ ] **步驟 3：調整 Token 時效性**
  - 原因：縮短 Token 有效時間，減少被竊取後的風險窗口
  - 內容：
    - 設定 Cookie.Expiration = 5 分鐘
    - 確保前端正確處理過期 Token
    - 新增 Token 過期提示訊息

### 優先級 P1：本週內處理（第二週）

- [ ] **步驟 4：實作 User-Agent 驗證**
  - 原因：阻擋已知的爬蟲工具（curl、wget、Python requests 等）
  - 內容：
    - 建立 UserAgentValidationAttribute
    - 定義阻擋名單（python、curl、wget、bot、crawler 等）
    - 驗證 User-Agent 必須存在
    - 套用至所有 API 端點

- [ ] **步驟 5：修正 CORS 政策**
  - 原因：目前 AllowAnyOrigin 過於寬鬆，降低安全性
  - 內容：
    - 移除 AllowAll 政策
    - 建立限制性 CORS 政策
    - 僅允許特定網域（localhost、production domain）
    - 啟用 AllowCredentials 支援 Cookie

- [ ] **步驟 6：建立基礎日誌系統**
  - 原因：記錄所有 CSRF 相關請求，方便事後分析與追蹤
  - 內容：
    - 記錄所有請求的 IP、User-Agent、Referer
    - 記錄被阻擋的請求（400/403）
    - 記錄 Rate Limiting 觸發事件
    - 輸出至結構化日誌（JSON 格式）

### 優先級 P2：本月內處理（第三週）

- [ ] **步驟 7：實作異常偵測機制**
  - 原因：自動識別可疑行為模式，提前預警攻擊
  - 內容：
    - 偵測短時間內多次失敗的請求
    - 偵測來自同一 IP 的異常高頻請求
    - 偵測可疑的 User-Agent 組合
    - 自動提升該 IP 的防護等級

- [ ] **步驟 8：建立監控儀表板**
  - 原因：即時監控 API 使用狀況與異常行為
  - 內容：
    - 統計每分鐘請求數
    - 顯示被阻擋的請求比例
    - 列出 Top 10 請求 IP
    - 顯示 Rate Limiting 觸發次數

- [ ] **步驟 9：整合 CAPTCHA（可選）**
  - 原因：在偵測到異常行為時，要求人機驗證
  - 內容：
    - 評估 Google reCAPTCHA v3 或 hCaptcha
    - 在達到 Rate Limit 80% 時觸發
    - 在連續失敗 3 次後觸發
    - 記錄 CAPTCHA 驗證結果

### 優先級 P3：持續優化（第四週後）

- [ ] **步驟 10：效能測試與調優**
  - 原因：確保安全機制不影響正常使用者體驗
  - 內容：
    - 壓力測試（1000 並發請求）
    - 測量 Rate Limiting 的效能影響
    - 優化驗證邏輯的執行時間
    - 確保回應時間 < 200ms

- [ ] **步驟 11：建立安全文件**
  - 原因：記錄安全機制的設計與使用方式
  - 內容：
    - 撰寫安全架構說明
    - 記錄各項防護機制的原理
    - 說明如何調整安全參數
    - 提供故障排除指南

- [ ] **步驟 12：定期安全審查**
  - 原因：持續監控安全狀況，及時發現新漏洞
  - 內容：
    - 每月執行滲透測試
    - 每季更新阻擋名單
    - 檢視日誌發現新攻擊模式
    - 更新防護策略
