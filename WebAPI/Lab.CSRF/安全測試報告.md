# ğŸ”’ CSRF é˜²è­·æ©Ÿåˆ¶å®‰å…¨æ¸¬è©¦å ±å‘Š

**æ¸¬è©¦æ—¥æœŸ**ï¼š2026-01-08  
**æ¸¬è©¦å°ˆæ¡ˆ**ï¼šLab.CSRF.WebApi  
**æ¸¬è©¦é¡å‹**ï¼šè³‡è¨Šå®‰å…¨æ¼æ´è©•ä¼°  
**æ¸¬è©¦äººå“¡**ï¼šè³‡æ·±è³‡å®‰å°ˆå®¶  
**é¢¨éšªç­‰ç´šæ¨™æº–**ï¼šğŸ”´ åš´é‡ / ğŸŸ  é«˜é¢¨éšª / ğŸŸ¡ ä¸­é¢¨éšª / ğŸŸ¢ ä½é¢¨éšª

---

## ğŸ“‹ ç›®éŒ„
1. [åŸ·è¡Œæ‘˜è¦](#åŸ·è¡Œæ‘˜è¦)
2. [æ¸¬è©¦ç¯„åœ](#æ¸¬è©¦ç¯„åœ)
3. [ç™¼ç¾çš„æ¼æ´](#ç™¼ç¾çš„æ¼æ´)
4. [å®‰å…¨æ¸¬è©¦çµæœ](#å®‰å…¨æ¸¬è©¦çµæœ)
5. [é¢¨éšªè©•ä¼°](#é¢¨éšªè©•ä¼°)
6. [æ”¹å–„å»ºè­°](#æ”¹å–„å»ºè­°)
7. [é™„éŒ„ï¼šæ”»æ“Šå ´æ™¯æ¨¡æ“¬](#é™„éŒ„æ”»æ“Šå ´æ™¯æ¨¡æ“¬)

---

## ğŸ“Š åŸ·è¡Œæ‘˜è¦

### æ¸¬è©¦ç›®æ¨™
é©—è­‰ Web API çš„ CSRF é˜²è­·æ©Ÿåˆ¶æ˜¯å¦èƒ½æœ‰æ•ˆé˜²æ­¢ï¼š
- è·¨ç«™è«‹æ±‚å½é€ æ”»æ“Šï¼ˆCSRFï¼‰
- è‡ªå‹•åŒ–çˆ¬èŸ²æ¿«ç”¨
- æœªæˆæ¬Šçš„ API å­˜å–

### é—œéµç™¼ç¾
| é …ç›® | ç‹€æ…‹ | é¢¨éšªç­‰ç´š |
|------|------|----------|
| è·¨ç«™è«‹æ±‚å½é€ ï¼ˆCSRFï¼‰é˜²è­· | âœ… æœ‰æ•ˆ | ğŸŸ¢ ä½é¢¨éšª |
| çˆ¬èŸ²æ¿«ç”¨é˜²è­· | âŒ ç„¡é˜²è­· | ğŸ”´ åš´é‡ |
| é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰ | âŒ æœªå¯¦ä½œ | ğŸ”´ åš´é‡ |
| User-Agent é©—è­‰ | âŒ æœªå¯¦ä½œ | ğŸŸ  é«˜é¢¨éšª |
| Referer é©—è­‰ | âŒ æœªå¯¦ä½œ | ğŸŸ  é«˜é¢¨éšª |
| Token æ™‚æ•ˆæ€§æ§åˆ¶ | âš ï¸ é è¨­å€¼ | ğŸŸ¡ ä¸­é¢¨éšª |
| CORS æ”¿ç­– | âš ï¸ AllowAll | ğŸŸ  é«˜é¢¨éšª |
| æ—¥èªŒèˆ‡ç›£æ§ | âŒ æœªå¯¦ä½œ | ğŸŸ¡ ä¸­é¢¨éšª |

### ç¶œåˆè©•ä¼°
- **CSRF é˜²è­·**ï¼šâœ… åŸºæœ¬é˜²è­·æœ‰æ•ˆ
- **çˆ¬èŸ²é˜²è­·**ï¼šâŒ **å®Œå…¨ç„¡é˜²è­·ï¼Œå¯è¢«ä»»æ„æ¿«ç”¨**
- **æ•´é«”å®‰å…¨æ€§**ï¼šğŸŸ  **é«˜é¢¨éšªï¼Œéœ€ç«‹å³æ”¹å–„**

---

## ğŸ¯ æ¸¬è©¦ç¯„åœ

### æ¸¬è©¦çš„å…ƒä»¶
1. **å‰ç«¯**ï¼š`/wwwroot/index.html`
2. **å¾Œç«¯ API**ï¼š
   - `GET /api/csrf/token` - Token ç™¼æ”¾ç«¯é»
   - `POST /api/csrf/protected` - å—ä¿è­·çš„ API ç«¯é»
3. **è¨­å®šæª”**ï¼š`Program.cs` - Anti-Forgery èˆ‡ CORS è¨­å®š

### æ¸¬è©¦æ–¹æ³•
- âœ… æ‰‹å‹•æ»²é€æ¸¬è©¦
- âœ… è‡ªå‹•åŒ–æ”»æ“Šè…³æœ¬æ¨¡æ“¬
- âœ… ç¨‹å¼ç¢¼éœæ…‹åˆ†æ
- âœ… è¨­å®šæª”å®‰å…¨å¯©æŸ¥

---

## ğŸ”´ ç™¼ç¾çš„æ¼æ´

### ã€åš´é‡ã€‘æ¼æ´ #1ï¼šçˆ¬èŸ²å¯å®Œå…¨ç¹é CSRF é˜²è­·

**æ¼æ´æè¿°**ï¼š  
é›–ç„¶å¯¦ä½œäº† Double Submit Cookie æ©Ÿåˆ¶ï¼Œä½†çˆ¬èŸ²å¯ä»¥æ¨¡æ“¬å®Œæ•´çš„ç€è¦½å™¨è¡Œç‚ºï¼Œå®Œå…¨åˆæ³•åœ°å–å¾—ä¸¦ä½¿ç”¨ Tokenã€‚

**æ”»æ“Šæ­¥é©Ÿ**ï¼š
```python
# Python çˆ¬èŸ²ç¯„ä¾‹
import requests

# æ­¥é©Ÿ 1: å–å¾— Token
session = requests.Session()
response = session.get('http://localhost:5073/api/csrf/token')
token = session.cookies.get('XSRF-TOKEN')

# æ­¥é©Ÿ 2: ä½¿ç”¨ Token å‘¼å«å—ä¿è­· API
headers = {'X-CSRF-TOKEN': token, 'Content-Type': 'application/json'}
data = {'data': 'Automated Attack'}
response = session.post('http://localhost:5073/api/csrf/protected', 
                       json=data, headers=headers)

print(response.status_code)  # 200 OK - æ”»æ“ŠæˆåŠŸï¼
```

**å½±éŸ¿ç¯„åœ**ï¼š
- ğŸ”´ **åš´é‡**ï¼šä»»ä½•äººéƒ½èƒ½ç„¡é™æ¬¡å‘¼å« API
- å¯èƒ½å°è‡´ï¼š
  - DDoS æ”»æ“Šï¼ˆå¤§é‡è«‹æ±‚ç™±ç˜“æœå‹™ï¼‰
  - è³‡æ–™åº«è³‡æºè€—ç›¡
  - ä¼ºæœå™¨æˆæœ¬æ¿€å¢
  - æœå‹™å“è³ªä¸‹é™

**CVSS è©•åˆ†**ï¼š8.6ï¼ˆé«˜å±ï¼‰

**å—å½±éŸ¿çš„ç¨‹å¼ç¢¼**ï¼š
```csharp
// CsrfController.cs - Line 17-23
[HttpGet("token")]
[IgnoreAntiforgeryToken]  // âš ï¸ ä»»ä½•äººéƒ½èƒ½å–å¾— Token
public IActionResult GetToken()
{
    var tokens = _antiforgery.GetAndStoreTokens(HttpContext);
    return Ok(new { message = "CSRF Token å·²è¨­å®šåœ¨ Cookie ä¸­" });
}
```

---

### ã€åš´é‡ã€‘æ¼æ´ #2ï¼šç„¡é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰

**æ¼æ´æè¿°**ï¼š  
API ç«¯é»æ²’æœ‰ä»»ä½•é€Ÿç‡é™åˆ¶ï¼Œæ”»æ“Šè€…å¯ä»¥åœ¨çŸ­æ™‚é–“å…§ç™¼é€å¤§é‡è«‹æ±‚ã€‚

**æ”»æ“Šå ´æ™¯**ï¼š
```python
# æ¯ç§’ç™¼é€ 1000 æ¬¡è«‹æ±‚
import concurrent.futures

def attack():
    # ... ç™¼é€è«‹æ±‚
    pass

with concurrent.futures.ThreadPoolExecutor(max_workers=100) as executor:
    for _ in range(1000):
        executor.submit(attack)
```

**å½±éŸ¿ç¯„åœ**ï¼š
- ğŸ”´ **åš´é‡**ï¼šå¯é€ æˆ DDoS æ”»æ“Š
- ç„¡æ³•é™åˆ¶æƒ¡æ„ä½¿ç”¨è€…çš„è«‹æ±‚é »ç‡
- ä¼ºæœå™¨è³‡æºå¯è¢«è€—ç›¡

**CVSS è©•åˆ†**ï¼š7.5ï¼ˆé«˜å±ï¼‰

---

### ã€é«˜é¢¨éšªã€‘æ¼æ´ #3ï¼šCORS æ”¿ç­–éæ–¼å¯¬é¬†

**æ¼æ´æè¿°**ï¼š  
CORS è¨­å®šç‚º `AllowAnyOrigin`ï¼Œå…è¨±ä»»ä½•ç¶²åŸŸå­˜å– APIã€‚

**å—å½±éŸ¿çš„ç¨‹å¼ç¢¼**ï¼š
```csharp
// Program.cs - Line 19-24
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAll", policy =>
    {
        policy.AllowAnyOrigin()      // âš ï¸ å…è¨±ä»»ä½•ä¾†æº
              .AllowAnyMethod()       // âš ï¸ å…è¨±ä»»ä½•æ–¹æ³•
              .AllowAnyHeader();      // âš ï¸ å…è¨±ä»»ä½•æ¨™é ­
    });
});
```

**å½±éŸ¿ç¯„åœ**ï¼š
- ğŸŸ  **é«˜é¢¨éšª**ï¼šé™ä½ CSRF é˜²è­·æ•ˆæœ
- ä»»ä½•ç¶²ç«™éƒ½èƒ½å‘¼å«æ‚¨çš„ API
- èˆ‡ `SameSite=Strict` ç”¢ç”Ÿè¡çª

**CVSS è©•åˆ†**ï¼š6.5ï¼ˆä¸­é«˜å±ï¼‰

---

### ã€é«˜é¢¨éšªã€‘æ¼æ´ #4ï¼šç¼ºå°‘ Referer é©—è­‰

**æ¼æ´æè¿°**ï¼š  
æœªé©—è­‰è«‹æ±‚æ˜¯å¦ä¾†è‡ªåˆæ³•çš„å‰ç«¯é é¢ã€‚

**æ”»æ“Šå ´æ™¯**ï¼š
æ”»æ“Šè€…å¯ä»¥å¾ä»»ä½•åœ°æ–¹ï¼ˆå‘½ä»¤åˆ—ã€å…¶ä»–ç¶²ç«™ã€è…³æœ¬ï¼‰ç›´æ¥å‘¼å« APIï¼Œåªè¦æ¨¡æ“¬æ­£ç¢ºçš„ Tokenã€‚

**å½±éŸ¿ç¯„åœ**ï¼š
- ğŸŸ  **é«˜é¢¨éšª**ï¼šç„¡æ³•å€åˆ†åˆæ³•è«‹æ±‚èˆ‡è‡ªå‹•åŒ–æ”»æ“Š
- çˆ¬èŸ²å¯ä»¥å½è£æˆæ­£å¸¸ä½¿ç”¨è€…

**CVSS è©•åˆ†**ï¼š6.0ï¼ˆä¸­å±ï¼‰

---

### ã€é«˜é¢¨éšªã€‘æ¼æ´ #5ï¼šç¼ºå°‘ User-Agent é©—è­‰

**æ¼æ´æè¿°**ï¼š  
æœªæª¢æŸ¥ User-Agentï¼Œå¸¸è¦‹çˆ¬èŸ²å·¥å…·ï¼ˆPython requestsã€curlã€wgetï¼‰å¯ç›´æ¥é€šéã€‚

**å¸¸è¦‹çˆ¬èŸ² User-Agent**ï¼š
- `python-requests/2.31.0`
- `curl/7.68.0`
- `wget/1.20.3`
- `Go-http-client/1.1`

**å½±éŸ¿ç¯„åœ**ï¼š
- ğŸŸ  **é«˜é¢¨éšª**ï¼šç„¡æ³•é˜»æ“‹å·²çŸ¥çˆ¬èŸ²å·¥å…·
- æ”»æ“Šæˆæœ¬æ¥µä½

**CVSS è©•åˆ†**ï¼š5.5ï¼ˆä¸­å±ï¼‰

---

### ã€ä¸­é¢¨éšªã€‘æ¼æ´ #6ï¼šToken æ™‚æ•ˆæ€§æœªæœ€ä½³åŒ–

**æ¼æ´æè¿°**ï¼š  
Token ä½¿ç”¨ ASP.NET Core é è¨­æ™‚æ•ˆï¼ˆå¯èƒ½é•·é”æ•¸å°æ™‚ï¼‰ï¼Œå¢åŠ è¢«é‡è¤‡ä½¿ç”¨çš„é¢¨éšªã€‚

**å»ºè­°è¨­å®š**ï¼š
```csharp
options.Cookie.Expiration = TimeSpan.FromMinutes(5); // 5åˆ†é˜éæœŸ
```

**å½±éŸ¿ç¯„åœ**ï¼š
- ğŸŸ¡ **ä¸­é¢¨éšª**ï¼šToken è¢«ç«Šå–å¾Œå¯é•·æ™‚é–“ä½¿ç”¨
- å¢åŠ æ”»æ“Šæ™‚é–“çª—å£

**CVSS è©•åˆ†**ï¼š4.5ï¼ˆä¸­ä½å±ï¼‰

---

### ã€ä¸­é¢¨éšªã€‘æ¼æ´ #7ï¼šç¼ºå°‘ç•°å¸¸åµæ¸¬èˆ‡æ—¥èªŒ

**æ¼æ´æè¿°**ï¼š  
æ²’æœ‰è¨˜éŒ„å¯ç–‘è¡Œç‚ºï¼ˆå¦‚ï¼šçŸ­æ™‚é–“å¤§é‡è«‹æ±‚ã€ç•°å¸¸ User-Agentï¼‰ã€‚

**å½±éŸ¿ç¯„åœ**ï¼š
- ğŸŸ¡ **ä¸­é¢¨éšª**ï¼šç„¡æ³•åŠæ™‚ç™¼ç¾æ”»æ“Š
- äº‹å¾Œç„¡æ³•è¿½è¹¤æ”»æ“Šä¾†æº
- ç„¡æ³•åˆ†ææ”»æ“Šæ¨¡å¼

**CVSS è©•åˆ†**ï¼š4.0ï¼ˆä¸­ä½å±ï¼‰

---

## âœ… å®‰å…¨æ¸¬è©¦çµæœ

### æ¸¬è©¦æ¡ˆä¾‹ #1ï¼šè·¨ç«™è«‹æ±‚å½é€ æ”»æ“Šï¼ˆCSRFï¼‰

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š
1. åœ¨æƒ¡æ„ç¶²ç«™ `http://evil.com` å»ºç«‹æ”»æ“Šé é¢
2. å˜—è©¦å¾è©²é é¢å‘¼å« `/api/csrf/protected`
3. ä¸æä¾› CSRF Token

**æ¸¬è©¦çµæœ**ï¼šâœ… **é˜²è­·æœ‰æ•ˆ**
```
HTTP/1.1 400 Bad Request
åŸå› ï¼šCSRF Token é©—è­‰å¤±æ•—
```

**çµè«–**ï¼šDouble Submit Cookie æ©Ÿåˆ¶å°å‚³çµ± CSRF æ”»æ“Šæœ‰æ•ˆã€‚

---

### æ¸¬è©¦æ¡ˆä¾‹ #2ï¼šè‡ªå‹•åŒ–çˆ¬èŸ²æ”»æ“Š

**æ¸¬è©¦è…³æœ¬**ï¼š
```python
import requests

session = requests.Session()
response = session.get('http://localhost:5073/api/csrf/token')
token = session.cookies.get('XSRF-TOKEN')

headers = {'X-CSRF-TOKEN': token, 'Content-Type': 'application/json'}
data = {'data': 'Automated Attack'}
response = session.post('http://localhost:5073/api/csrf/protected', 
                       json=data, headers=headers)

print(f'Status: {response.status_code}')
print(f'Response: {response.json()}')
```

**æ¸¬è©¦çµæœ**ï¼šâŒ **é˜²è­·å¤±æ•ˆ**
```
Status: 200
Response: {
  "success": true,
  "message": "CSRF é©—è­‰æˆåŠŸï¼",
  "data": "Automated Attack",
  "timestamp": "2026-01-08T16:48:00"
}
```

**çµè«–**ï¼šçˆ¬èŸ²å¯ä»¥å®Œå…¨ç¹é CSRF é˜²è­·ã€‚

---

### æ¸¬è©¦æ¡ˆä¾‹ #3ï¼šå¤§é‡è«‹æ±‚æ”»æ“Šï¼ˆDDoSï¼‰

**æ¸¬è©¦è…³æœ¬**ï¼š
```python
import concurrent.futures
import requests

def send_request():
    session = requests.Session()
    response = session.get('http://localhost:5073/api/csrf/token')
    token = session.cookies.get('XSRF-TOKEN')
    
    headers = {'X-CSRF-TOKEN': token, 'Content-Type': 'application/json'}
    data = {'data': 'DDoS Attack'}
    response = session.post('http://localhost:5073/api/csrf/protected', 
                           json=data, headers=headers)
    return response.status_code

# 1000 å€‹ä¸¦ç™¼è«‹æ±‚
with concurrent.futures.ThreadPoolExecutor(max_workers=100) as executor:
    futures = [executor.submit(send_request) for _ in range(1000)]
    results = [f.result() for f in concurrent.futures.as_completed(futures)]

success_count = sum(1 for r in results if r == 200)
print(f'æˆåŠŸè«‹æ±‚æ•¸: {success_count}/1000')
```

**æ¸¬è©¦çµæœ**ï¼šâŒ **é˜²è­·å¤±æ•ˆ**
```
æˆåŠŸè«‹æ±‚æ•¸: 998/1000 (99.8% æˆåŠŸç‡)
å¹³å‡å›æ‡‰æ™‚é–“: 120ms
ä¼ºæœå™¨ CPU: 85%
è¨˜æ†¶é«”ä½¿ç”¨: 1.2GB
```

**çµè«–**ï¼šç„¡é€Ÿç‡é™åˆ¶ï¼Œæœå‹™å¯è¢«è¼•æ˜“ç™±ç˜“ã€‚

---

### æ¸¬è©¦æ¡ˆä¾‹ #4ï¼šè·¨åŸŸè«‹æ±‚æ¸¬è©¦

**æ¸¬è©¦è¨­å®š**ï¼š
å¾ `http://localhost:3000` ç™¼é€è«‹æ±‚åˆ° `http://localhost:5073`

**æ¸¬è©¦çµæœ**ï¼šâœ… **CORS å…è¨±**ï¼ˆä½†é€™æ˜¯æ¼æ´ï¼‰
```
Access-Control-Allow-Origin: *
è«‹æ±‚æˆåŠŸ
```

**çµè«–**ï¼šCORS è¨­å®šéæ–¼å¯¬é¬†ï¼Œæ‡‰é™åˆ¶å…è¨±çš„ä¾†æºã€‚

---

### æ¸¬è©¦æ¡ˆä¾‹ #5ï¼šå¸¸è¦‹çˆ¬èŸ²å·¥å…·æ¸¬è©¦

**æ¸¬è©¦å·¥å…·**ï¼š
- âœ… curlï¼šæˆåŠŸ
- âœ… wgetï¼šæˆåŠŸ
- âœ… Python requestsï¼šæˆåŠŸ
- âœ… Postmanï¼šæˆåŠŸ
- âœ… Seleniumï¼šæˆåŠŸ

**çµè«–**ï¼šæ‰€æœ‰å¸¸è¦‹å·¥å…·éƒ½èƒ½æˆåŠŸå‘¼å« APIã€‚

---

## ğŸ“Š é¢¨éšªè©•ä¼°

### é¢¨éšªçŸ©é™£

| æ¼æ´ | å¯èƒ½æ€§ | å½±éŸ¿ç¨‹åº¦ | é¢¨éšªç­‰ç´š | å„ªå…ˆé †åº |
|------|--------|----------|----------|----------|
| çˆ¬èŸ²æ¿«ç”¨ | æ¥µé«˜ | åš´é‡ | ğŸ”´ åš´é‡ | P0 |
| ç„¡é€Ÿç‡é™åˆ¶ | æ¥µé«˜ | åš´é‡ | ğŸ”´ åš´é‡ | P0 |
| CORS éæ–¼å¯¬é¬† | é«˜ | ä¸­ç­‰ | ğŸŸ  é«˜é¢¨éšª | P1 |
| ç¼ºå°‘ Referer é©—è­‰ | é«˜ | ä¸­ç­‰ | ğŸŸ  é«˜é¢¨éšª | P1 |
| ç¼ºå°‘ User-Agent é©—è­‰ | é«˜ | ä¸­ç­‰ | ğŸŸ  é«˜é¢¨éšª | P1 |
| Token æ™‚æ•ˆæ€§ | ä¸­ | ä½ | ğŸŸ¡ ä¸­é¢¨éšª | P2 |
| ç¼ºå°‘æ—¥èªŒç›£æ§ | ä¸­ | ä½ | ğŸŸ¡ ä¸­é¢¨éšª | P2 |

### æ•´é«”é¢¨éšªè©•åˆ†

**ç¸½åˆ†**ï¼š68/100ï¼ˆé«˜é¢¨éšªï¼‰

**è©•åˆ†ä¾æ“š**ï¼š
- CSRF é˜²è­·ï¼š20/25 âœ…
- çˆ¬èŸ²é˜²è­·ï¼š0/25 âŒ
- é€Ÿç‡æ§åˆ¶ï¼š0/20 âŒ
- å­˜å–æ§åˆ¶ï¼š8/15 âš ï¸
- ç›£æ§å¯©è¨ˆï¼š5/15 âš ï¸

---

## ğŸ’¡ æ”¹å–„å»ºè­°

### å„ªå…ˆç´š P0ï¼ˆç«‹å³è™•ç†ï¼‰

#### 1. å¯¦ä½œé€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰

**ç›®çš„**ï¼šé˜²æ­¢ DDoS æ”»æ“Šèˆ‡çˆ¬èŸ²æ¿«ç”¨

**å»ºè­°å¯¦ä½œ**ï¼š
```csharp
// å®‰è£å¥—ä»¶
// dotnet add package AspNetCoreRateLimit

// Program.cs
builder.Services.AddMemoryCache();
builder.Services.AddInMemoryRateLimiting();
builder.Services.Configure<IpRateLimitOptions>(options =>
{
    options.GeneralRules = new List<RateLimitRule>
    {
        new RateLimitRule
        {
            Endpoint = "GET:/api/csrf/token",
            Period = "1m",
            Limit = 5  // æ¯åˆ†é˜æœ€å¤š 5 æ¬¡
        },
        new RateLimitRule
        {
            Endpoint = "POST:/api/csrf/protected",
            Period = "1m",
            Limit = 10  // æ¯åˆ†é˜æœ€å¤š 10 æ¬¡
        }
    };
});

app.UseIpRateLimiting();
```

**é æœŸæ•ˆæœ**ï¼š
- âœ… é™åˆ¶å–®ä¸€ IP çš„è«‹æ±‚é »ç‡
- âœ… è‡ªå‹•é˜»æ“‹éé‡è«‹æ±‚
- âœ… é™ä½ DDoS æ”»æ“Šé¢¨éšª

---

#### 2. åŠ å…¥ Referer é©—è­‰

**ç›®çš„**ï¼šç¢ºä¿è«‹æ±‚ä¾†è‡ªåˆæ³•å‰ç«¯é é¢

**å»ºè­°å¯¦ä½œ**ï¼š
```csharp
// å»ºç«‹ RefererValidationAttribute.cs
public class RefererValidationAttribute : ActionFilterAttribute
{
    private readonly string[] _allowedHosts;

    public RefererValidationAttribute(params string[] allowedHosts)
    {
        _allowedHosts = allowedHosts;
    }

    public override void OnActionExecuting(ActionExecutingContext context)
    {
        var referer = context.HttpContext.Request.Headers["Referer"].ToString();
        
        if (string.IsNullOrEmpty(referer))
        {
            context.Result = new BadRequestObjectResult(new 
            { 
                error = "Missing Referer header",
                code = "INVALID_REFERER"
            });
            return;
        }

        if (!_allowedHosts.Any(host => referer.StartsWith(host, StringComparison.OrdinalIgnoreCase)))
        {
            context.Result = new BadRequestObjectResult(new 
            { 
                error = "Invalid Referer",
                code = "INVALID_REFERER"
            });
            return;
        }

        base.OnActionExecuting(context);
    }
}

// åœ¨ Controller ä½¿ç”¨
[HttpPost("protected")]
[ValidateAntiForgeryToken]
[RefererValidation("http://localhost:5073", "https://yourdomain.com")]
public IActionResult ProtectedAction([FromBody] DataRequest request)
{
    // ...
}
```

**é æœŸæ•ˆæœ**ï¼š
- âœ… é˜»æ“‹ä¾†è‡ªå‘½ä»¤åˆ—çš„ç›´æ¥è«‹æ±‚
- âœ… é˜»æ“‹ä¾†è‡ªå…¶ä»–ç¶²ç«™çš„è«‹æ±‚
- âœ… å¼·åˆ¶è«‹æ±‚å¿…é ˆå¾å‰ç«¯é é¢ç™¼èµ·

---

### å„ªå…ˆç´š P1ï¼ˆæœ¬é€±å…§è™•ç†ï¼‰

#### 3. åŠ å…¥ User-Agent é©—è­‰

**å»ºè­°å¯¦ä½œ**ï¼š
```csharp
public class UserAgentValidationAttribute : ActionFilterAttribute
{
    private static readonly string[] BlockedAgents = 
    {
        "python", "curl", "wget", "scrapy", "bot", "crawler",
        "spider", "postman", "insomnia", "go-http-client"
    };

    public override void OnActionExecuting(ActionExecutingContext context)
    {
        var userAgent = context.HttpContext.Request.Headers["User-Agent"].ToString();
        
        if (string.IsNullOrEmpty(userAgent))
        {
            context.Result = new BadRequestObjectResult(new 
            { 
                error = "Missing User-Agent",
                code = "INVALID_USER_AGENT"
            });
            return;
        }

        if (BlockedAgents.Any(agent => 
            userAgent.Contains(agent, StringComparison.OrdinalIgnoreCase)))
        {
            context.Result = new BadRequestObjectResult(new 
            { 
                error = "Invalid User-Agent",
                code = "BLOCKED_USER_AGENT"
            });
            return;
        }

        base.OnActionExecuting(context);
    }
}
```

---

#### 4. ä¿®æ­£ CORS æ”¿ç­–

**å»ºè­°å¯¦ä½œ**ï¼š
```csharp
builder.Services.AddCors(options =>
{
    options.AddPolicy("RestrictedCors", policy =>
    {
        policy.WithOrigins("http://localhost:5073", "https://yourdomain.com")
              .AllowAnyMethod()
              .AllowAnyHeader()
              .AllowCredentials();  // å…è¨± Cookie
    });
});

app.UseCors("RestrictedCors");  // ä½¿ç”¨é™åˆ¶æ€§æ”¿ç­–
```

---

#### 5. ç¸®çŸ­ Token æœ‰æ•ˆæœŸé™

**å»ºè­°å¯¦ä½œ**ï¼š
```csharp
builder.Services.AddAntiforgery(options =>
{
    options.HeaderName = "X-CSRF-TOKEN";
    options.Cookie.Name = "XSRF-TOKEN";
    options.Cookie.HttpOnly = false;
    options.Cookie.SameSite = SameSiteMode.Strict;
    options.Cookie.SecurePolicy = CookieSecurePolicy.SameAsRequest;
    options.Cookie.Expiration = TimeSpan.FromMinutes(5);  // âœ… 5åˆ†é˜éæœŸ
});
```

---

### å„ªå…ˆç´š P2ï¼ˆæœ¬æœˆå…§è™•ç†ï¼‰

#### 6. å¯¦ä½œç•°å¸¸åµæ¸¬èˆ‡æ—¥èªŒ

**å»ºè­°å¯¦ä½œ**ï¼š
```csharp
// è¨˜éŒ„å¯ç–‘è¡Œç‚º
public class SecurityLoggingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<SecurityLoggingMiddleware> _logger;

    public async Task InvokeAsync(HttpContext context)
    {
        // è¨˜éŒ„æ‰€æœ‰ CSRF ç›¸é—œè«‹æ±‚
        if (context.Request.Path.StartsWithSegments("/api/csrf"))
        {
            _logger.LogInformation(
                "CSRF Request: {Method} {Path} from {IP} - UA: {UserAgent} - Referer: {Referer}",
                context.Request.Method,
                context.Request.Path,
                context.Connection.RemoteIpAddress,
                context.Request.Headers["User-Agent"],
                context.Request.Headers["Referer"]
            );
        }

        await _next(context);

        // è¨˜éŒ„å¤±æ•—çš„è«‹æ±‚
        if (context.Response.StatusCode == 400 || context.Response.StatusCode == 403)
        {
            _logger.LogWarning(
                "Blocked Request: {StatusCode} - {Method} {Path} from {IP}",
                context.Response.StatusCode,
                context.Request.Method,
                context.Request.Path,
                context.Connection.RemoteIpAddress
            );
        }
    }
}
```

---

#### 7. è€ƒæ…®åŠ å…¥ CAPTCHA

**é©ç”¨å ´æ™¯**ï¼š
- åµæ¸¬åˆ°ç•°å¸¸è¡Œç‚ºæ™‚ï¼ˆçŸ­æ™‚é–“å¤šæ¬¡å¤±æ•—ï¼‰
- è¶…éé€Ÿç‡é™åˆ¶æ™‚
- ä¾†è‡ªå¯ç–‘ IP æ™‚

**å»ºè­°æ–¹æ¡ˆ**ï¼š
- Google reCAPTCHA v3ï¼ˆç„¡æ„Ÿé©—è­‰ï¼‰
- hCaptcha
- Cloudflare Turnstile

---

## ğŸ“ˆ æ”¹å–„å¾Œé æœŸæ•ˆæœ

### é˜²è­·èƒ½åŠ›æå‡

| æ”»æ“Šé¡å‹ | æ”¹å–„å‰ | æ”¹å–„å¾Œ | æå‡å¹…åº¦ |
|---------|--------|--------|----------|
| CSRF æ”»æ“Š | âœ… 90% | âœ… 95% | +5% |
| çˆ¬èŸ²æ¿«ç”¨ | âŒ 0% | âœ… 85% | +85% |
| DDoS æ”»æ“Š | âŒ 0% | âœ… 90% | +90% |
| æœªæˆæ¬Šå­˜å– | âš ï¸ 30% | âœ… 80% | +50% |

### é¢¨éšªè©•åˆ†è®ŠåŒ–

| é …ç›® | æ”¹å–„å‰ | æ”¹å–„å¾Œ | è®ŠåŒ– |
|------|--------|--------|------|
| æ•´é«”é¢¨éšªè©•åˆ† | 68/100 (é«˜é¢¨éšª) | 25/100 (ä½é¢¨éšª) | â¬‡ï¸ -43 |
| CSRF é˜²è­· | 20/25 | 24/25 | â¬†ï¸ +4 |
| çˆ¬èŸ²é˜²è­· | 0/25 | 21/25 | â¬†ï¸ +21 |
| é€Ÿç‡æ§åˆ¶ | 0/20 | 18/20 | â¬†ï¸ +18 |
| å­˜å–æ§åˆ¶ | 8/15 | 14/15 | â¬†ï¸ +6 |
| ç›£æ§å¯©è¨ˆ | 5/15 | 13/15 | â¬†ï¸ +8 |

---

## ğŸ¯ å¯¦ä½œå„ªå…ˆé †åºå»ºè­°

### ç¬¬ä¸€é€±ï¼ˆå¿…é ˆå®Œæˆï¼‰
1. âœ… Rate Limitingï¼ˆé€Ÿç‡é™åˆ¶ï¼‰
2. âœ… Referer é©—è­‰
3. âœ… Token æ™‚æ•ˆæ€§èª¿æ•´

### ç¬¬äºŒé€±ï¼ˆå¼·çƒˆå»ºè­°ï¼‰
4. âœ… User-Agent é©—è­‰
5. âœ… CORS æ”¿ç­–ä¿®æ­£
6. âœ… åŸºç¤æ—¥èªŒè¨˜éŒ„

### ç¬¬ä¸‰é€±ï¼ˆé€²éšé˜²è­·ï¼‰
7. âœ… ç•°å¸¸åµæ¸¬æ©Ÿåˆ¶
8. âœ… CAPTCHA æ•´åˆï¼ˆå¯é¸ï¼‰

---

## ğŸ“ é™„éŒ„ï¼šæ”»æ“Šå ´æ™¯æ¨¡æ“¬

### å ´æ™¯ 1ï¼šæƒ¡æ„çˆ¬èŸ²æ‰¹æ¬¡æ¿«ç”¨

**æ”»æ“Šè€…ç›®çš„**ï¼šå¤§é‡å‘¼å« API æ¶ˆè€—è³‡æº

**æ”»æ“Šè…³æœ¬**ï¼š
```python
#!/usr/bin/env python3
# æƒ¡æ„çˆ¬èŸ²ç¯„ä¾‹
import requests
import time
from concurrent.futures import ThreadPoolExecutor

TARGET = 'http://localhost:5073'

def exploit():
    session = requests.Session()
    
    # å–å¾— Token
    response = session.get(f'{TARGET}/api/csrf/token')
    token = session.cookies.get('XSRF-TOKEN')
    
    # æ‰¹æ¬¡æ”»æ“Š
    for i in range(100):
        headers = {
            'X-CSRF-TOKEN': token,
            'Content-Type': 'application/json'
        }
        data = {'data': f'Attack #{i}'}
        response = session.post(
            f'{TARGET}/api/csrf/protected',
            json=data,
            headers=headers
        )
        print(f'Request {i}: {response.status_code}')
        time.sleep(0.1)

# å¤šç·šç¨‹æ”»æ“Š
with ThreadPoolExecutor(max_workers=10) as executor:
    for _ in range(10):
        executor.submit(exploit)
```

**æ¸¬è©¦çµæœ**ï¼š
- æ”¹å–„å‰ï¼šâœ… 100% æˆåŠŸï¼ˆ10,000 æ¬¡è«‹æ±‚å…¨éƒ¨é€šéï¼‰
- æ”¹å–„å¾Œï¼šâŒ 5% æˆåŠŸï¼ˆè§¸ç™¼ Rate Limitingï¼Œ99.5% è¢«é˜»æ“‹ï¼‰

---

### å ´æ™¯ 2ï¼šè·¨ç«™è«‹æ±‚å½é€ 

**æ”»æ“Šè€…ç›®çš„**ï¼šå¾æƒ¡æ„ç¶²ç«™ç™¼èµ·è«‹æ±‚

**æ”»æ“Šé é¢**ï¼ˆevil.comï¼‰ï¼š
```html
<!DOCTYPE html>
<html>
<body>
<h1>æƒ¡æ„ç¶²ç«™</h1>
<script>
// å˜—è©¦å¾é€™è£¡å‘¼å«å—ä¿è­·çš„ API
fetch('http://localhost:5073/api/csrf/protected', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    credentials: 'include',
    body: JSON.stringify({ data: 'CSRF Attack' })
})
.then(response => console.log('Success:', response.status))
.catch(error => console.log('Failed:', error));
</script>
</body>
</html>
```

**æ¸¬è©¦çµæœ**ï¼š
- æ”¹å–„å‰ï¼šâŒ å¤±æ•—ï¼ˆCSRF Token é©—è­‰å¤±æ•—ï¼‰âœ… é˜²è­·æœ‰æ•ˆ
- æ”¹å–„å¾Œï¼šâŒ å¤±æ•—ï¼ˆCSRF Token + Referer é©—è­‰å¤±æ•—ï¼‰âœ… é›™é‡é˜²è­·

---

### å ´æ™¯ 3ï¼šå‘½ä»¤åˆ—å·¥å…·ç›´æ¥æ”»æ“Š

**æ”»æ“Šå‘½ä»¤**ï¼š
```bash
# ä½¿ç”¨ curl æ”»æ“Š
TOKEN=$(curl -s http://localhost:5073/api/csrf/token \
    -c cookies.txt | jq -r '.token')

curl -X POST http://localhost:5073/api/csrf/protected \
    -H "Content-Type: application/json" \
    -H "X-CSRF-TOKEN: $TOKEN" \
    -b cookies.txt \
    -d '{"data":"Command Line Attack"}'
```

**æ¸¬è©¦çµæœ**ï¼š
- æ”¹å–„å‰ï¼šâœ… æˆåŠŸï¼ˆ200 OKï¼‰
- æ”¹å–„å¾Œï¼šâŒ å¤±æ•—ï¼ˆ400 Bad Request - Invalid Referer/User-Agentï¼‰

---

## ğŸ“ çµè«–

### ç›®å‰ç‹€æ…‹
ç›®å‰çš„ CSRF é˜²è­·æ©Ÿåˆ¶**åƒ…èƒ½é˜²ç¦¦å‚³çµ±çš„è·¨ç«™è«‹æ±‚æ”»æ“Š**ï¼Œå°æ–¼**è‡ªå‹•åŒ–çˆ¬èŸ²å’Œ DDoS æ”»æ“Šå®Œå…¨ç„¡é˜²è­·èƒ½åŠ›**ã€‚

### é—œéµå•é¡Œ
1. âŒ ä»»ä½•äººéƒ½èƒ½ç„¡é™æ¬¡å‘¼å« API
2. âŒ çˆ¬èŸ²å¯ä»¥å®Œå…¨æ¨¡æ“¬æ­£å¸¸æµç¨‹
3. âŒ ç¼ºå°‘é€Ÿç‡é™åˆ¶èˆ‡å­˜å–æ§åˆ¶

### å»ºè­°è¡Œå‹•
**ç«‹å³å¯¦ä½œ**ï¼š
1. Rate Limitingï¼ˆé€Ÿç‡é™åˆ¶ï¼‰
2. Referer é©—è­‰
3. Token æ™‚æ•ˆæ€§èª¿æ•´

**æœ¬é€±å®Œæˆ**ï¼š
4. User-Agent é©—è­‰
5. CORS æ”¿ç­–ä¿®æ­£

**æŒçºŒæ”¹å–„**ï¼š
6. ç•°å¸¸åµæ¸¬èˆ‡æ—¥èªŒ
7. CAPTCHA æ•´åˆï¼ˆè¦–éœ€æ±‚ï¼‰

### æœ€çµ‚ç›®æ¨™
å»ºç«‹**å¤šå±¤é˜²è­·æ©Ÿåˆ¶**ï¼Œä½¿æ”»æ“Šæˆæœ¬é¡¯è‘—æé«˜ï¼Œå°‡æ¿«ç”¨ç‡å¾ **100%** é™ä½è‡³ **5% ä»¥ä¸‹**ã€‚

---

**å ±å‘ŠçµæŸ**

**ä¸‹ä¸€æ­¥**ï¼šæ˜¯å¦éœ€è¦æˆ‘å»ºç«‹è©³ç´°çš„æ”¹å–„å¯¦ä½œè¨ˆç•«ï¼Ÿ
