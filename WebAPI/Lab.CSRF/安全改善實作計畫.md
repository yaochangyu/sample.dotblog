# å®‰å…¨æ”¹å–„å¯¦ä½œè¨ˆç•«

## ğŸ“‹ è¨ˆç•«æ¦‚è¿°

**ç›®æ¨™**ï¼šæ ¹æ“šå®‰å…¨æ¸¬è©¦å ±å‘Šï¼Œå¯¦ä½œå¤šå±¤é˜²è­·æ©Ÿåˆ¶ï¼Œå°‡æ•´é«”é¢¨éšªå¾ 68/100 é™ä½è‡³ 25/100

**é æœŸæˆæœ**ï¼š
- âœ… é˜²æ­¢çˆ¬èŸ²æ¿«ç”¨ï¼ˆ85% é˜²è­·ç‡ï¼‰
- âœ… é˜²æ­¢ DDoS æ”»æ“Šï¼ˆ90% é˜²è­·ç‡ï¼‰
- âœ… å¼·åŒ– CSRF é˜²è­·ï¼ˆ95% é˜²è­·ç‡ï¼‰
- âœ… å®Œå–„ç›£æ§èˆ‡æ—¥èªŒï¼ˆ90% è¦†è“‹ç‡ï¼‰

---

## ğŸ¯ å¯¦ä½œæ­¥é©Ÿ

### å„ªå…ˆç´š P0ï¼šç«‹å³è™•ç†ï¼ˆç¬¬ä¸€é€±ï¼‰

- [ ] **æ­¥é©Ÿ 1ï¼šå¯¦ä½œ Rate Limitingï¼ˆé€Ÿç‡é™åˆ¶ï¼‰**
  - åŸå› ï¼šé˜²æ­¢ DDoS æ”»æ“Šèˆ‡çˆ¬èŸ²å¤§é‡è«‹æ±‚ï¼Œé€™æ˜¯ç›®å‰æœ€åš´é‡çš„æ¼æ´
  - å…§å®¹ï¼š
    - å®‰è£ AspNetCoreRateLimit å¥—ä»¶
    - è¨­å®š IP å±¤ç´šé€Ÿç‡é™åˆ¶
    - é‡å°ä¸åŒç«¯é»è¨­å®šä¸åŒé™åˆ¶
    - Token ç«¯é»ï¼šæ¯åˆ†é˜ 5 æ¬¡
    - Protected ç«¯é»ï¼šæ¯åˆ†é˜ 10 æ¬¡

- [ ] **æ­¥é©Ÿ 2ï¼šå¯¦ä½œ Referer é©—è­‰**
  - åŸå› ï¼šç¢ºä¿è«‹æ±‚ä¾†è‡ªåˆæ³•çš„å‰ç«¯é é¢ï¼Œé˜²æ­¢å‘½ä»¤åˆ—ç›´æ¥æ”»æ“Š
  - å…§å®¹ï¼š
    - å»ºç«‹ RefererValidationAttribute
    - é©—è­‰ Referer Header å¿…é ˆå­˜åœ¨
    - æª¢æŸ¥ Referer æ˜¯å¦ä¾†è‡ªå…è¨±çš„ç¶²åŸŸæ¸…å–®
    - å¥—ç”¨è‡³æ‰€æœ‰å—ä¿è­·çš„ç«¯é»

- [ ] **æ­¥é©Ÿ 3ï¼šèª¿æ•´ Token æ™‚æ•ˆæ€§**
  - åŸå› ï¼šç¸®çŸ­ Token æœ‰æ•ˆæ™‚é–“ï¼Œæ¸›å°‘è¢«ç«Šå–å¾Œçš„é¢¨éšªçª—å£
  - å…§å®¹ï¼š
    - è¨­å®š Cookie.Expiration = 5 åˆ†é˜
    - ç¢ºä¿å‰ç«¯æ­£ç¢ºè™•ç†éæœŸ Token
    - æ–°å¢ Token éæœŸæç¤ºè¨Šæ¯

---

### å„ªå…ˆç´š P1ï¼šæœ¬é€±å…§è™•ç†ï¼ˆç¬¬äºŒé€±ï¼‰

- [ ] **æ­¥é©Ÿ 4ï¼šå¯¦ä½œ User-Agent é©—è­‰**
  - åŸå› ï¼šé˜»æ“‹å·²çŸ¥çš„çˆ¬èŸ²å·¥å…·ï¼ˆcurlã€wgetã€Python requests ç­‰ï¼‰
  - å…§å®¹ï¼š
    - å»ºç«‹ UserAgentValidationAttribute
    - å®šç¾©é˜»æ“‹åå–®ï¼ˆpythonã€curlã€wgetã€botã€crawler ç­‰ï¼‰
    - é©—è­‰ User-Agent å¿…é ˆå­˜åœ¨
    - å¥—ç”¨è‡³æ‰€æœ‰ API ç«¯é»

- [ ] **æ­¥é©Ÿ 5ï¼šä¿®æ­£ CORS æ”¿ç­–**
  - åŸå› ï¼šç›®å‰ AllowAnyOrigin éæ–¼å¯¬é¬†ï¼Œé™ä½å®‰å…¨æ€§
  - å…§å®¹ï¼š
    - ç§»é™¤ AllowAll æ”¿ç­–
    - å»ºç«‹é™åˆ¶æ€§ CORS æ”¿ç­–
    - åƒ…å…è¨±ç‰¹å®šç¶²åŸŸï¼ˆlocalhostã€production domainï¼‰
    - å•Ÿç”¨ AllowCredentials æ”¯æ´ Cookie

- [ ] **æ­¥é©Ÿ 6ï¼šå»ºç«‹åŸºç¤æ—¥èªŒç³»çµ±**
  - åŸå› ï¼šè¨˜éŒ„æ‰€æœ‰ CSRF ç›¸é—œè«‹æ±‚ï¼Œæ–¹ä¾¿äº‹å¾Œåˆ†æèˆ‡è¿½è¹¤
  - å…§å®¹ï¼š
    - è¨˜éŒ„æ‰€æœ‰è«‹æ±‚çš„ IPã€User-Agentã€Referer
    - è¨˜éŒ„è¢«é˜»æ“‹çš„è«‹æ±‚ï¼ˆ400/403ï¼‰
    - è¨˜éŒ„ Rate Limiting è§¸ç™¼äº‹ä»¶
    - è¼¸å‡ºè‡³çµæ§‹åŒ–æ—¥èªŒï¼ˆJSON æ ¼å¼ï¼‰

---

### å„ªå…ˆç´š P2ï¼šæœ¬æœˆå…§è™•ç†ï¼ˆç¬¬ä¸‰é€±ï¼‰

- [ ] **æ­¥é©Ÿ 7ï¼šå¯¦ä½œç•°å¸¸åµæ¸¬æ©Ÿåˆ¶**
  - åŸå› ï¼šè‡ªå‹•è­˜åˆ¥å¯ç–‘è¡Œç‚ºæ¨¡å¼ï¼Œæå‰é è­¦æ”»æ“Š
  - å…§å®¹ï¼š
    - åµæ¸¬çŸ­æ™‚é–“å…§å¤šæ¬¡å¤±æ•—çš„è«‹æ±‚
    - åµæ¸¬ä¾†è‡ªåŒä¸€ IP çš„ç•°å¸¸é«˜é »è«‹æ±‚
    - åµæ¸¬å¯ç–‘çš„ User-Agent çµ„åˆ
    - è‡ªå‹•æå‡è©² IP çš„é˜²è­·ç­‰ç´š

- [ ] **æ­¥é©Ÿ 8ï¼šå»ºç«‹ç›£æ§å„€è¡¨æ¿**
  - åŸå› ï¼šå³æ™‚ç›£æ§ API ä½¿ç”¨ç‹€æ³èˆ‡ç•°å¸¸è¡Œç‚º
  - å…§å®¹ï¼š
    - çµ±è¨ˆæ¯åˆ†é˜è«‹æ±‚æ•¸
    - é¡¯ç¤ºè¢«é˜»æ“‹çš„è«‹æ±‚æ¯”ä¾‹
    - åˆ—å‡º Top 10 è«‹æ±‚ IP
    - é¡¯ç¤º Rate Limiting è§¸ç™¼æ¬¡æ•¸

- [ ] **æ­¥é©Ÿ 9ï¼šæ•´åˆ CAPTCHAï¼ˆå¯é¸ï¼‰**
  - åŸå› ï¼šåœ¨åµæ¸¬åˆ°ç•°å¸¸è¡Œç‚ºæ™‚ï¼Œè¦æ±‚äººæ©Ÿé©—è­‰
  - å…§å®¹ï¼š
    - è©•ä¼° Google reCAPTCHA v3 æˆ– hCaptcha
    - åœ¨é”åˆ° Rate Limit 80% æ™‚è§¸ç™¼
    - åœ¨é€£çºŒå¤±æ•— 3 æ¬¡å¾Œè§¸ç™¼
    - è¨˜éŒ„ CAPTCHA é©—è­‰çµæœ

---

### å„ªå…ˆç´š P3ï¼šæŒçºŒå„ªåŒ–ï¼ˆç¬¬å››é€±å¾Œï¼‰

- [ ] **æ­¥é©Ÿ 10ï¼šæ•ˆèƒ½æ¸¬è©¦èˆ‡èª¿å„ª**
  - åŸå› ï¼šç¢ºä¿å®‰å…¨æ©Ÿåˆ¶ä¸å½±éŸ¿æ­£å¸¸ä½¿ç”¨è€…é«”é©—
  - å…§å®¹ï¼š
    - å£“åŠ›æ¸¬è©¦ï¼ˆ1000 ä¸¦ç™¼è«‹æ±‚ï¼‰
    - æ¸¬é‡ Rate Limiting çš„æ•ˆèƒ½å½±éŸ¿
    - å„ªåŒ–é©—è­‰é‚è¼¯çš„åŸ·è¡Œæ™‚é–“
    - ç¢ºä¿å›æ‡‰æ™‚é–“ < 200ms

- [ ] **æ­¥é©Ÿ 11ï¼šå»ºç«‹å®‰å…¨æ–‡ä»¶**
  - åŸå› ï¼šè¨˜éŒ„å®‰å…¨æ©Ÿåˆ¶çš„è¨­è¨ˆèˆ‡ä½¿ç”¨æ–¹å¼
  - å…§å®¹ï¼š
    - æ’°å¯«å®‰å…¨æ¶æ§‹èªªæ˜
    - è¨˜éŒ„å„é …é˜²è­·æ©Ÿåˆ¶çš„åŸç†
    - èªªæ˜å¦‚ä½•èª¿æ•´å®‰å…¨åƒæ•¸
    - æä¾›æ•…éšœæ’é™¤æŒ‡å—

- [ ] **æ­¥é©Ÿ 12ï¼šå®šæœŸå®‰å…¨å¯©æŸ¥**
  - åŸå› ï¼šæŒçºŒç›£æ§å®‰å…¨ç‹€æ³ï¼ŒåŠæ™‚ç™¼ç¾æ–°æ¼æ´
  - å…§å®¹ï¼š
    - æ¯æœˆåŸ·è¡Œæ»²é€æ¸¬è©¦
    - æ¯å­£æ›´æ–°é˜»æ“‹åå–®
    - æª¢è¦–æ—¥èªŒç™¼ç¾æ–°æ”»æ“Šæ¨¡å¼
    - æ›´æ–°é˜²è­·ç­–ç•¥

---

## ğŸ“ æŠ€è¡“å¯¦ä½œç´°ç¯€

### æ­¥é©Ÿ 1ï¼šRate Limiting å¯¦ä½œ

#### å®‰è£å¥—ä»¶
```bash
cd Lab.CSRF.WebApi
dotnet add package AspNetCoreRateLimit
```

#### è¨­å®šæª”æ¡ˆ
éœ€ä¿®æ”¹æª”æ¡ˆï¼š
- `Program.cs` - è¨»å†Šæœå‹™èˆ‡ä¸­ä»‹è»Ÿé«”
- æ–°å¢ `appsettings.json` è¨­å®š

#### é æœŸç¨‹å¼ç¢¼
```csharp
// Program.cs - æœå‹™è¨»å†Š
builder.Services.AddMemoryCache();
builder.Services.AddInMemoryRateLimiting();
builder.Services.Configure<IpRateLimitOptions>(options =>
{
    options.EnableEndpointRateLimiting = true;
    options.StackBlockedRequests = false;
    options.HttpStatusCode = 429;
    options.RealIpHeader = "X-Real-IP";
    options.GeneralRules = new List<RateLimitRule>
    {
        new RateLimitRule
        {
            Endpoint = "GET:/api/csrf/token",
            Period = "1m",
            Limit = 5
        },
        new RateLimitRule
        {
            Endpoint = "POST:/api/csrf/protected",
            Period = "1m",
            Limit = 10
        }
    };
});
builder.Services.AddSingleton<IIpPolicyStore, MemoryCacheIpPolicyStore>();
builder.Services.AddSingleton<IRateLimitCounterStore, MemoryCacheRateLimitCounterStore>();
builder.Services.AddSingleton<IRateLimitConfiguration, RateLimitConfiguration>();
builder.Services.AddSingleton<IProcessingStrategy, AsyncKeyLockProcessingStrategy>();

// Program.cs - ä¸­ä»‹è»Ÿé«”
app.UseIpRateLimiting();
```

---

### æ­¥é©Ÿ 2ï¼šReferer é©—è­‰å¯¦ä½œ

#### æ–°å¢æª”æ¡ˆ
éœ€å»ºç«‹ï¼š
- `Attributes/RefererValidationAttribute.cs`

#### é æœŸç¨‹å¼ç¢¼
```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;

namespace Lab.CSRF.WebApi.Attributes;

public class RefererValidationAttribute : ActionFilterAttribute
{
    private readonly string[] _allowedHosts;

    public RefererValidationAttribute(params string[] allowedHosts)
    {
        _allowedHosts = allowedHosts ?? Array.Empty<string>();
    }

    public override void OnActionExecuting(ActionExecutingContext context)
    {
        var referer = context.HttpContext.Request.Headers["Referer"].ToString();
        
        if (string.IsNullOrEmpty(referer))
        {
            context.Result = new BadRequestObjectResult(new 
            { 
                error = "Missing Referer header",
                code = "INVALID_REFERER",
                timestamp = DateTime.UtcNow
            });
            return;
        }

        if (_allowedHosts.Length > 0 && 
            !_allowedHosts.Any(host => referer.StartsWith(host, StringComparison.OrdinalIgnoreCase)))
        {
            context.Result = new BadRequestObjectResult(new 
            { 
                error = "Invalid Referer",
                code = "INVALID_REFERER",
                referer = referer,
                timestamp = DateTime.UtcNow
            });
            return;
        }

        base.OnActionExecuting(context);
    }
}
```

#### Controller ä½¿ç”¨
```csharp
[HttpPost("protected")]
[ValidateAntiForgeryToken]
[RefererValidation("http://localhost:5073", "https://yourdomain.com")]
public IActionResult ProtectedAction([FromBody] DataRequest request)
{
    // ...
}
```

---

### æ­¥é©Ÿ 3ï¼šToken æ™‚æ•ˆæ€§èª¿æ•´

#### ä¿®æ”¹æª”æ¡ˆ
éœ€ä¿®æ”¹ï¼š
- `Program.cs` - Anti-Forgery è¨­å®š

#### é æœŸç¨‹å¼ç¢¼
```csharp
builder.Services.AddAntiforgery(options =>
{
    options.HeaderName = "X-CSRF-TOKEN";
    options.Cookie.Name = "XSRF-TOKEN";
    options.Cookie.HttpOnly = false;
    options.Cookie.SameSite = SameSiteMode.Strict;
    options.Cookie.SecurePolicy = CookieSecurePolicy.SameAsRequest;
    options.Cookie.Expiration = TimeSpan.FromMinutes(5);  // âœ… æ–°å¢ï¼š5åˆ†é˜éæœŸ
});
```

#### å‰ç«¯è™•ç†
éœ€æ›´æ–° `index.html` è™•ç† Token éæœŸï¼š
```javascript
async function callProtectedApi(useToken) {
    const csrfToken = getCookie('XSRF-TOKEN');
    
    if (useToken && !csrfToken) {
        // Token å·²éæœŸï¼Œæç¤ºé‡æ–°å–å¾—
        resultDiv.innerHTML = `
            <div class="error result">
                <strong>âš ï¸ Token å·²éæœŸ</strong><br>
                è«‹é‡æ–°é»æ“Šã€Œå–å¾— Tokenã€æŒ‰éˆ•
            </div>
        `;
        return;
    }
    // ...
}
```

---

### æ­¥é©Ÿ 4ï¼šUser-Agent é©—è­‰å¯¦ä½œ

#### æ–°å¢æª”æ¡ˆ
éœ€å»ºç«‹ï¼š
- `Attributes/UserAgentValidationAttribute.cs`

#### é æœŸç¨‹å¼ç¢¼
```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;

namespace Lab.CSRF.WebApi.Attributes;

public class UserAgentValidationAttribute : ActionFilterAttribute
{
    private static readonly string[] BlockedAgents = 
    {
        "python-requests", "python", "curl", "wget", "scrapy", 
        "bot", "crawler", "spider", "postman", "insomnia",
        "go-http-client", "java", "okhttp", "httpclient"
    };

    public override void OnActionExecuting(ActionExecutingContext context)
    {
        var userAgent = context.HttpContext.Request.Headers["User-Agent"].ToString();
        
        // æª¢æŸ¥æ˜¯å¦ç¼ºå°‘ User-Agent
        if (string.IsNullOrEmpty(userAgent))
        {
            context.Result = new BadRequestObjectResult(new 
            { 
                error = "Missing User-Agent header",
                code = "INVALID_USER_AGENT",
                timestamp = DateTime.UtcNow
            });
            return;
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºå·²çŸ¥çˆ¬èŸ²
        if (BlockedAgents.Any(agent => 
            userAgent.Contains(agent, StringComparison.OrdinalIgnoreCase)))
        {
            context.Result = new BadRequestObjectResult(new 
            { 
                error = "Invalid User-Agent",
                code = "BLOCKED_USER_AGENT",
                userAgent = userAgent,
                timestamp = DateTime.UtcNow
            });
            return;
        }

        // æª¢æŸ¥æ˜¯å¦ç‚ºå¯ç–‘çš„ User-Agentï¼ˆå¤ªçŸ­æˆ–å¤ªç°¡å–®ï¼‰
        if (userAgent.Length < 10)
        {
            context.Result = new BadRequestObjectResult(new 
            { 
                error = "Suspicious User-Agent",
                code = "SUSPICIOUS_USER_AGENT",
                timestamp = DateTime.UtcNow
            });
            return;
        }

        base.OnActionExecuting(context);
    }
}
```

---

### æ­¥é©Ÿ 5ï¼šCORS æ”¿ç­–ä¿®æ­£

#### ä¿®æ”¹æª”æ¡ˆ
éœ€ä¿®æ”¹ï¼š
- `Program.cs` - CORS è¨­å®š

#### é æœŸç¨‹å¼ç¢¼
```csharp
// ç§»é™¤èˆŠçš„ AllowAll æ”¿ç­–
builder.Services.AddCors(options =>
{
    options.AddPolicy("RestrictedCors", policy =>
    {
        // åƒ…å…è¨±ç‰¹å®šä¾†æº
        policy.WithOrigins(
                "http://localhost:5073",
                "https://localhost:5073",
                "https://yourdomain.com"
              )
              .AllowAnyMethod()
              .AllowAnyHeader()
              .AllowCredentials();  // âœ… å…è¨± Cookieï¼ˆCSRF Token éœ€è¦ï¼‰
    });
});

// ä½¿ç”¨é™åˆ¶æ€§æ”¿ç­–
app.UseCors("RestrictedCors");
```

---

### æ­¥é©Ÿ 6ï¼šåŸºç¤æ—¥èªŒç³»çµ±

#### æ–°å¢æª”æ¡ˆ
éœ€å»ºç«‹ï¼š
- `Middleware/SecurityLoggingMiddleware.cs`

#### é æœŸç¨‹å¼ç¢¼
```csharp
using System.Diagnostics;

namespace Lab.CSRF.WebApi.Middleware;

public class SecurityLoggingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<SecurityLoggingMiddleware> _logger;

    public SecurityLoggingMiddleware(
        RequestDelegate next, 
        ILogger<SecurityLoggingMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        var stopwatch = Stopwatch.StartNew();
        
        // è¨˜éŒ„è«‹æ±‚é–‹å§‹
        if (context.Request.Path.StartsWithSegments("/api/csrf"))
        {
            _logger.LogInformation(
                "CSRF Request Started: {Method} {Path} from {IP} | UA: {UserAgent} | Referer: {Referer}",
                context.Request.Method,
                context.Request.Path,
                context.Connection.RemoteIpAddress,
                context.Request.Headers["User-Agent"].ToString(),
                context.Request.Headers["Referer"].ToString()
            );
        }

        await _next(context);
        
        stopwatch.Stop();

        // è¨˜éŒ„è«‹æ±‚çµæŸ
        if (context.Request.Path.StartsWithSegments("/api/csrf"))
        {
            var statusCode = context.Response.StatusCode;
            
            if (statusCode >= 400)
            {
                // è¨˜éŒ„å¤±æ•—çš„è«‹æ±‚ï¼ˆé«˜å„ªå…ˆç´šï¼‰
                _logger.LogWarning(
                    "CSRF Request Blocked: {StatusCode} {Method} {Path} from {IP} | Duration: {Duration}ms",
                    statusCode,
                    context.Request.Method,
                    context.Request.Path,
                    context.Connection.RemoteIpAddress,
                    stopwatch.ElapsedMilliseconds
                );
            }
            else
            {
                // è¨˜éŒ„æˆåŠŸçš„è«‹æ±‚
                _logger.LogInformation(
                    "CSRF Request Completed: {StatusCode} {Method} {Path} | Duration: {Duration}ms",
                    statusCode,
                    context.Request.Method,
                    context.Request.Path,
                    stopwatch.ElapsedMilliseconds
                );
            }
        }
    }
}
```

#### è¨»å†Šä¸­ä»‹è»Ÿé«”
```csharp
// Program.cs
app.UseMiddleware<SecurityLoggingMiddleware>();
```

---

### æ­¥é©Ÿ 7ï¼šç•°å¸¸åµæ¸¬æ©Ÿåˆ¶

#### æ–°å¢æª”æ¡ˆ
éœ€å»ºç«‹ï¼š
- `Services/AnomalyDetectionService.cs`

#### é æœŸç¨‹å¼ç¢¼
```csharp
using System.Collections.Concurrent;

namespace Lab.CSRF.WebApi.Services;

public class AnomalyDetectionService
{
    private readonly ILogger<AnomalyDetectionService> _logger;
    private readonly ConcurrentDictionary<string, IpActivityTracker> _ipTrackers = new();

    public AnomalyDetectionService(ILogger<AnomalyDetectionService> logger)
    {
        _logger = logger;
    }

    public bool IsAnomalous(string ipAddress, bool isSuccess)
    {
        var tracker = _ipTrackers.GetOrAdd(ipAddress, _ => new IpActivityTracker());
        tracker.RecordRequest(isSuccess);

        // åµæ¸¬è¦å‰‡
        var failureRate = tracker.GetFailureRate(TimeSpan.FromMinutes(5));
        var requestRate = tracker.GetRequestRate(TimeSpan.FromMinutes(1));

        // è¦å‰‡ 1ï¼š5åˆ†é˜å…§å¤±æ•—ç‡è¶…é 50%
        if (failureRate > 0.5 && tracker.TotalRequests > 10)
        {
            _logger.LogWarning(
                "Anomaly Detected: High failure rate for IP {IP} - {FailureRate:P0}",
                ipAddress, failureRate
            );
            return true;
        }

        // è¦å‰‡ 2ï¼š1åˆ†é˜å…§è«‹æ±‚è¶…é 30 æ¬¡
        if (requestRate > 30)
        {
            _logger.LogWarning(
                "Anomaly Detected: High request rate for IP {IP} - {RequestRate} req/min",
                ipAddress, requestRate
            );
            return true;
        }

        return false;
    }

    public void CleanupOldData()
    {
        var threshold = DateTime.UtcNow.AddHours(-1);
        var keysToRemove = _ipTrackers
            .Where(kvp => kvp.Value.LastActivity < threshold)
            .Select(kvp => kvp.Key)
            .ToList();

        foreach (var key in keysToRemove)
        {
            _ipTrackers.TryRemove(key, out _);
        }
    }
}

public class IpActivityTracker
{
    private readonly List<RequestRecord> _requests = new();
    public DateTime LastActivity { get; private set; }
    public int TotalRequests => _requests.Count;

    public void RecordRequest(bool isSuccess)
    {
        lock (_requests)
        {
            _requests.Add(new RequestRecord 
            { 
                Timestamp = DateTime.UtcNow, 
                IsSuccess = isSuccess 
            });
            LastActivity = DateTime.UtcNow;
            
            // åªä¿ç•™æœ€è¿‘ 1 å°æ™‚çš„è¨˜éŒ„
            var threshold = DateTime.UtcNow.AddHours(-1);
            _requests.RemoveAll(r => r.Timestamp < threshold);
        }
    }

    public double GetFailureRate(TimeSpan period)
    {
        lock (_requests)
        {
            var threshold = DateTime.UtcNow - period;
            var recentRequests = _requests.Where(r => r.Timestamp > threshold).ToList();
            
            if (recentRequests.Count == 0) return 0;
            
            return (double)recentRequests.Count(r => !r.IsSuccess) / recentRequests.Count;
        }
    }

    public int GetRequestRate(TimeSpan period)
    {
        lock (_requests)
        {
            var threshold = DateTime.UtcNow - period;
            return _requests.Count(r => r.Timestamp > threshold);
        }
    }
}

public class RequestRecord
{
    public DateTime Timestamp { get; set; }
    public bool IsSuccess { get; set; }
}
```

---

## ğŸ§ª æ¸¬è©¦è¨ˆç•«

### æ¯å€‹æ­¥é©Ÿå®Œæˆå¾Œçš„æ¸¬è©¦

#### æ­¥é©Ÿ 1ï¼šRate Limiting æ¸¬è©¦
```bash
# æ¸¬è©¦ï¼šé€£çºŒç™¼é€ 10 æ¬¡è«‹æ±‚ï¼ˆæ‡‰è©²æœ‰ 5 æ¬¡è¢«é˜»æ“‹ï¼‰
for i in {1..10}; do
  curl http://localhost:5073/api/csrf/token
  echo "Request $i"
done

# é æœŸçµæœï¼š
# Request 1-5: 200 OK
# Request 6-10: 429 Too Many Requests
```

#### æ­¥é©Ÿ 2ï¼šReferer é©—è­‰æ¸¬è©¦
```bash
# æ¸¬è©¦ 1ï¼šç„¡ Refererï¼ˆæ‡‰å¤±æ•—ï¼‰
curl -X POST http://localhost:5073/api/csrf/protected \
  -H "Content-Type: application/json" \
  -d '{"data":"test"}'
# é æœŸï¼š400 Bad Request - Missing Referer

# æ¸¬è©¦ 2ï¼šæœ‰æ•ˆ Refererï¼ˆæ‡‰æˆåŠŸï¼‰
curl -X POST http://localhost:5073/api/csrf/protected \
  -H "Content-Type: application/json" \
  -H "Referer: http://localhost:5073/" \
  -d '{"data":"test"}'
# é æœŸï¼šéœ€é…åˆ CSRF Token æ‰èƒ½æˆåŠŸ
```

#### æ­¥é©Ÿ 4ï¼šUser-Agent é©—è­‰æ¸¬è©¦
```bash
# æ¸¬è©¦ 1ï¼šcurl User-Agentï¼ˆæ‡‰å¤±æ•—ï¼‰
curl http://localhost:5073/api/csrf/token
# é æœŸï¼š400 Bad Request - Blocked User-Agent

# æ¸¬è©¦ 2ï¼šç€è¦½å™¨ User-Agentï¼ˆæ‡‰æˆåŠŸï¼‰
curl http://localhost:5073/api/csrf/token \
  -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
# é æœŸï¼š200 OK
```

---

## ğŸ“Š é æœŸæˆæœé©—è­‰

### æ”¹å–„å‰å¾Œå°æ¯”æ¸¬è©¦

#### æ¸¬è©¦å ´æ™¯ 1ï¼šçˆ¬èŸ²æ”»æ“Š
```python
# åŸ·è¡Œ Python çˆ¬èŸ²è…³æœ¬
# æ”¹å–„å‰ï¼š100% æˆåŠŸ
# æ”¹å–„å¾Œï¼š< 5% æˆåŠŸï¼ˆè¢« User-Agentã€Rate Limit é˜»æ“‹ï¼‰
```

#### æ¸¬è©¦å ´æ™¯ 2ï¼šDDoS æ”»æ“Š
```bash
# 1000 å€‹ä¸¦ç™¼è«‹æ±‚
# æ”¹å–„å‰ï¼š998/1000 æˆåŠŸ (99.8%)
# æ”¹å–„å¾Œï¼š< 50/1000 æˆåŠŸ (< 5%)
```

#### æ¸¬è©¦å ´æ™¯ 3ï¼šå‘½ä»¤åˆ—æ”»æ“Š
```bash
# curl ç›´æ¥æ”»æ“Š
# æ”¹å–„å‰ï¼šæˆåŠŸ
# æ”¹å–„å¾Œï¼šå¤±æ•—ï¼ˆUser-Agent + Referer é˜»æ“‹ï¼‰
```

---

## ğŸ¯ å®Œæˆæ¨™æº–

### æ­¥é©Ÿå®Œæˆæª¢æŸ¥æ¸…å–®

æ¯å€‹æ­¥é©Ÿå®Œæˆå¾Œï¼Œå¿…é ˆæ»¿è¶³ä»¥ä¸‹æ¢ä»¶ï¼š

#### âœ… ç¨‹å¼ç¢¼å®Œæˆ
- [ ] ç¨‹å¼ç¢¼å·²å¯¦ä½œä¸¦é€šéç·¨è­¯
- [ ] ç„¡è­¦å‘Šè¨Šæ¯
- [ ] ç¨‹å¼ç¢¼å·²åŠ å…¥é©ç•¶è¨»è§£

#### âœ… æ¸¬è©¦é€šé
- [ ] æ­£å¸¸æµç¨‹æ¸¬è©¦é€šé
- [ ] ç•°å¸¸æµç¨‹æ¸¬è©¦é€šéï¼ˆæ‡‰è¢«é˜»æ“‹ï¼‰
- [ ] æ•ˆèƒ½æ¸¬è©¦é€šéï¼ˆå›æ‡‰æ™‚é–“ < 200msï¼‰

#### âœ… æ–‡ä»¶æ›´æ–°
- [ ] æ›´æ–° READMEï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
- [ ] è¨˜éŒ„è¨­å®šåƒæ•¸èªªæ˜
- [ ] æ›´æ–° API æ–‡ä»¶

#### âœ… æ—¥èªŒé©—è­‰
- [ ] æ­£å¸¸è«‹æ±‚æœ‰è¨˜éŒ„
- [ ] è¢«é˜»æ“‹è«‹æ±‚æœ‰è¨˜éŒ„
- [ ] æ—¥èªŒæ ¼å¼æ­£ç¢º

---

## ğŸ“… æ™‚ç¨‹è¦åŠƒ

### ç¬¬ä¸€é€±ï¼ˆP0 å„ªå…ˆç´šï¼‰
- **Day 1-2**ï¼šæ­¥é©Ÿ 1 - Rate Limiting
- **Day 3-4**ï¼šæ­¥é©Ÿ 2 - Referer é©—è­‰
- **Day 5**ï¼šæ­¥é©Ÿ 3 - Token æ™‚æ•ˆæ€§

### ç¬¬äºŒé€±ï¼ˆP1 å„ªå…ˆç´šï¼‰
- **Day 1-2**ï¼šæ­¥é©Ÿ 4 - User-Agent é©—è­‰
- **Day 3**ï¼šæ­¥é©Ÿ 5 - CORS ä¿®æ­£
- **Day 4-5**ï¼šæ­¥é©Ÿ 6 - æ—¥èªŒç³»çµ±

### ç¬¬ä¸‰é€±ï¼ˆP2 å„ªå…ˆç´šï¼‰
- **Day 1-3**ï¼šæ­¥é©Ÿ 7 - ç•°å¸¸åµæ¸¬
- **Day 4**ï¼šæ­¥é©Ÿ 8 - ç›£æ§å„€è¡¨æ¿
- **Day 5**ï¼šæ­¥é©Ÿ 9 - CAPTCHAï¼ˆå¯é¸ï¼‰

### ç¬¬å››é€±ï¼ˆæ•´åˆèˆ‡æ¸¬è©¦ï¼‰
- **Day 1-2**ï¼šå®Œæ•´æ¸¬è©¦èˆ‡èª¿å„ª
- **Day 3-4**ï¼šæ–‡ä»¶æ’°å¯«
- **Day 5**ï¼šæœ€çµ‚é©—æ”¶

---

## ğŸ“ æ³¨æ„äº‹é …

### å¯¦ä½œé †åºçš„é‡è¦æ€§
- âš ï¸ **å¿…é ˆæŒ‰ç…§å„ªå…ˆç´šé †åºå¯¦ä½œ**
- Rate Limiting æ˜¯æœ€é—œéµçš„é˜²è­·ï¼Œæ‡‰å„ªå…ˆå®Œæˆ
- Referer é©—è­‰å¿…é ˆåœ¨ User-Agent é©—è­‰ä¹‹å‰ï¼ˆæ›´åŸºç¤ï¼‰
- æ—¥èªŒç³»çµ±æ‡‰ç›¡æ—©å¯¦ä½œï¼Œæ–¹ä¾¿å¾ŒçºŒé™¤éŒ¯

### ç›¸å®¹æ€§è€ƒé‡
- ç¢ºä¿ä¸å½±éŸ¿æ­£å¸¸ä½¿ç”¨è€…
- Rate Limit é–¾å€¼éœ€æ ¹æ“šå¯¦éš›æµé‡èª¿æ•´
- User-Agent é˜»æ“‹åå–®éœ€å®šæœŸæ›´æ–°

### æ•ˆèƒ½å½±éŸ¿
- æ¯å€‹é©—è­‰å±¤ç´šéƒ½æœƒå¢åŠ è™•ç†æ™‚é–“
- ç›®æ¨™ï¼šç¸½é«”å¢åŠ  < 50ms
- éœ€é€²è¡Œå£“åŠ›æ¸¬è©¦é©—è­‰

---

## ğŸš€ é–‹å§‹å¯¦ä½œ

**æº–å‚™å¥½é–‹å§‹å¯¦ä½œäº†å—ï¼Ÿ**

æˆ‘å°‡æŒ‰ç…§è¨ˆç•«é€æ­¥å¯¦ä½œï¼š
1. å…ˆå®Œæˆæ­¥é©Ÿ 1ï¼ˆRate Limitingï¼‰
2. æ¸¬è©¦é€šéå¾Œï¼Œç¹¼çºŒæ­¥é©Ÿ 2
3. æ¯å®Œæˆä¸€å€‹æ­¥é©Ÿï¼Œæ›´æ–°é€²åº¦è¿½è¹¤æª”æ¡ˆ
4. å…¨éƒ¨å®Œæˆå¾Œï¼ŒåŸ·è¡Œå®Œæ•´çš„å®‰å…¨æ¸¬è©¦

**æ˜¯å¦é–‹å§‹å¯¦ä½œæ­¥é©Ÿ 1ï¼šRate Limitingï¼Ÿ**
